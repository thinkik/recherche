<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche-Cockpit | Version 2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }
        
        /* Layout Styles */
        .hangar-area { background: #ffffff; height: 100vh; overflow-y: auto; border-right: 1px solid #dee2e6; padding: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .cockpit-area { padding: 20px; height: 100vh; overflow-y: auto; }
        
        /* Category Header */
        .cat-header {
            font-size: 0.75rem; font-weight: 800; color: #adb5bd; text-transform: uppercase; 
            letter-spacing: 1px; margin-top: 15px; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;
        }

        /* Tool Card Styles */
        .tool-card {
            background: white; border: 1px solid #e0e0e0; border-radius: 6px;
            padding: 8px; margin-bottom: 8px; cursor: grab;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            font-size: 0.9rem; position: relative;
        }
        .tool-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-color: #0d6efd; z-index: 10; }
        .tool-card:active { cursor: grabbing; }
        
        .tool-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px; color: #555; font-size: 0.8rem; }
        
        /* Special Status Colors */
        .is-ai { box-shadow: inset 3px 0 0 #8e44ad; } /* Lila für KI */
        .is-library { box-shadow: inset 3px 0 0 #198754; } /* Grün für Bibliothek */
        .is-ai.is-library { box-shadow: inset 3px 0 0 #8e44ad, inset 6px 0 0 #198754; }

        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; }
        .badge-ai { background: #f3e8ff; color: #6f42c1; border: 1px solid #e0c3ff; }
        .badge-lib { background: #e8fff3; color: #0f5132; border: 1px solid #b6e2c8; }

        /* Link Button on Card */
        .tool-link {
            color: #adb5bd; margin-left: auto; padding: 2px 6px; border-radius: 4px; transition: 0.2s;
        }
        .tool-link:hover { background-color: #e9ecef; color: #0d6efd; }

        /* Phase Columns (6 Columns) */
        .phase-col {
            background: #eef2f7; border-radius: 12px; min-height: 65vh;
            padding: 10px; border: 2px dashed #cbd5e0; transition: background 0.3s;
        }
        .phase-col.drag-over { background: #dbeafe; border-color: #3b82f6; }

        /* Global Drop Zone */
        .global-header {
            font-weight: 700; text-align: center; margin: 20px 0 10px;
            color: #0d6efd; font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
        }
        .global-drop {
            min-height: 160px; background: #e8f4ff; border-color: #0d6efd99;
            box-shadow: inset 0 0 0 1px #0d6efd33;
        }
        .global-drop.drag-over { background: #d0e7ff; border-color: #0d6efd; }
        
        .phase-header { 
            font-weight: 700; text-align: center; margin-bottom: 15px; 
            color: #495057; font-size: 0.85rem; min-height: 40px; 
            display: flex; align-items: center; justify-content: center;
        }
        .step-number { 
            background: #6c757d; color: white; border-radius: 50%; width: 20px; height: 20px; 
            display: inline-flex; align-items: center; justify-content: center; margin-right: 6px; font-size: 0.75rem;
        }

        /* Delete Area */
        .delete-zone {
            margin-top: 20px; border: 2px solid #dc3545; color: #dc3545;
            border-radius: 8px; padding: 15px; text-align: center; border-style: dotted; transition: 0.2s;
        }
        .delete-zone.drag-over { background: #dc3545; color: white; transform: scale(1.02); }

        /* Deleted Items */
        .deleted-wrapper {
            border: 1px dashed #ced4da;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        .deleted-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 6px 8px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 0.9rem;
        }
        .deleted-item:last-child { margin-bottom: 0; }
        .deleted-item .meta { color: #6c757d; font-size: 0.8rem; }
        .deleted-empty { color: #adb5bd; font-style: italic; font-size: 0.9rem; }

        /* Kategorie-Infos */
        .category-info-card {
            border: 1px solid #e5e7eb;
            background: #f8fafc;
            border-radius: 8px;
            padding: 8px 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .category-info-card .icon-wrap {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #e9ecef;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #0d6efd;
        }
        .category-info-card h6 {
            margin: 0;
            font-size: 0.95rem;
        }
        .category-info-card p {
            margin: 2px 0 0 0;
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.3;
        }

        /* Print Styles */
        @media print {
            .hangar-area, .no-print, .delete-zone, .modal { display: none !important; }
            .cockpit-area { width: 100% !important; height: auto !important; overflow: visible; padding: 0;}
            .phase-col { border: 1px solid #ccc; min-height: 150px; page-break-inside: avoid; }
            .row { display: flex !important; flex-wrap: nowrap !important; }
            .col, .col-md-2 { flex: 1 !important; width: calc(100% / 6) !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .tool-link { display: inline-flex !important; align-items: center; gap: 4px; color: #0d6efd !important; text-decoration: underline; }
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 hangar-area d-flex flex-column">
            <h5 class="mb-3"><i class="fas fa-warehouse"></i> Hangar</h5>
            <p class="text-muted small" style="line-height: 1.2;">Ziehen Sie die Instrumente in die 6 Phasen. <br>
            <span class="text-success fw-bold">▐</span> = Uni-Lizenz | <span style="color:#8e44ad; font-weight:bold;">▐</span> = KI-Tool<br>
            Beide Marker erscheinen, falls ein Tool beides ist.</p>

            <div class="no-print mb-3">
                <input type="text" id="toolSearchInput" class="form-control form-control-sm mb-2" placeholder="Tools durchsuchen...">
                <select id="toolCategoryFilter" class="form-select form-select-sm">
                    <option value="">Alle Kategorien</option>
                </select>
            </div>

            <div class="mb-3" aria-label="Kategorien im Überblick">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="mb-0 text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Kategorien im Überblick</h6>
                    <span class="badge bg-light text-muted border"><i class="fas fa-compass text-primary me-1"></i> Orientierung</span>
                </div>
                <div id="category-info-grid" class="d-flex flex-column gap-2"></div>
            </div>

            <div id="tool-pool">
                </div>

            <button class="btn btn-sm btn-outline-primary w-100 mt-3 no-print" data-bs-toggle="modal" data-bs-target="#customToolModal">
                <i class="fas fa-plus"></i> Eigenes Tool ergänzen
            </button>

            <button class="btn btn-sm btn-outline-success w-100 mt-2 no-print" data-bs-toggle="modal" data-bs-target="#licensedDbModal">
                <i class="fas fa-database"></i> + Lizenzierte Datenbank ergänzen
            </button>
            
            <div class="mt-auto no-print">
                <div class="delete-zone" id="delete-zone">
                    <i class="fas fa-trash"></i> Hierher ziehen zum Löschen
                </div>
                <div class="mt-3 deleted-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-bold"><i class="fas fa-trash-undo me-2"></i>Gelöschte Tools</div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="restoreAllDeleted()" title="Alle zurückholen">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                    <div id="deleted-list" class="deleted-empty">Noch nichts gelöscht</div>
                </div>
            </div>
        </div>

        <div class="col-md-9 cockpit-area">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-plane-departure"></i> Mein Recherche-Cockpit</h3>
                <div class="no-print">
                    <button class="btn btn-sm btn-warning me-2" onclick="resetCockpit()"><i class="fas fa-undo"></i> Reset</button>
                    <button class="btn btn-sm btn-success" onclick="window.print()"><i class="fas fa-file-pdf"></i> Als PDF speichern</button>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-6 g-2">
                
                <div class="col">
                    <div class="phase-header"><span class="step-number">1</span> Thema eingrenzen</div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2 no-print" onclick="openTextModal('phase-1')">
                        <i class="fas fa-note-sticky"></i> Notiz hinzufügen
                    </button>
                    <div class="phase-col" id="phase-1" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">2</span> Suchbegriffe</div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2 no-print" onclick="openTextModal('phase-2')">
                        <i class="fas fa-note-sticky"></i> Notiz hinzufügen
                    </button>
                    <div class="phase-col" id="phase-2" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">3</span> Datenbank-Suche</div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2 no-print" onclick="openTextModal('phase-3')">
                        <i class="fas fa-note-sticky"></i> Notiz hinzufügen
                    </button>
                    <div class="phase-col" id="phase-3" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">4</span> Literatur bewerten</div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2 no-print" onclick="openTextModal('phase-4')">
                        <i class="fas fa-note-sticky"></i> Notiz hinzufügen
                    </button>
                    <div class="phase-col" id="phase-4" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">5</span> Literatur lesen</div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2 no-print" onclick="openTextModal('phase-5')">
                        <i class="fas fa-note-sticky"></i> Notiz hinzufügen
                    </button>
                    <div class="phase-col" id="phase-5" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">6</span> Text schreiben</div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2 no-print" onclick="openTextModal('phase-6')">
                        <i class="fas fa-note-sticky"></i> Notiz hinzufügen
                    </button>
                    <div class="phase-col" id="phase-6" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

            </div>

            <div class="row g-2">
                <div class="col-12">
                    <div class="global-header"><i class="fas fa-layer-group me-2 text-primary"></i>Gesamter Rechercheprozess</div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2 no-print" onclick="openTextModal('phase-global')">
                        <i class="fas fa-note-sticky"></i> Notiz hinzufügen
                    </button>
                    <div class="phase-col global-drop" id="phase-global" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="aiWarningModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog border-danger">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-robot"></i> Co-Pilot Warnung (KI)</h5>
            </div>
            <div class="modal-body">
                <p class="fw-bold">Sie setzen Künstliche Intelligenz ein.</p>
                <div class="alert alert-light border">
                    <i class="fas fa-exclamation-triangle text-warning"></i> 
                    KI-Modelle können Fakten halluzinieren und Quellen erfinden.
                </div>
                <p>Verpflichten Sie sich, alle KI-Ergebnisse mit Primärquellen zu verifizieren?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="cancelAiUse">Abbrechen</button>
                <button type="button" class="btn btn-warning" id="confirmAiUse">Ja, ich verifiziere.</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="textNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-note-sticky me-2"></i>Notiz hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="noteTitle" class="form-control mb-2" placeholder="Titel (optional)">
                <textarea id="noteContent" class="form-control" rows="4" placeholder="Ihre Notiz"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addTextBlock()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customToolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eigenes Tool ergänzen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="customToolName" class="form-control mb-2" placeholder="Name (z.B. Experten-Interview)">
                <input type="text" id="customToolInfo" class="form-control mb-2" placeholder="Beschreibung für Mouseover">
                <input type="text" id="customToolUrl" class="form-control mb-2" placeholder="URL (optional)">
                <div class="mb-2">
                    <label for="customToolCategory" class="form-label">Bereich (Mehrfachauswahl möglich)</label>
                    <select id="customToolCategory" class="form-select" multiple size="6"></select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="customToolIsAi">
                    <label class="form-check-label" for="customToolIsAi">
                        KI-Tool
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="customToolIsLib">
                    <label class="form-check-label" for="customToolIsLib">
                        Uni-Lizenz
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addCustomTool()">Hinzufügen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="licensedDbModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-database me-2"></i>Lizenzierte Datenbank ergänzen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label for="licensedDbSelect" class="form-label">Datenbank auswählen</label>
                        <select id="licensedDbSelect" class="form-select" size="10"></select>
                    </div>
                    <div class="col-md-7">
                        <div class="border rounded p-3 h-100 bg-light" id="licensedDbDetails">
                            <h6 class="fw-bold mb-2" id="licensedDbTitle">Datenbank wählen</h6>
                            <p class="mb-2 small text-muted" id="licensedDbDescription">Wählen Sie links eine Datenbank aus, um Details zu sehen.</p>
                            <div class="small" id="licensedDbBadges"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addLicensedDatabase()">Zum Hangar hinzufügen</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- KONFIGURATION DER TOOLS ---
    // Kategorien basierend auf Ihrem Bild
    const categories = {
        'Assistants': {
            icon: 'fa-lightbulb',
            info: 'KI-Co-Piloten, die beim Brainstorming, Strukturieren und beim ersten Aufschlag von Textbausteinen unterstützen.'
        },
        'Finders': {
            icon: 'fa-search',
            info: 'Suchmaschinen, Datenbanken und Kataloge, mit denen Sie geeignete Quellen aufspüren und Trefferlisten filtern.'
        },
        'Connectors': {
            icon: 'fa-project-diagram',
            info: 'Tools zur Visualisierung und Vernetzung von Literatur, um Forschungsstränge und Schlüsselpublikationen sichtbar zu machen.'
        },
        'Analyzers': {
            icon: 'fa-microscope',
            info: 'Analysetools, die Texte zusammenfassen, erklären oder Inhalte aus PDFs und Artikeln herausarbeiten.'
        },
        'Writers': {
            icon: 'fa-pen-nib',
            info: 'Schreib- und Stilhilfen für saubere Formulierungen, Grammatikprüfungen und Feedback auf wissenschaftliche Texte.'
        },
        'Verwaltung': {
            icon: 'fa-folder-open',
            info: 'Literaturverwaltungsprogramme zum Sammeln, Ordnen und Zitieren Ihrer Quellen in verschiedenen Zitationsstilen.'
        },
        'Evaluation': {
            icon: 'fa-check-double', // Für Scite/Consensus "Publikationsformen"
            info: 'Werkzeuge zur Bewertung von Qualität und Wirkung, z. B. Kontext zu Zitierungen oder Hinweise auf den wissenschaftlichen Konsens.'
        },
        'Notizen': {
            icon: 'fa-note-sticky',
            info: 'Eigene Merkzettel, um Zwischenergebnisse, Recherchewege und To-dos festzuhalten.'
        }
    };

    // Tool Datenbank (angereichert mit Links und Kategorien)
    const initialTools = [
        // ASSISTANTS
        { id: 't1', name: 'ChatGPT', cats: ['Assistants'], url: 'https://chat.openai.com', isAi: true, info: 'Brainstorming & Gliederung' },
        { id: 't2', name: 'Scispace', cats: ['Assistants'], url: 'https://www.scispace.com', isAi: true, info: 'KI-Schreibassistent' },
        
        // FINDERS
        { id: 't4', name: 'Swisscover RZS UNI/PH', cats: ['Finders'], url: 'https://rzs.swisscovery.slsp.ch/discovery/search?vid=41SLSP_RZS:VU07', isAi: false, info: 'Bibliothekskatalog Schweiz', isLib: true },
        { id: 't5', name: 'Elicit', cats: ['Finders'], url: 'https://elicit.org', isAi: true, info: 'Findet Paper und extrahiert Kernaussagen' },
        { id: 't6', name: 'Google Scholar', cats: ['Finders'], url: 'https://scholar.google.com', isAi: false, info: 'Breite Suche nach wissenschaftlichen Texten' },
        { id: 't7', name: 'EconLit', cats: ['Finders'], url: 'https://www.aeaweb.org/econlit', isAi: false, info: 'Fachportal Wirtschaft', isLib: true },

        // CONNECTORS
        { id: 't8', name: 'ResearchRabbit', cats: ['Connectors'], url: 'https://researchrabbit.ai', isAi: true, info: 'Visualisiert Literatur-Netzwerke' },
        { id: 't9', name: 'Connected Papers', cats: ['Connectors'], url: 'https://www.connectedpapers.com', isAi: false, info: 'Zeigt verwandte Arbeiten grafisch an' },

        // ANALYZERS
        { id: 't10', name: 'Explainpaper', cats: ['Analyzers'], url: 'https://www.explainpaper.com', isAi: true, info: 'Erklärt komplexe Textstellen' },
        { id: 't11', name: 'Humata', cats: ['Analyzers'], url: 'https://humata.ai', isAi: true, info: 'Chatte mit deinen PDFs' },
        { id: 't12', name: 'PDF.ai', cats: ['Analyzers'], url: 'https://pdf.ai', isAi: true, info: 'PDF Analyse Tool' },

        // WRITERS
        { id: 't13', name: 'Writefull', cats: ['Writers'], url: 'https://writefull.com', isAi: true, info: 'Akademische Sprachprüfung' },
        { id: 't14', name: 'Paperpal', cats: ['Writers'], url: 'https://paperpal.com', isAi: true, info: 'Echtzeit-Schreibfeedback' },
        { id: 't15', name: 'DeepL Write', cats: ['Writers'], url: 'https://www.deepl.com/write', isAi: true, info: 'Sprachoptimierung' },

        // VERWALTUNG
        { id: 't18', name: 'Zotero', cats: ['Verwaltung'], url: 'https://www.zotero.org', isAi: false, info: 'Literaturverwaltung (Open Source)' },
        { id: 't19', name: 'Citavi', cats: ['Verwaltung'], url: 'https://www.citavi.com', isAi: false, info: 'Literaturverwaltung' },

        // EVALUATION / PUBLIKATIONSFORMEN
        { id: 't20', name: 'Scite_', cats: ['Evaluation', 'Finders'], url: 'https://scite.ai', isAi: true, info: 'Smart Citations - wie wurde zitiert?', isLib: true },
        { id: 't21', name: 'Consensus', cats: ['Evaluation', 'Finders'], url: 'https://consensus.app', isAi: true, info: 'Wissenschaftlicher Konsens finden', isLib: true }
    ];

    
    const licensedDatabases = [
        { id: 'lic1', name: 'Academic Search Ultimate (EBSCOhost)', url: 'https://dbis.ur.de/ZHBLU/resources/101844', info: 'Multidisziplinäre Volltextdatenbank mit mehr als 9 200 Zeitschriften (über 8 400 peer-reviewed), zahlreichen Magazinen und rund 60 000 Videos seit 1930', cats: ['Finders'], isLib: true },
        { id: 'lic2', name: 'Blackwell Reference Online', url: 'https://dbis.ur.de/ZHBLU/resources/7081', info: 'Sammlung von Referenzwerken aus den Geistes- und Sozialwissenschaften (z. B. Classics, History, Language & Linguistics, Philosophy & Religion, Sociology & Anthropology)', cats: ['Finders'], isLib: true },
        { id: 'lic3', name: 'Business Source Premier', url: 'https://dbis.ur.de/ZHBLU/resources/1333', info: 'Wirtschaftswissenschaftliche Datenbank mit Volltexten aus mehr als 2 200 Zeitschriften und Magazinen, Firmenprofilen, Marktstudien und SWOT-Analysen.', cats: ['Finders'], isLib: true },
        { id: 'lic4', name: 'CEPR Discussion Papers', url: 'https://dbis.ur.de/ZHBLU/resources/12587', info: 'Working-Paper-Reihe des Centre for Economic Policy Research, in der renommierte Ökonominnen und Ökonomen aktuelle Forschungsarbeiten publizieren.', cats: ['Finders'], isLib: true },
        { id: 'lic5', name: 'Duden Sprachwissen (Munzinger-Portal)', url: 'https://dbis.ur.de/ZHBLU/resources/11752', info: 'Enthält die Standardwerke der Duden-Reihe (u. a. Rechtschreibung, Fremdwörterbuch, Stilwörterbuch), die prägnant sprachliche Fragen beantworten.', cats: ['Finders'], isLib: true },
        { id: 'lic6', name: 'EconLit', url: 'https://dbis.ur.de/ZHBLU/resources/36', info: 'Datenbank der American Economic Association, die seit 1969 wirtschaftswissenschaftliche Veröffentlichungen verzeichnet und rund 750 Zeitschriften, Bücher, Sammelwerke und Dissertationen auswertet', cats:['Finders'], isLib: true },
        { id: 'lic7', name: 'Encyclopedia of Health Economics', url: 'https://dbis.ur.de/ZHBLU/resources/100301', info: 'Dreibändiges Nachschlagewerk über Gesundheitsökonomie, das ökonomische Analysen des Gesundheitssystems, der Gesundheitsversorgung und -politik bietet.', cats: ['Finders'], isLib: true },
        { id: 'lic8', name: 'Factiva', url: 'https://dbis.ur.de/ZHBLU/resources/4042', info: 'Dow-Jones-Datenbank für internationale Nachrichten und Wirtschaftsinformationen mit Presseartikeln, Nachrichtendiensten und Unternehmensmeldungen.', cats: ['Finders'], isLib:true },
        { id: 'lic9', name: 'International Bibliography of the Social Sciences (IBSS)', url: 'https://dbis.ur.de/ZHBLU/resources/1030', info: 'Bibliografische Datenbank von ProQuest, die internationale Literatur aus Soziologie, Politikwissenschaft, Wirtschaft und Anthropologie verzeichnet.', cats: ['Finders'], isLib: true },
        { id: 'lic10', name: 'International Encyclopedia of the Social & Behavioral Sciences (2. Ausgabe)', url: 'https://dbis.ur.de/ZHBLU/resources/100776', info: 'Umfassende Enzyklopädie der Sozial- und Verhaltenswissenschaften; Beiträge renommierter Forschender erklären Grundlagen, Theorien und Methoden.', cats: ['Finders'], isLib: true },
        { id: 'lic11', name: 'International Encyclopedia of the Social & Behavioral Sciences (1. Ausgabe)', url: 'https://dbis.ur.de/ZHBLU/resources/1313', info: 'Erste Ausgabe der groß angelegten Elsevier-Enzyklopädie, die die Sozial- und Verhaltenswissenschaften in zahlreichen Artikeln zusammenfasst.', cats: ['Finders'], isLib: true },
        { id: 'lic12', name: 'JSTOR Journals', url: 'https://dbis.ur.de/ZHBLU/resources/8957', info: 'Digitales Archiv, das Volltext-Backfiles wissenschaftlicher Zeitschriften aus den Geistes-, Sozial- und Naturwissenschaften bereitstellt.', cats: ['Finders'], isLib: true },
        { id: 'lic13', name: 'Kluwer Law Online', url: 'https://dbis.ur.de/ZHBLU/resources/100367', info: 'Plattform von Wolters Kluwer mit Zeitschriften und Handbüchern zu internationalem Recht sowie Kommentaren und Fallanalysen.', cats: ['Finders'], isLib: true },
        { id: 'lic14', name: 'Lexology Pro', url: 'https://dbis.ur.de/ZHBLU/resources/103456', info: 'Informationsdienst mit Fachartikeln von Anwaltskanzleien über Gesetzesänderungen und juristische Entwicklungen weltweit.', cats: ['Finders'], isLib: true },
        { id: 'lic15', name: 'LinkedIn Learning', url: 'https://dbis.ur.de/ZHBLU/resources/103054', info: 'Lernplattform mit Videokursen zu Business-, Technologie- und Kreativthemen, moderiert von Branchenexpertinnen und -experten.', cats: ['Finders'], isLib: true },
        { id: 'lic16', name: 'Munzinger Online / Länder', url: 'https://dbis.ur.de/ZHBLU/resources/2165', info: 'Deutsches Nachschlagewerk mit Länderprofilen, aktuellen Daten und Hintergrundinformationen zu Staaten, Organisationen und Persönlichkeiten.', cats: ['Finders'], isLib: true },
        { id: 'lic17', name: 'NBER Working Papers', url: 'https://dbis.ur.de/ZHBLU/resources/9453', info: 'Veröffentlichungsreihe des National Bureau of Economic Research, die aktuelle ökonomische Forschungsergebnisse vorab zugänglich macht.', cats: ['Finders'], isLib: true },
        { id: 'lic18', name: 'New Palgrave Dictionary of Economics', url: 'https://dbis.ur.de/ZHBLU/resources/8045', info: 'Enzyklopädisches Wörterbuch der Ökonomie mit Artikeln zu wirtschaftstheoretischen Konzepten, Methoden und ökonomischen Schulen.', cats: ['Finders'], isLib: true },
        { id: 'lic19', name: 'New York Times / ProQuest Historical Newspapers', url: 'https://dbis.ur.de/ZHBLU/resources/101464', info: 'Bietet digitalisierte Ausgaben der New York Times ab 1851 – nützlich für wirtschaftshistorische Recherchen.', cats: ['Finders'], isLib: true },
        { id: 'lic20', name: 'Nexis Uni', url: 'https://dbis.ur.de/ZHBLU/resources/1670', info: 'Rechercheplattform von LexisNexis mit Nachrichtenquellen, Rechtsfällen, Unternehmensdaten und juristischen Fachartikeln für die Hochschullehre.', cats: ['Finders'], isLib: true },
        { id: 'lic21', name: 'Orbis – weltweite Unternehmensdaten', url: 'https://dbis.ur.de/ZHBLU/resources/100120', info: 'Unternehmensdatenbank von Bureau van Dijk mit Finanzdaten, Beteiligungsstrukturen und Vergleichskennzahlen für Millionen Firmen weltweit.', cats: ['Finders'], isLib: true },
        { id: 'lic22', name: 'Oxford Reference', url: 'https://dbis.ur.de/ZHBLU/resources/3107', info: 'Sammlung von Wörterbüchern und Enzyklopädien der Oxford University Press zu verschiedenen Fachgebieten.', cats: ['Finders'], isLib: true },
        { id: 'lic23', name: 'Oxford Research Encyclopedia – Global Public Health', url: 'https://dbis.ur.de/ZHBLU/resources/105738', info: 'Begutachtete Forschungsenzyklopädie mit Artikeln über globale Gesundheitspolitik, Prävention, Epidemiologie und Gesundheitsversorgung.', cats: ['Finders'], isLib: true },
        { id: 'lic24', name: 'Oxford Research Encyclopedia – Climate Science', url: 'https://dbis.ur.de/ZHBLU/resources/103364', info: 'Online-Enzyklopädie mit wissenschaftlichen Übersichtsartikeln zu Klimaforschung, Klimawandel, Klimapolitik und Resilienz.', cats: ['Finders'], isLib: true },
        { id: 'lic25', name: 'Periodicals Archive Online', url: 'https://dbis.ur.de/ZHBLU/resources/7828', info: 'Archiv mit den Rückläufen von über 700 Zeitschriften der Geistes- und Sozialwissenschaften (mehr als 3 Mio. Artikel und 15 Mio. Seiten)', cats: ['Finders'], isLib: true },
        { id: 'lic26', name: 'Policy Commons', url: 'https://dbis.ur.de/ZHBLU/resources/105297', info: 'Plattform, die über 3 Mio. Publikationen von Politikexpertinnen, Think Tanks, IGOs und NGOs systematisch auffindbar macht', cats: ['Finders'], isLib: true },
        { id: 'lic27', name: 'ScienceDirect', url: 'https://dbis.ur.de/ZHBLU/resources/801', info: 'Elsevier-Plattform mit elektronischen Zeitschriften und eBooks; sie ermöglicht simultane oder getrennte Suche und Volltextzugriff je nach Lizenz', cats: ['Finders'], isLib: true },
        { id: 'lic28', name: 'Scite', url: 'https://dbis.ur.de/ZHBLU/resources/104874', info: 'KI-gestützte Zitationsdatenbank, die den Kontext von Zitierungen analysiert und Zitate als unterstützend, widersprechend oder erwähnend klassifiziert', cats: ['Evaluation', 'Finders'], isLib: true, isAi: true },
        { id: 'lic29', name: 'Statista', url: 'https://dbis.ur.de/ZHBLU/resources/9808', info: 'Statistikportal, das Daten aus zahlreichen Instituten und Quellen bündelt; der Volltextzugriff richtet sich nach dem Lizenzumfang der Einrichtung.', cats: ['Finders'], isLib: true },
        { id: 'lic30', name: 'Tax Treaties Database (IBFD)', url: 'https://dbis.ur.de/ZHBLU/resources/8580', info: 'Datenbank des International Bureau of Fiscal Documentation (IBFD) mit über 5 000 geltenden Steuerabkommen, Protokollen und Verhandlungsdokumenten sowie Vergleichstabellen.', cats: ['Finders'], isLib: true},
        { id: 'lic31', name: 'UN iLibrary', url: 'https://dbis.ur.de/ZHBLU/resources/101214', info: 'Bibliothek der Vereinten Nationen mit Büchern, Zeitschriften, Arbeitspapieren und Statistiken zu UN-Themen in verschiedenen Sprachen.', cats: ['Finders'], isLib: true },
        { id: 'lic32', name: 'WEKA Business Portal', url: 'https://dbis.ur.de/ZHBLU/resources/8661', info: 'Praxisorientiertes Informationsportal der WEKA-Verlagsgruppe mit Fachinformationen, Vorlagen und eLearning-Materialien zu Recht, Steuern und Unternehmensführung.', cats: ['Finders'], isLib: true },
        { id: 'lic33', name: 'Web of Science / Social Sciences Citation Index', url: 'https://dbis.ur.de/ZHBLU/resources/360', info: 'Aufsatzdatenbank, die mehr als 3,45 Mio. Titel nachweist und Beiträge aus über 50 Sozial- und Nachbardisziplinen auswertet', cats: ['Finders'], isLib: true },
        { id: 'lic34', name: 'Web of Science Core Collection', url: 'https://dbis.ur.de/ZHBLU/resources/2142', info: 'Multidisziplinäre Zitationsdatenbank mit Informationen aus Tausenden wissenschaftlicher Zeitschriften, Büchern und Konferenzen', cats: ['Finders'], isLib: true },
        { id: 'lic35', name: 'Wiley Online Library', url: 'https://dbis.ur.de/ZHBLU/resources/838', info: 'Plattform des Wiley-Verlags mit über 1 500 Fachzeitschriften und mehr als 20 000 eBooks aus den Natur-, Gesundheits- und Sozialwissenschaften', cats: ['Finders'], isLib: true },
        { id: 'lic36', name: 'WorldTradeLaw.net', url: 'https://dbis.ur.de/ZHBLU/resources/4825', info: 'Datenbank mit WTO- und GATT-Schiedsspruchtexten, Analysen und Kommentarmaterialien zur internationalen Handelspolitik', cats: ['Finders'], isLib: true },
        { id: 'lic37', name: 'wiso', url: 'https://dbis.ur.de/ZHBLU/resources/1232', info: 'Deutschsprachige Plattform mit Literaturhinweisen, E-Books und Fachzeitschriften zu Wirtschaft und Sozialwissenschaften; ergänzt um Module zur Betriebswirtschaftspraxis, Lecturio-Erklärvideos und das Statistikportal Tilasto', cats: ['Finders'], isLib: true },
        { id: 'lic38', name: 'Statistical Portal OECD Data Explorer', url: 'https://dbis.ur.de/ZHBLU/resources/106121', info: 'Interaktive Plattform der OECD, mit der sich sozioökonomische Kennzahlen verschiedener Länder vergleichen und visualisieren lassen.', cats: ['Finders'], isLib: true }
    ];


    let currentDragElement = null;
    let pendingAiElement = null;
    let aiModal = null;
    let textModal = null;
    let targetPhaseForNote = null;
    let deletedTools = [];
    let currentSearchTerm = '';
    let currentCategoryFilter = '';

    const dropTargets = ['phase-1', 'phase-2', 'phase-3', 'phase-4', 'phase-5', 'phase-6', 'phase-global'];

    function escapeHtml(str) {
        if(!str) return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Papierkorb
    function sanitizeToolData(toolData) {
        return {
            id: toolData.id || toolData.uniqueId || ('restored-' + Date.now()),
            name: toolData.name || 'Unbenanntes Tool',
            cats: Array.isArray(toolData.cats) && toolData.cats.length ? toolData.cats : ['Verwaltung'],
            url: toolData.url || '#',
            info: toolData.info || 'Gelöscht',
            isAi: !!toolData.isAi,
            isLib: !!toolData.isLib,
            isCustom: !!toolData.isCustom,
            type: toolData.type || 'tool',
            text: toolData.text || ''
        };
    }

    function renderDeletedList() {
        const container = document.getElementById('deleted-list');
        if(!container) return;

        if(!deletedTools.length) {
            container.className = 'deleted-empty';
            container.textContent = 'Noch nichts gelöscht';
            return;
        }

        container.className = '';
        container.innerHTML = '';

        deletedTools.forEach((tool, index) => {
            const item = document.createElement('div');
            item.className = 'deleted-item';

            const infoWrapper = document.createElement('div');
            const titleEl = document.createElement('div');
            titleEl.className = 'fw-bold';
            titleEl.textContent = tool.name;

            const metaEl = document.createElement('div');
            metaEl.className = 'meta';
            metaEl.textContent = tool.type === 'text'
                ? (tool.text ? tool.text.slice(0, 80) : 'Notiz')
                : (tool.cats || []).join(', ');

            infoWrapper.appendChild(titleEl);
            infoWrapper.appendChild(metaEl);
            item.appendChild(infoWrapper);

            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'btn btn-sm btn-outline-success';
            restoreBtn.innerHTML = '<i class="fas fa-undo"></i>';
            restoreBtn.title = 'Tool zurück in den Hangar';
            restoreBtn.addEventListener('click', () => restoreDeletedTool(index));

            item.appendChild(restoreBtn);
            container.appendChild(item);
        });
    }

    function saveDeletedState() {
        localStorage.setItem('cockpitDeleted_v1', JSON.stringify(deletedTools));
    }

    function loadDeletedState() {
        const stored = localStorage.getItem('cockpitDeleted_v1');
        if(stored) {
            deletedTools = JSON.parse(stored);
        }
        renderDeletedList();
    }

    function normalizeName(name) {
        return (name || '').toLowerCase().replace(/[_\s]+$/, '').trim();
    }

    function populateLicensedDbSelect() {
        const select = document.getElementById('licensedDbSelect');
        if(!select) return;

        select.innerHTML = '';
        licensedDatabases.forEach(db => {
            const opt = document.createElement('option');
            opt.value = db.id;
            opt.textContent = db.name;
            select.appendChild(opt);
        });

        select.addEventListener('change', (e) => updateLicensedDbDetails(e.target.value));
        if(licensedDatabases.length) {
            select.value = licensedDatabases[0].id;
            updateLicensedDbDetails(licensedDatabases[0].id);
        }
    }

    function updateLicensedDbDetails(dbId) {
        const db = licensedDatabases.find(item => item.id === dbId);
        const titleEl = document.getElementById('licensedDbTitle');
        const descEl = document.getElementById('licensedDbDescription');
        const badgeEl = document.getElementById('licensedDbBadges');

        if(!db || !titleEl || !descEl || !badgeEl) return;

        titleEl.textContent = db.name;
        descEl.textContent = db.info || '';

        const badges = [];
        if(db.isLib) badges.push('<span class="status-badge badge-lib">Uni</span>');
        if(db.isAi) badges.push('<span class="status-badge badge-ai">KI</span>');
        badgeEl.innerHTML = badges.join(' ');
    }

    function addLicensedDatabase() {
        const select = document.getElementById('licensedDbSelect');
        if(!select || !select.value) return;

        const db = licensedDatabases.find(item => item.id === select.value);
        if(!db) return;

        const alreadyExists = initialTools.some(tool => normalizeName(tool.name) === normalizeName(db.name));
        if(alreadyExists) {
            alert('Diese Datenbank befindet sich bereits im Hangar.');
            return;
        }

        initialTools.push({ ...db, isLib: true, cats: db.cats && db.cats.length ? db.cats : ['Finders'] });
        renderHangar();

        const modalEl = document.getElementById('licensedDbModal');
        if(modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
        }
    }

    function addToDeleted(toolData) {
        const sanitized = sanitizeToolData(toolData);
        deletedTools = [sanitized, ...deletedTools.filter(t => !(t.id === sanitized.id && t.name === sanitized.name))].slice(0, 25);
        saveDeletedState();
        renderDeletedList();
    }

    function restoreDeletedTool(index) {
        const tool = deletedTools.splice(index, 1)[0];
        if(!tool) return;

        if(tool.type === 'text' && (!tool.cats || !tool.cats.length)) {
            tool.cats = ['Notizen'];
        }

        if(!initialTools.find(t => t.id === tool.id)) {
            initialTools.push(tool);
        }

        renderHangar();
        saveDeletedState();
        renderDeletedList();
    }

    function restoreAllDeleted() {
        if(!deletedTools.length) return;

        deletedTools.forEach(tool => {
            if(tool.type === 'text' && (!tool.cats || !tool.cats.length)) {
                tool.cats = ['Notizen'];
            }
            if(!initialTools.find(t => t.id === tool.id)) {
                initialTools.push(tool);
            }
        });

        deletedTools = [];
        renderHangar();
        saveDeletedState();
        renderDeletedList();
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderHangar();
        renderCategoryInfo();
        populateCategoryOptions();
        populateFilterOptions();
        populateLicensedDbSelect();
        loadState();
        loadDeletedState();
        initTooltips();

        const searchInput = document.getElementById('toolSearchInput');
        if(searchInput) {
            searchInput.addEventListener('input', (e) => {
                currentSearchTerm = (e.target.value || '').trim().toLowerCase();
                if(!currentSearchTerm) {
                    currentCategoryFilter = '';
                    const categorySelect = document.getElementById('toolCategoryFilter');
                    if(categorySelect) {
                        categorySelect.value = '';
                    }
                }
                renderHangar();
            });
        }

        const categoryFilter = document.getElementById('toolCategoryFilter');
        if(categoryFilter) {
            categoryFilter.addEventListener('change', (e) => {
                currentCategoryFilter = e.target.value;
                renderHangar();
            });
        }
        
        // --- DELETE ZONE LOGIC FIX ---
        const deleteZone = document.getElementById('delete-zone');
        deleteZone.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            deleteZone.classList.add('drag-over'); 
        });
        deleteZone.addEventListener('dragleave', () => { 
            deleteZone.classList.remove('drag-over'); 
        });
        
        deleteZone.addEventListener('drop', (e) => {
            e.preventDefault();
            deleteZone.classList.remove('drag-over');
            
            const rawData = e.dataTransfer.getData("text/plain");
            if(!rawData) return;
            
            const data = JSON.parse(rawData);

            // Löschen für Cockpit- und Hangar-Elemente
            if(data.origin === 'cockpit') {
                const elementToDelete = document.getElementById(data.uniqueId);
                if(elementToDelete) {
                    elementToDelete.remove();
                    addToDeleted(data);
                    saveState();
                }
            } else if (data.origin === 'hangar') {
                const hangarElement = document.getElementById(data.uniqueId);
                if(hangarElement) {
                    hangarElement.remove();
                }

                // Benutzerdefinierte Tools komplett entfernen (alle Kategorien)
                if(data.isCustom) {
                    const index = initialTools.findIndex(t => t.id === data.id);
                    if(index >= 0) initialTools.splice(index, 1);

                    document.querySelectorAll(`[data-base-id="${data.id}"]`).forEach(el => el.remove());
                }

                addToDeleted(data);
            }
        });

        // AI Confirmation Logic
        const aiModalEl = document.getElementById('aiWarningModal');
        aiModal = new bootstrap.Modal(aiModalEl);

        const textModalEl = document.getElementById('textNoteModal');
        if(textModalEl) {
            textModal = new bootstrap.Modal(textModalEl);
            textModalEl.addEventListener('hidden.bs.modal', () => {
                targetPhaseForNote = null;
                const titleField = document.getElementById('noteTitle');
                const contentField = document.getElementById('noteContent');
                if(titleField) titleField.value = '';
                if(contentField) contentField.value = '';
            });
        }

        document.getElementById('confirmAiUse').addEventListener('click', () => {
            if(pendingAiElement) {
                aiModal.hide();
                pendingAiElement = null;
                saveState();
            }
        });
        
        document.getElementById('cancelAiUse').addEventListener('click', () => {
             aiModal.hide();
        });

        aiModalEl.addEventListener('hidden.bs.modal', () => {
            if(pendingAiElement) {
                // Wenn Modal geschlossen wird (ohne Bestätigung), Element entfernen
                pendingAiElement.remove();
                pendingAiElement = null;
            }
        });
    });

    // --- RENDER FUNKTIONEN ---
    function renderHangar() {
        const pool = document.getElementById('tool-pool');
        pool.innerHTML = '';

        const searchTerm = currentSearchTerm;
        const selectedCategory = currentCategoryFilter;

        // Gruppen bilden
        Object.keys(categories).forEach(catKey => {
            const catTools = initialTools.filter(t => {
                const hasCategory = Array.isArray(t.cats) && t.cats.includes(catKey);
                if(!hasCategory) return false;

                const matchesCategoryFilter = !selectedCategory || (Array.isArray(t.cats) && t.cats.includes(selectedCategory));
                if(!matchesCategoryFilter) return false;

                if(!searchTerm) return true;

                const haystack = `${t.name || ''} ${t.info || ''} ${(t.cats || []).join(' ')}`.toLowerCase();
                return haystack.includes(searchTerm);
            });
            if(catTools.length > 0) {
                // Header einfügen
                const header = document.createElement('div');
                header.className = 'cat-header';
                const catIcon = (categories[catKey] && categories[catKey].icon) ? categories[catKey].icon : 'fa-tools';
                header.innerHTML = `<i class="fas ${catIcon} me-2"></i> ${catKey}`;
                pool.appendChild(header);

                // Tools einfügen
                catTools.forEach(tool => {
                    const instanceId = `${tool.id}-${catKey}`;
                    pool.appendChild(createToolElement({ ...tool, uniqueId: instanceId }, 'hangar'));
                });
            }
        });
    }

    function renderCategoryInfo() {
        const grid = document.getElementById('category-info-grid');
        if(!grid) return;

        grid.innerHTML = '';

        Object.entries(categories).forEach(([catKey, meta]) => {
            const iconClass = (meta && meta.icon) ? meta.icon : 'fa-tools';
            const description = escapeHtml((meta && meta.info) ? meta.info : '');

            const card = document.createElement('div');
            card.className = 'category-info-card';
            card.innerHTML = `
                <div class="icon-wrap"><i class="fas ${iconClass}"></i></div>
                <div>
                    <h6 class="fw-bold">${catKey}</h6>
                    <p class="mb-0">${description}</p>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function populateCategoryOptions() {
        const select = document.getElementById('customToolCategory');
        if(!select) return;

        select.innerHTML = '';

        Object.keys(categories).forEach(catKey => {
            const option = document.createElement('option');
            option.value = catKey;
            option.textContent = catKey;
            select.appendChild(option);
        });
    }

    function populateFilterOptions() {
        const select = document.getElementById('toolCategoryFilter');
        if(!select) return;

        const currentValue = select.value;

        // clear existing (except first default?) better rebuild
        select.innerHTML = '<option value="">Alle Kategorien</option>';

        Object.keys(categories).forEach(catKey => {
            const option = document.createElement('option');
            option.value = catKey;
            option.textContent = catKey;
            select.appendChild(option);
        });

        select.value = currentValue;
    }

    function createToolElement(toolData, origin) {
        const div = document.createElement('div');
        // Klassen für Farben setzen
        let classes = 'tool-card';
        if(toolData.isAi) classes += ' is-ai';
        if(toolData.isLib) classes += ' is-library';

        div.className = classes;
        div.draggable = true;

        const isText = toolData.type === 'text';

        // ID Generierung
        const uniqueId = toolData.uniqueId
            || (origin === 'hangar'
                ? toolData.id
                : 'c-' + Date.now() + Math.random().toString(16).slice(2));
        div.id = uniqueId;
        div.dataset.baseId = toolData.id;
        div.dataset.type = toolData.type || 'tool';
        div.dataset.name = toolData.name || '';
        div.dataset.info = toolData.info || '';
        div.dataset.url = toolData.url || '';
        div.dataset.cats = Array.isArray(toolData.cats) ? toolData.cats.join('|') : '';
        div.dataset.isAi = toolData.isAi ? '1' : '0';
        div.dataset.isLib = toolData.isLib ? '1' : '0';
        div.dataset.isCustom = toolData.isCustom ? '1' : '0';
        if(toolData.text) {
            div.dataset.text = toolData.text;
        }

        // Icon bestimmen (wenn keine Kategorie-Icon, dann Standard)
        const primaryCat = Array.isArray(toolData.cats) && toolData.cats.length ? toolData.cats[0] : null;
        const iconClass = (primaryCat && categories[primaryCat] && categories[primaryCat].icon) ? categories[primaryCat].icon : 'fa-tools';

        if(isText) {
            const displayText = escapeHtml(toolData.text || toolData.info || '').replace(/\n/g, '<br>');
            const displayTitle = escapeHtml(toolData.name || 'Notiz');
            div.innerHTML = `
                <div class="tool-icon"><i class="fas fa-note-sticky"></i></div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                        <div class="fw-bold text-truncate">${displayTitle}</div>
                    </div>
                    <div class="small text-muted text-wrap">${displayText || 'Kein Text hinterlegt'}</div>
                </div>
                <span class="status-badge badge bg-light text-muted border">Notiz</span>
            `;
        } else {
            const statusBadges = `
                ${toolData.isAi ? '<span class="status-badge badge-ai">KI</span>' : ''}
                ${toolData.isLib ? '<span class="status-badge badge-lib">Uni</span>' : ''}
            `;

            const categoryList = Array.isArray(toolData.cats) && toolData.cats.length
                ? escapeHtml(toolData.cats.join(', '))
                : 'Allgemein';

            const safeName = escapeHtml(toolData.name || 'Unbenanntes Tool');
            const safeInfo = escapeHtml(toolData.info || '');
            const safeUrl = escapeHtml(toolData.url || '#');

            div.innerHTML = `
                <div class="tool-icon"><i class="fas ${iconClass}"></i></div>
                <div class="flex-grow-1 text-truncate">
                    <div class="d-flex align-items-center gap-2">
                        <div class="fw-bold text-truncate">${safeName}</div>
                        <div class="d-flex gap-1 flex-shrink-0">${statusBadges}</div>
                    </div>
                    <div class="small text-muted text-truncate">${categoryList}</div>
                </div>
                <i class="fas fa-info-circle text-muted" style="cursor:help;" data-bs-toggle="tooltip" title="${safeInfo}"></i>
                <a href="${safeUrl}" target="_blank" class="tool-link" onclick="event.stopPropagation()" title="Tool öffnen">
                    <i class="fas fa-external-link-alt"></i>
                    <span class="d-none d-print-inline small text-decoration-underline text-primary">${safeUrl}</span>
                </a>
            `;
        }

        // Re-Init Tooltips
        setTimeout(() => initTooltips(), 100);

        // Drag Events
        div.addEventListener('dragstart', (e) => {
            const transferData = {
                ...toolData,
                uniqueId: uniqueId,
                origin: origin
            };
            e.dataTransfer.setData("text/plain", JSON.stringify(transferData));
            e.dataTransfer.effectAllowed = origin === 'hangar' ? 'copy' : 'move';
        });

        return div;
    }

    // --- DRAG & DROP LOGIC ---
    function allowDrop(e) { e.preventDefault(); }
    
    function dragEnter(e) {
        let target = e.target.closest('.phase-col');
        if(target) target.classList.add('drag-over');
    }
    
    function dragLeave(e) {
        let target = e.target.closest('.phase-col');
        if(target) target.classList.remove('drag-over');
    }

    function drop(e) {
        e.preventDefault();
        let target = e.target.closest('.phase-col');
        if(!target) return;
        
        target.classList.remove('drag-over');

        const rawData = e.dataTransfer.getData("text/plain");
        if(!rawData) return;

        const data = JSON.parse(rawData);

        if (data.origin === 'hangar') {
            // COPY: Neues Element erstellen
            const newTool = createToolElement({
                ...data,
                // Immer eine frische ID vergeben, damit Delete/Move zuverlässig funktionieren
                uniqueId: 'c-' + Date.now() + Math.random().toString(16).slice(2)
            }, 'cockpit');
            target.appendChild(newTool);
            
            // Check AI Warning
            if(data.isAi) {
                pendingAiElement = newTool;
                aiModal.show();
            } else {
                saveState();
            }
        } else {
            // MOVE: Vorhandenes Element verschieben
            const existingEl = document.getElementById(data.uniqueId);
            if(existingEl) {
                target.appendChild(existingEl);
                saveState();
            }
        }
    }

    function openTextModal(targetId) {
        targetPhaseForNote = targetId;
        if(!textModal) {
            const modalEl = document.getElementById('textNoteModal');
            if(modalEl) {
                textModal = new bootstrap.Modal(modalEl);
            }
        }
        if(textModal) {
            textModal.show();
        }
    }

    function addTextBlock() {
        if(!targetPhaseForNote) return;

        const target = document.getElementById(targetPhaseForNote);
        if(!target) return;

        const titleField = document.getElementById('noteTitle');
        const contentField = document.getElementById('noteContent');
        const title = titleField ? titleField.value.trim() : '';
        const content = contentField ? contentField.value.trim() : '';

        if(!content && !title) return;

        const noteId = 'note-' + Date.now() + Math.random().toString(16).slice(2);
        const noteData = {
            id: noteId,
            name: title || 'Notiz',
            info: content || 'Notiz',
            url: '#',
            cats: ['Notizen'],
            isAi: false,
            isLib: false,
            type: 'text',
            text: content,
            uniqueId: noteId
        };

        const card = createToolElement(noteData, 'cockpit');
        target.appendChild(card);
        saveState();

        if(textModal) {
            textModal.hide();
        }
    }

    // --- CUSTOM TOOL ---
    function addCustomTool() {
        const name = document.getElementById('customToolName').value;
        const info = document.getElementById('customToolInfo').value;
        const url = document.getElementById('customToolUrl').value;
        const catSelect = document.getElementById('customToolCategory');
        const cat = Array.from(catSelect.selectedOptions).map(opt => opt.value);
        const isAi = document.getElementById('customToolIsAi').checked;
        const isLib = document.getElementById('customToolIsLib').checked;

        if(!name) return;

        const newTool = {
            id: 'cust' + Date.now(),
            name: name,
            cats: cat && cat.length ? cat : ['Verwaltung'],
            url: url || '#',
            info: info || 'Benutzerdefiniert',
            isAi: isAi,
            isLib: isLib,
            isCustom: true
        };
        
        initialTools.push(newTool);
        renderHangar();
        
        bootstrap.Modal.getInstance(document.getElementById('customToolModal')).hide();
        // Clear fields
        document.getElementById('customToolName').value = '';
        document.getElementById('customToolInfo').value = '';
        document.getElementById('customToolUrl').value = '';
        document.getElementById('customToolCategory').selectedIndex = -1;
        document.getElementById('customToolIsAi').checked = false;
        document.getElementById('customToolIsLib').checked = false;
    }

    // --- STORAGE ---
    function saveState() {
        const state = {};
        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(!phase) return;
            const tools = [];
            phase.querySelectorAll('.tool-card').forEach(card => {
                const cats = card.dataset.cats ? card.dataset.cats.split('|').filter(Boolean) : [];
                tools.push({
                    id: card.dataset.baseId || card.id,
                    uniqueId: card.id,
                    name: card.dataset.name || (card.querySelector('.fw-bold') ? card.querySelector('.fw-bold').innerText : 'Tool'),
                    info: card.dataset.info || '',
                    url: card.dataset.url || '#',
                    cats: cats,
                    isAi: card.dataset.isAi === '1' || card.dataset.isAi === 'true',
                    isLib: card.dataset.isLib === '1' || card.dataset.isLib === 'true',
                    isCustom: card.dataset.isCustom === '1' || card.dataset.isCustom === 'true',
                    type: card.dataset.type || 'tool',
                    text: card.dataset.text || ''
                });
            });
            state[targetId] = tools;
        });
        localStorage.setItem('cockpitState_v3', JSON.stringify(state));
    }

    function loadState() {
        const rawState = localStorage.getItem('cockpitState_v3') || localStorage.getItem('cockpitState_v2');
        if(!rawState) return;
        const state = JSON.parse(rawState);

        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(!phase) return;

            phase.innerHTML = '';
            const tools = state[targetId] || [];

            tools.forEach(savedItem => {
                const itemType = savedItem.type || 'tool';
                if(itemType === 'text') {
                    const restoredNote = {
                        id: savedItem.id || savedItem.uniqueId || 'restored-note',
                        name: savedItem.name || 'Notiz',
                        info: savedItem.info || savedItem.text || 'Notiz',
                        url: '#',
                        cats: (savedItem.cats && savedItem.cats.length) ? savedItem.cats : ['Notizen'],
                        type: 'text',
                        text: savedItem.text || '',
                        uniqueId: savedItem.uniqueId || ('note-' + Date.now() + Math.random().toString(16).slice(2))
                    };
                    phase.appendChild(createToolElement(restoredNote, 'cockpit'));
                    return;
                }

                let original = initialTools.find(it => it.id === savedItem.id) || initialTools.find(it => it.name === savedItem.name);

                if(!original) {
                    original = {
                        id: savedItem.id || 'restored',
                        name: savedItem.name || 'Unbenannt',
                        cats: (savedItem.cats && savedItem.cats.length) ? savedItem.cats : ['Verwaltung'],
                        url: savedItem.url || '#',
                        info: savedItem.info || 'Wiederhergestellt',
                        isAi: !!savedItem.isAi,
                        isLib: !!savedItem.isLib
                    };
                }

                const restoredTool = {
                    ...original,
                    uniqueId: savedItem.uniqueId,
                    isCustom: savedItem.isCustom,
                    isAi: savedItem.isAi,
                    isLib: savedItem.isLib
                };
                phase.appendChild(createToolElement(restoredTool, 'cockpit'));
            });
        });
    }

    function resetCockpit() {
        if(confirm('Wirklich alles löschen?')) {
            localStorage.removeItem('cockpitState_v2');
            localStorage.removeItem('cockpitState_v3');
            localStorage.removeItem('cockpitDeleted_v1');
            location.reload();
        }
    }

    function initTooltips() {
        // Zerstöre alte Tooltips um Ghosts zu vermeiden
        const oldTooltips = document.querySelectorAll('.tooltip');
        oldTooltips.forEach(t => t.remove());

        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    }
</script>

</body>
</html>
