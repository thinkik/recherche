<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche-Cockpit | Version 2.0</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/introjs.min.css">
    <script src="js/intro.min.js"></script>
    
    <style>
        /* === Layout === */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }
        .hangar-area { background: #ffffff; height: 100vh; overflow-y: auto; border-right: 1px solid #dee2e6; padding: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1020; }
        .cockpit-area { padding: 20px; height: 100vh; overflow-y: auto; }
        .cat-header { font-size: 0.75rem; font-weight: 800; color: #5c6770; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px; margin-bottom: 8px; border-bottom: 1px solid #e2e6ea; padding-bottom: 4px; }
        .phase-col { background: #eef2f7; border-radius: 12px; min-height: 65vh; padding: 10px; border: 2px dashed #cbd5e0; transition: background 0.3s; }
        .phase-col.drag-over { background: #dbeafe; border-color: #3b82f6; }
        .global-header { font-weight: 700; text-align: center; margin: 20px 0 10px; color: #0d6efd; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; }
        .global-drop { min-height: 160px; background: #e8f4ff; border-color: #0d6efd99; box-shadow: inset 0 0 0 1px #0d6efd33; }
        .global-drop.drag-over { background: #d0e7ff; border-color: #0d6efd; }
        .phase-header { font-weight: 700; text-align: center; margin-bottom: 15px; color: #495057; font-size: 0.85rem; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .deleted-wrapper { border: 1px dashed #ced4da; border-radius: 8px; padding: 10px; background: #f8f9fa; }
        .deleted-item { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 6px 8px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 0.9rem; }
        .deleted-item:last-child { margin-bottom: 0; }
        .deleted-item .meta { color: #6c757d; font-size: 0.8rem; }
        .deleted-empty { color: #adb5bd; font-style: italic; font-size: 0.9rem; }
        .ki-callout { border: 1px solid #ffeeba; background: #fff8e1; border-radius: 8px; padding: 12px; }
        .ki-callout .icon-wrap { width: 38px; height: 38px; border-radius: 8px; background: #fff3cd; display: inline-flex; align-items: center; justify-content: center; color: #e67e22; box-shadow: inset 0 0 0 1px #ffe8a1; }
        .ki-checklist .list-group-item { border: none; border-bottom: 1px dashed #f1c40f; background: transparent; padding-left: 0; padding-right: 0; }
        .ki-checklist .list-group-item:last-child { border-bottom: none; }

        /* === Cards === */
        .tool-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px 36px 8px 8px; margin-bottom: 8px; cursor: grab; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 0.9rem; position: relative; }
        .tool-card.tool-card--chatgpt { min-height: 56px; }
        .tool-card:hover { background: #f8fbff; box-shadow: 0 6px 14px rgba(13, 110, 253, 0.16); border-color: #0d6efd; z-index: 10; }
        .tool-card:active { cursor: grabbing; }
        .tool-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px; color: #555; font-size: 0.8rem; }
        .tool-card-body { min-width: 0; }
        .tool-title-row { align-items: flex-start; gap: 8px; flex-wrap: wrap; }
        .tool-title { flex: 1 1 auto; min-width: 0; white-space: normal; line-height: 1.25; max-height: 3.75em; overflow: hidden; transition: max-height 0.2s ease; }
        .tool-title.expanded { max-height: none; }
        .tool-title-toggle { border: none; background: transparent; color: #0d6efd; font-size: 0.75rem; padding: 0 4px; line-height: 1.25; }
        .tool-title-toggle:hover { text-decoration: underline; }
        .tool-title-toggle:focus-visible { outline: 2px solid #0d6efd; outline-offset: 2px; }
        .tool-badges { display: flex; gap: 4px; flex-shrink: 0; margin-left: auto; }
        .tool-category { white-space: normal; line-height: 1.2; }
        .is-ai { box-shadow: inset 3px 0 0 #8e44ad; }
        .is-library { box-shadow: inset 3px 0 0 #198754; }
        .is-ai.is-library { box-shadow: inset 3px 0 0 #8e44ad, inset 6px 0 0 #198754; }
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; }
        .badge-ai { background: #f3e8ff; color: #6f42c1; border: 1px solid #e0c3ff; }
        .badge-lib { background: #e8fff3; color: #0f5132; border: 1px solid #b6e2c8; }
        .badge-vwl { background: #e8f2ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .badge-bwl { background: #e8f2ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .tool-link { color: #495057; margin-left: auto; padding: 2px 6px; border-radius: 4px; transition: 0.2s; }
        .tool-link:hover { background-color: #e9ecef; color: #0d6efd; }
        .tool-remove-btn { position: absolute; top: 6px; right: 6px; border: none; background: transparent; color: #6c757d; padding: 4px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
        .tool-remove-btn:hover, .tool-remove-btn:focus-visible { color: #dc3545; background: #f8d7da; }

        /* === Buttons === */
        .edit-custom-btn { border: none; background: transparent; color: #6c757d; padding: 2px 6px; }
        .edit-custom-btn:hover { color: #0d6efd; }
        .ki-check-btn { background: linear-gradient(135deg, #f39c12, #e67e22); color: #fff; font-weight: 700; letter-spacing: 0.3px; box-shadow: 0 6px 14px rgba(243, 156, 18, 0.3); border: none; }
        .ki-check-btn:hover { color: #fff; background: linear-gradient(135deg, #ffa726, #e67e22); box-shadow: 0 8px 18px rgba(243, 156, 18, 0.45); transform: translateY(-1px); }

        /* === Guided Tour (Intro.js) === */
        .introjs-overlay { background: rgba(10, 88, 202, 0.28); }
        .introjs-tooltip { border-radius: 12px; border: 1px solid #cfe2ff; box-shadow: 0 14px 28px rgba(13, 110, 253, 0.2); }
        .introjs-tooltip-title { color: #0d6efd; font-weight: 700; }
        .introjs-tooltiptext { color: #1f2937; }
        .introjs-button { border-radius: 8px; border: 1px solid #0d6efd; color: #0d6efd; background: #e7f1ff; }
        .introjs-button:hover { background: #dbeafe; color: #0a58ca; }
        .introjs-bullets ul li a.active { background: #0d6efd; }
        .introjs-progress { background: #e7f1ff; }
        .introjs-progressbar { background: #0d6efd; }
        .introjs-button:focus-visible { outline: 3px solid #0a58ca; outline-offset: 2px; }
        .introjs-helperLayer {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }
        .introjs-arrow {
            border-width: 12px !important;
        }
        .introjs-arrow.top { border-bottom-color: #0d6efd !important; }
        .introjs-arrow.bottom { border-top-color: #0d6efd !important; }
        .introjs-arrow.left { border-right-color: #0d6efd !important; }
        .introjs-arrow.right { border-left-color: #0d6efd !important; }
        .introjs-tooltip {
            position: relative;
        }
        .introjs-tooltip::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: #0d6efd;
            border-radius: 50%;
            box-shadow: 0 0 0 6px rgba(13, 110, 253, 0.25);
        }
        .introjs-tooltip.introjs-bottom::after { top: -22px; left: 24px; }
        .introjs-tooltip.introjs-top::after { bottom: -22px; left: 24px; }
        .introjs-tooltip.introjs-left::after { right: -22px; top: 24px; }
        .introjs-tooltip.introjs-right::after { left: -22px; top: 24px; }
        .introjs-tooltipbuttons {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
        }
        .introjs-tooltipbuttons .introjs-prevbutton,
        .introjs-tooltipbuttons .introjs-nextbutton,
        .introjs-tooltipbuttons .introjs-donebutton {
            float: none;
        }
        .introjs-tooltipbuttons .introjs-prevbutton { order: 1; }
        .introjs-tooltipbuttons .introjs-nextbutton { order: 2; }
        .introjs-tooltipbuttons .introjs-donebutton { order: 3; }

        /* === Modal === */
        .orientation-highlight {
            outline: 3px solid #0d6efd;
            outline-offset: 3px;
            box-shadow: 0 0 0 6px rgba(13, 110, 253, 0.2);
            transition: outline-offset 0.2s ease, box-shadow 0.2s ease;
        }
        .orientation-onboarding-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #e7f1ff;
            color: #0d6efd;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .orientation-tip-list li + li { margin-top: 6px; }
        .orientation-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .orientation-modal-footer .btn-group { flex-wrap: wrap; }

        /* === Toasts === */
        .toast-container { position: fixed; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 1080; pointer-events: none; }
        .toast-container.bottom { top: auto; bottom: 1rem; }
        .toast-item { background: #ffffff; color: #111827; border-radius: 10px; border: 1px solid #e5e7eb; border-left: 4px solid #0d6efd; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12); padding: 10px 12px; min-width: 260px; max-width: min(360px, calc(100vw - 2rem)); display: flex; align-items: flex-start; gap: 10px; pointer-events: auto; opacity: 0; transform: translateY(6px); transition: opacity 0.2s ease, transform 0.2s ease; }
        .toast-item.show { opacity: 1; transform: translateY(0); }
        .toast-item .toast-icon { font-size: 1rem; margin-top: 2px; }
        .toast-item .toast-content { flex: 1; }
        .toast-item .toast-title { font-weight: 700; font-size: 0.95rem; line-height: 1.2; }
        .toast-item .toast-message { font-size: 0.9rem; color: #374151; line-height: 1.35; word-break: break-word; }
        .toast-item .toast-close { border: none; background: transparent; color: #6b7280; cursor: pointer; padding: 4px; border-radius: 6px; flex-shrink: 0; }
        .toast-item .toast-close:focus-visible { outline: 2px solid #0d6efd; outline-offset: 2px; }
        .toast-success { border-left-color: #16a34a; }
        .toast-success .toast-icon { color: #16a34a; }
        .toast-info { border-left-color: #0d6efd; }
        .toast-info .toast-icon { color: #0d6efd; }
        .toast-error { border-left-color: #dc2626; }
        .toast-error .toast-icon { color: #dc2626; }

        /* === License Badge === */
        .license-badge {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: #ffffff;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: min(380px, calc(100vw - 2rem));
            z-index: 1100;
        }

        .license-badge-section-title {
            font-weight: 700;
            color: #212529;
            margin-bottom: 2px;
        }

        .license-badge p,
        .license-badge ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }

        .license-badge li + li {
            margin-top: 2px;
        }

        .license-badge-topline {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .license-badge a,
        .license-badge .btn-link {
            color: #0d6efd;
            text-decoration: none;
        }

        .license-badge a:hover,
        .license-badge a:focus-visible,
        .license-badge .btn-link:hover,
        .license-badge .btn-link:focus-visible {
            text-decoration: underline;
        }

        .license-badge .btn-link {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .license-badge .badge-separator {
            color: #adb5bd;
        }

        .external-services-note {
            border-top: 1px solid #e9ecef;
            padding-top: 8px;
            font-size: 0.82rem;
            line-height: 1.35;
            color: #495057;
        }

        .external-services-note button {
            font-size: 0.82rem;
            font-weight: 600;
            padding: 0;
            vertical-align: baseline;
        }

        @media (max-width: 576px) {
            .toast-container { left: 0.75rem; right: 0.75rem; top: auto; bottom: 1rem; align-items: flex-end; }
            .toast-item { width: 100%; max-width: none; }
        }

        /* === A11y === */
        .tool-card:focus-visible, .btn:focus-visible, .form-control:focus-visible, .form-select:focus-visible, .tool-link:focus-visible, .tool-info-btn:focus-visible, .edit-custom-btn:focus-visible, .tool-title-toggle:focus-visible {
            outline: 3px solid #0a58ca;
            outline-offset: 3px;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
        }

        .tool-info-btn {
            border: none;
            background: transparent;
            color: #6c757d;
            padding: 4px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            min-height: 32px;
        }

        .tool-info-btn:hover { background: #e9ecef; color: #0d6efd; }

        .phase-col:focus-within { box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.35); border-color: #0d6efd; }

        /* === Responsive Board & Layout === */
        .cockpit-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }
        .board-wrapper { overflow-x: auto; padding-bottom: 6px; }
        .board-grid { flex-wrap: nowrap; min-height: 70vh; }
        .board-grid > .col { min-width: 280px; flex: 0 0 auto; }

        @media (max-width: 1199.98px) {
            .hangar-area { height: auto; max-height: 70vh; }
            .cockpit-area { height: auto; }
            .board-wrapper { margin-top: 10px; }
        }

        @media (min-width: 1400px) {
            .board-grid { flex-wrap: wrap; }
            .board-grid > .col { min-width: 0; flex: 1 0 0; }
        }

        /* === Responsive === */
        @media print {
            .hangar-area, .no-print, .modal { display: none !important; }
            .cockpit-area { width: 100% !important; height: auto !important; overflow: visible; padding: 0; }
            .phase-col { border: 1px solid #ccc; min-height: 150px; page-break-inside: avoid; break-inside: avoid; padding: 10px; }
            .phase-header { background: #f1f3f5; padding: 8px; border-bottom: 1px solid #dee2e6; border-radius: 6px 6px 0 0; }
            .row { display: flex !important; flex-wrap: wrap !important; gap: 12px !important; }
            .cockpit-area .row.row-cols-1.row-cols-md-6.g-2 > .col { flex: 1 1 45% !important; max-width: 50% !important; min-width: 240px; }
            .cockpit-area .row.g-2 > .col-12 { flex: 1 1 100% !important; max-width: 100% !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .tool-link { display: inline-flex !important; align-items: center; gap: 4px; color: #0d6efd !important; text-decoration: underline !important; visibility: visible !important; opacity: 1 !important; }
        }

        .tooltip-inner {
            max-width: 360px;
            word-break: normal;
            overflow-wrap: normal;
            hyphens: none;
            word-break: keep-all;
        }

        .tooltip-inner ul,
        .tooltip-inner ol {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .tooltip-inner li + li {
            margin-top: 4px;
        }
    </style>
</head>
<body>

<div id="toast-container" class="toast-container no-print" aria-live="polite" aria-atomic="true" role="region" aria-label="Systembenachrichtigungen"></div>

<div class="license-badge no-print" aria-label="Unihinweis">
    <div class="license-badge-topline">
        <i class="fas fa-balance-scale"></i>
        <span>Uni: <a href="https://creativecommons.org/licenses/by/4.0/deed.de" target="_blank" rel="noopener">CC BY 4.0</a></span>
        <span class="badge-separator">|</span>
        <button type="button" class="btn btn-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#privacyModal">Datenschutz</button>
        <span class="badge-separator">|</span>
        <button type="button" class="btn btn-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#legalNoticeModal">Impressum &amp; Quellenangaben</button>
    </div>
    <div class="external-services-note">
        <i class="fas fa-shield-halved me-1" aria-hidden="true"></i>
        Externe Dienste: Vor jedem Klick Hinweise zur Datenweitergabe beachten.
        <button type="button" class="btn btn-link p-0 align-baseline"
                data-bs-toggle="modal"
                data-bs-target="#privacyModal"
                data-scroll-target="externalServicesNotice">
            Details anzeigen
        </button>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 hangar-area d-flex flex-column">
            <h5 class="mb-3"><i class="fas fa-warehouse"></i> Hangar</h5>
            <p class="text-muted small" style="line-height: 1.2;">Ziehe die Instrumente in die 5 Recherche-Phasen.</p>

            <div class="no-print mb-3">
                <label class="form-label visually-hidden" for="toolSearchInput">Tools durchsuchen</label>
                <input type="text" id="toolSearchInput" class="form-control form-control-sm mb-2" placeholder="Tools durchsuchen..." aria-label="Tools durchsuchen">
                <label class="form-label visually-hidden" for="toolCategoryDropdownButton">Kategorie filtern</label>
                <div class="dropdown w-100">
                    <button id="toolCategoryDropdownButton" class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Tools nach Kategorie filtern">
                        <span class="d-flex align-items-center gap-2">
                            <i class="fas fa-filter text-secondary"></i>
                            <span class="category-label">Alle Kategorien</span>
                        </span>
                        <i class="fas fa-chevron-down small text-muted"></i>
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="toolCategoryDropdownButton" id="toolCategoryMenu"></ul>
                </div>
                <div class="form-text small text-muted mt-1">
                    Fahren Sie in der Liste über eine Kategorie, um deren Beschreibung zu sehen.
                </div>
            </div>

            <div id="tool-pool">
                </div>

            <button class="btn btn-sm btn-outline-primary w-100 mt-3 no-print" data-bs-toggle="modal" data-bs-target="#customToolModal">
                <i class="fas fa-plus"></i> Eigenes Tool ergänzen
            </button>

            <button class="btn btn-sm btn-outline-success w-100 mt-2 no-print" data-bs-toggle="modal" data-bs-target="#licensedDbModal">
                <i class="fas fa-database"></i> Datenbank ergänzen
            </button>

            <div class="mt-auto no-print">
                <div class="mt-3 deleted-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-bold"><i class="fas fa-trash-undo me-2"></i>Gelöschte Tools &amp; Notizen</div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="restoreAllDeleted()" data-bs-toggle="tooltip" data-bs-title="Alle zurückholen" aria-label="Alle gelöschten Tools wiederherstellen">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                    <div id="deleted-list" class="deleted-empty">Noch nichts gelöscht</div>
                </div>
            </div>
        </div>

        <div class="col-md-9 cockpit-area">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                <div>
                    <h3 class="mb-1"><i class="fas fa-plane-departure"></i> Ihr Recherche‑Cockpit für die Wirtschaftswissenschaften</h3>
                    <p class="text-muted mb-0">Navigieren Sie Ihren Rechercheprozess mit einer gezielten Auswahl klassischer und KI‑gestützter Tools.</p>
                </div>
                <div class="no-print cockpit-actions">
                    <div class="dropdown" id="noteDropdown">
                        <button id="noteDropdownButton" class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-note-sticky"></i>
                            <span>Notiz hinzufügen</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header">Ziel auswählen</li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-1')">Thema eingrenzen</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-2')">Suchbegriffe sammeln</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-3')">Literatur suchen</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-5')">Literatur lesen</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-6')">Text schreiben</button></li>
                        </ul>
                    </div>
                    <button id="orientationButton" type="button" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#orientationModal">
                        <i class="fas fa-compass"></i>
                        <span>Compass</span>
                    </button>
                    <button id="ai-source-check-btn" class="btn ki-check-btn btn-sm d-inline-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#kiSourcesModal">
                        <i class="fas fa-shield-alt"></i>
                        <span>Reflektierter Umgang mit KI</span>
                    </button>
                    <button id="craap-check-btn" class="btn btn-sm btn-outline-warning d-inline-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#craapModal">
                        <i class="fas fa-clipboard-check"></i>
                        <span>CRAAP-Test</span>
                    </button>
                    <button id="guided-tour-btn" type="button" class="btn btn-sm btn-outline-info d-inline-flex align-items-center gap-2">
                        <i class="fas fa-route"></i>
                        <span>Guided Tour</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-primary dropdown-toggle" id="flightControlsButton" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plane"></i> Flight Controls
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="flightControlsButton">
                            <li><button class="dropdown-item" id="savePdfButton" type="button"><i class="fas fa-file-pdf me-2"></i>Als PDF speichern</button></li>
                            <li><button class="dropdown-item" id="exportJsonButton" type="button" onclick="exportConfiguration()"><i class="fas fa-download me-2"></i>Export</button></li>
                            <li><button class="dropdown-item" id="importJsonButton" type="button" onclick="triggerImport()"><i class="fas fa-upload me-2"></i>Import</button></li>
                            <li><button class="dropdown-item" type="button" onclick="loadExampleCockpit()"><i class="fas fa-lightbulb me-2"></i>Beispiel</button></li>
                            <li><button class="dropdown-item" type="button" onclick="resetCockpit()"><i class="fas fa-undo me-2"></i>Reset</button></li>
                        </ul>
                    </div>
                    <input type="file" id="importJsonInput" class="d-none" accept="application/json" />
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="cockpitTitleInput" placeholder="Bezeichnung des Projekts">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="userNameInput" placeholder="Pilot/in">
                </div>
            </div>

            <div class="board-wrapper">
                <div class="row row-cols-1 row-cols-md-5 g-2 board-grid flex-nowrap">
                    <div class="col">
                        <div class="phase-header">Thema eingrenzen</div>
                        <div class="phase-col" id="phase-1" role="region" aria-label="Thema eingrenzen" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                    </div>

                    <div class="col">
                        <div class="phase-header">Suchbegriffe sammeln</div>
                        <div class="phase-col" id="phase-2" role="region" aria-label="Suchbegriffe sammeln" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                    </div>

                    <div class="col">
                        <div class="phase-header">Literatur suchen</div>
                        <div class="phase-col" id="phase-3" role="region" aria-label="Literatur suchen" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                    </div>

                    <div class="col">
                        <div class="phase-header">Literatur lesen</div>
                        <div class="phase-col" id="phase-5" role="region" aria-label="Literatur lesen" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                    </div>

                    <div class="col">
                        <div class="phase-header">Text schreiben</div>
                        <div class="phase-col" id="phase-6" role="region" aria-label="Text schreiben" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                    </div>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-12">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orientationModal" role="dialog" tabindex="-1" aria-labelledby="orientationModalLabel" aria-modal="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <p class="orientation-onboarding-tag mb-1"><i class="fas fa-compass"></i> Compass</p>
                    <h5 class="modal-title" id="orientationModalLabel">Compass – Schnelle Hilfe &amp; Onboarding</h5>
                </div>
                <button type="button" class="btn-close" aria-label="Schließen" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 px-3 mb-3" role="status">
                    <div class="small mb-1 fw-semibold text-primary">Uni- und KI-Hinweis</div>
                    <ul class="small mb-0 ps-3">
                        <li><strong>Badges erkennen:</strong> Tools mit einem grünen „Uni“-Badge sind lizenzierte Angebote Ihrer Hochschule; der Zugriff ist i.d.R. nur im Campus-WLAN oder über VPN möglich. Ein lila „KI“-Badge kennzeichnet KI-gestützte Tools. Einige Tools tragen mehrere Badges.</li>
                        <li><strong>Reflektierter Umgang mit KI nutzen:</strong> Der Button „Reflektierter Umgang mit KI“ führt zu einem KI-Leitfaden und Reflexionsfragen. Der CRAAP-Test steht als eigener Button bereit, um Quellen systematisch zu prüfen.</li>
                        
                    </ul>
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="fw-bold">Was kann ich hier tun?</h6>
                        <ul class="orientation-tip-list ps-3">
                            <li><strong>Recherche-Board einrichten:</strong> Ziehen Sie Tools aus dem Hangar in die fünf Phasen des Rechercheprozesses oder zurück in den Hangar. Nutzen Sie die „Notiz hinzufügen“-Funktion, um Fragen, Quellen etc. zu dokumentieren. Halten Sie oben Ihre Projektbezeichnung fest.</li>
                            <li><strong>Tools finden und erweitern:</strong> Verwenden Sie das Suchfeld und den Kategorien-Filter im Hangar, um bestimmte Tools zu finden. Über „Datenbank ergänzen“ und „Eigenes Tool ergänzen“ lassen sich weitere Datenbanken aus einer Liste und weitere Tools in den Hangar aufnehmen.</li>
                            <li><strong>Löschen &amp; wiederherstellen:</strong> Tools und Notizen löschen Sie über das „x“ an der jeweiligen Karte. Gelöschte Einträge erscheinen anschließend im Bereich „Gelöschte Tools &amp; Notizen“ im Hangar und lassen sich dort wiederherstellen.</li>
                            <li><strong>Setups speichern &amp; teilen:</strong> Über die Flight Controls (oben rechts) können Sie Ihr Cockpit als PDF exportieren, Export/Import von JSON-Dateien durchführen oder sich ein Beispiel-Layout anzeigen lassen. Die Option Reset stellt das Board in den Ausgangszustand zurück.</li>
                            
                            
                        </ul>
                    </div>
                </div>


                <div class="alert alert-info mt-3 small" role="note">
                    <strong>Hinweis zur Toolauswahl:</strong> Das Feld „Literaturrecherche mit KI“ verändert sich schnell; die Angaben entsprechen dem Stand von Februar 2026.
                </div>
                <div class="alert alert-secondary d-flex align-items-start gap-3 mt-3" role="status">
                    <i class="fas fa-envelope-open-text text-primary mt-1"></i>
                    <div class="small">
                        <div class="fw-semibold">Kontakt</div>
                        <div>Bei Fragen oder für Schulungen wenden Sie sich an das Team Fachreferat Wirtschaft der ZHB Luzern:</div>
                        <div class="mb-1">E-Mail: <a href="mailto:wirtschaft@zhbluzern.ch">wirtschaft@zhbluzern.ch</a></div>
                        <ul class="mb-1 ps-3">
                            <li>Stefan Eicher Engel</li>
                            <li>Sandra Müller</li>
                        </ul>
                        <div>Beratung &amp; Kurse: <a class="link-primary" href="https://www.zhbluzern.ch/recherchieren/fachgebiete/buchen-sie-uns-rechercheberatung" target="_blank" rel="noreferrer noopener">Online-Buchung über das Anfrageformular</a></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer orientation-modal-footer">
                <span class="small text-muted">ESC schließt das Fenster.</span>
                <div class="btn-group" role="group" aria-label="Modalaktionen">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Schließen</button>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="textNoteModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="textNoteModalTitle">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textNoteModalTitle"><i class="fas fa-note-sticky me-2"></i>Notiz hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="noteTitle" class="form-control mb-2" placeholder="Titel (optional)" aria-label="Titel der Notiz">
                <textarea id="noteContent" class="form-control" rows="4" placeholder="Ihre Notiz" aria-label="Inhalt der Notiz"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addTextBlock()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customToolModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="customToolModalTitle">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customToolModalTitle">Eigenes Tool ergänzen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="customToolName" class="form-control mb-2" placeholder="Name (z.B. Experten-Interview)" aria-label="Name des Tools">
                <input type="text" id="customToolInfo" class="form-control mb-2" placeholder="Beschreibung für Mouseover" aria-label="Beschreibung des Tools">
                <input type="text" id="customToolUrl" class="form-control mb-2" placeholder="URL (optional)" aria-label="URL des Tools">
                <div class="mb-2">
                    <label for="customToolCategory" class="form-label">Bereich (Mehrfachauswahl möglich)</label>
                    <select id="customToolCategory" class="form-select" multiple size="6"></select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="customToolIsAi">
                    <label class="form-check-label" for="customToolIsAi">
                        KI-Tool
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="customToolIsLib">
                    <label class="form-check-label" for="customToolIsLib">
                        Uni
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="customToolSubmitBtn" onclick="addCustomTool()">Hinzufügen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="licensedDbModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="licensedDbModalLabel" aria-describedby="licensedDbDescription">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="licensedDbModalLabel"><i class="fas fa-database me-2"></i>Datenbank ergänzen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label for="licensedDbSelect" class="form-label">Datenbank auswählen</label>
                        <select id="licensedDbSelect" class="form-select" size="10"></select>
                    </div>
                    <div class="col-md-7">
                        <div class="border rounded p-3 h-100 bg-light" id="licensedDbDetails">
                            <h6 class="fw-bold mb-2" id="licensedDbTitle">Datenbank wählen</h6>
                            <p class="mb-2 small text-muted" id="licensedDbDescription">Wählen Sie links eine Datenbank aus, um Details zu sehen.</p>
                            <div class="small" id="licensedDbBadges"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addLicensedDatabase()">Zum Hangar hinzufügen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="kiSourcesModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="kiSourcesModalLabel" aria-describedby="kiSourcesModalDesc">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border border-warning shadow-lg">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title" id="kiSourcesModalLabel">
                    <i class="fas fa-shield-alt text-warning me-2"></i>
                    Reflektierter Umgang mit KI
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted mb-3" id="kiSourcesModalDesc"></p>
                <ul class="nav nav-pills" id="kiSourcesTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="ki-guide-tab" data-bs-toggle="pill" data-bs-target="#ki-guide" type="button" role="tab" aria-controls="ki-guide" aria-selected="true">
                            <i class="fas fa-graduation-cap me-1"></i> KI-Guide
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ki-reflexion-fragen-tab" data-bs-toggle="pill" data-bs-target="#ki-reflexion-fragen" type="button" role="tab" aria-controls="ki-reflexion-fragen" aria-selected="false">
                            <i class="fas fa-comments me-1"></i> KI-Reflexion – Fragen
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="ki-guide" role="tabpanel" aria-labelledby="ki-guide-tab">
                        <div class="ki-callout mb-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fas fa-graduation-cap text-warning"></i>
                                <span class="fw-semibold">KI-Guide</span>
                            </div>
                            <p class="mb-3 small text-muted">Dieser Leitfaden zeigt auf, wie KI im Rahmen der Literaturrecherche im Studium genutzt werden darf und welche Anforderungen an die Offenlegung ihres Einsatzes bestehen.</p>

                            <h6 class="fw-semibold text-warning mb-2">1. Der Vor-Check: Kenne die Regeln</h6>
                            <p class="small text-muted">Bevor Sie KI-Tools für die Literaturrecherche verwenden, klären Sie die Rahmenbedingungen. Es gibt keine "Eine Regel für alle".</p>
                            <ul class="small text-muted mb-3">
                                <li><strong>Fakultät / Institut prüfen:</strong> Gibt es offizielle Merkblätter, KI-Leitlinien oder Richtlinien auf der Website Ihrer Fakultät?</li>
                                <li><strong>Betreuung fragen:</strong> Wenn nichts Schriftliches vorliegt, fragen Sie direkt Ihre Betreuungsperson: <em>"Darf ich KI-Tools nutzen, und wenn ja, in welchem Umfang?"</em></li>
                            </ul>

                            <h6 class="fw-semibold text-warning mb-2">2. Der Kompass: Drei Prinzipien guter wissenschaftlicher Praxis</h6>
                            <p class="small text-muted">Ihr KI-Einsatz steht und fällt mit diesen drei Säulen. Wenn Sie die Prinzipien beachten, sind Sie auf der sicheren Seite.</p>

                            <div class="mb-3">
                                <div class="fw-semibold small">Prinzip 1: Verantwortung ("Human in the Loop")</div>
                                <p class="small text-muted mb-2">Sie sind der Regisseur, die KI-Tools sind nur Ihre Assistenten. Übernehmen Sie nie blind KI-generierte Inhalte und Quellen!</p>
                                <ul class="small text-muted mb-2">
                                    <li><strong>Ihre Aufgabe:</strong> KI-Outputs hinterfragen, prüfen und überarbeiten.</li>
                                    <li><strong>Das Ziel:</strong> Sie müssen jede Zeile Ihrer Arbeit erklären und verteidigen können.</li>
                                </ul>
                                <div class="small text-muted mb-2">Hilfen:</div>
                                <ul class="small text-muted mb-0">
                                    <li>KI-Reflexion – Fragen</li>
                                    <li>CRAAP-Test</li>
                                </ul>
                            </div>

                            <div class="mb-3">
                                <div class="fw-semibold small">Prinzip 2: Eigenleistung</div>
                                <p class="small text-muted mb-2">Wissenschaftliches Arbeiten ist der Beweis Ihrer eigenen Denkfähigkeit. Strukturieren, Argumentieren und Schlussfolgern ist Ihr Job.</p>
                                <ul class="small text-muted mb-2">
                                    <li><strong>Die Grenze:</strong> Die KI kann Impulse geben, aber die intellektuelle Schöpfung (die "rote Linie") muss von Ihnen stammen.</li>
                                    <li><strong>Achtung:</strong> Am Ende einer wissenschaftlichen Arbeit steht eine Selbständigkeitserklärung, mittlerweile an vielen Unis inkl. Abschnitt zu KI-Nutzung.</li>
                                </ul>
                            </div>

                            <div class="mb-3">
                                <div class="fw-semibold small">Prinzip 3: Transparenz</div>
                                <p class="small text-muted mb-2">Verstecken Sie den KI-Einsatz nicht. Legen Sie offen, wie Ergebnisse entstanden sind.</p>
                                <ul class="small text-muted mb-2">
                                    <li><strong>Leitlinie:</strong> "So transparent wie nötig, so einfach wie möglich."</li>
                                    <li><strong>Die Dokumentation:</strong> Führen Sie während des Schreibens ein einfaches Protokoll ("Prompt-Tagebuch"). Das schafft Sicherheit, falls später Fragen aufkommen.</li>
                                </ul>
                            </div>

                            <h6 class="fw-semibold text-warning mb-2">3. Praxis-Tipp: Das KI-Protokoll</h6>
                            <p class="small text-muted">Dokumentieren Sie Ihre KI-Nutzung laufend (z. B. in einer einfachen Excel- oder Word-Tabelle). Das spart Ihnen am Ende Stress.</p>

                            <h6 class="fw-semibold text-warning mb-2">4. Anwendungsbeispiel: Wie konkret KI-Nutzung offenlegen?</h6>
                            <p class="small text-muted">
                                Informieren Sie sich hierzu im Merkblatt des Center für Human Resource Management an der Uni Luzern:
                                <a class="link-primary" href="https://www.unilu.ch/fileadmin/fakultaeten/wf/institute/hrm/dok/Studium/DE_Merkblatt_fuer_den_Umgang_mit_Kuenstlicher_Intelligenz__KI__.pdf" target="_blank" rel="noreferrer noopener">Merkblatt zum Umgang mit KI</a>.
                            </p>

                            <h6 class="fw-semibold text-warning mb-2">5. Quintessenz</h6>
                            <p class="small text-muted mb-0">Wissenschaftliches Arbeiten heißt nicht, alles allein zu tun. Es bedeutet, Verantwortung für das Ergebnis zu übernehmen und alle Hilfen – egal ob Literatur, Betreuer/innen, Kommiliton/innen oder KI-Tools – reflektiert und transparent zu nutzen.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="ki-reflexion-fragen" role="tabpanel" aria-labelledby="ki-reflexion-fragen-tab">
                        <div class="ki-callout mb-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fas fa-comments text-warning"></i>
                                <span class="fw-semibold">Wie kann ich KI reflektiert einsetzen? – Fragen, die Sie sich immer wieder stellen können</span>
                            </div>
                            <p class="mb-3 small text-muted">
                                KI-Tools können wertvolle Assistenten bei der Literaturrecherche sein – doch die Regie müssen Sie übernehmen. Sie sind verantwortlich für die Inhalte und Quellen Ihrer Arbeit. Deshalb gilt: Verwenden Sie nur Inhalte und Quellen, die Sie selbst nachvollziehen und erklären können. Dazu können Sie sich immer wieder folgende Fragen stellen:
                            </p>
                            <ol class="small text-muted mb-0">
                                <li class="mb-2">
                                    <strong>Problem – Was genau möchte ich erreichen? Was ist die spezifische Teilaufgabe?</strong>
                                </li>
                                <li class="mb-2">
                                    <strong>Rolle – Welche Rolle soll die KI übernehmen?</strong>
                                    <div class="mt-1">Zwei typische Einsatzszenarien:</div>
                                    <ul class="mt-1">
                                        <li><strong>Brainstorming-Partnerin:</strong> Die KI kann Inspiration und Impulse für die Literaturrecherche bieten – zu Beginn und während des Prozesses.</li>
                                        <li><strong>Feedback-Partnerin:</strong> Die KI lässt sich als Feedback-Schleife in den eigenen Arbeitsprozess integrieren.</li>
                                    </ul>
                                </li>
                                <li class="mb-2">
                                    <strong>Datenbasis des Tools – Was wird durchsucht?</strong>
                                    <div class="mt-1">Nicht jedes Tool eignet sich für jede Fragestellung – prüfen Sie, ob die Datenbasis passt:</div>
                                    <ul class="mt-1">
                                        <li>Deckt das Tool mein Fachgebiet ab?</li>
                                        <li>Welche Art von Literatur kann gefunden werden?</li>
                                        <li>Welche Publikationsformen (Journalartikel, Preprints oder Bücher)?</li>
                                        <li>Open Access oder lizenzierte Inhalte?</li>
                                        <li>Welche Sprachen?</li>
                                        <li>Wie aktuell sind die Quellen?</li>
                                    </ul>
                                </li>
                                <li class="mb-2">
                                    <strong>Reflexion – Wie kann ich prüfen, ob der generierte Output zu meiner Problemstellung passt?</strong>
                                    <div class="mt-1">Die kritische Einschätzung erfordert Fachkompetenz. Prüfen Sie den Output anhand folgender Kriterien:</div>
                                    <ul class="mt-1">
                                        <li>Passt der Inhalt zu meiner Fragestellung oder führt er auf ein Nebengleis?</li>
                                        <li>Ist die Quelle relevant und zuverlässig? (z. B. mit dem CRAAP-Test prüfen)</li>
                                        <li>Stammen die Autor/innen aus meinem Fachgebiet?</li>
                                        <li>Welche Literatur finde ich mit klassischen Suchinstrumenten?</li>
                                    </ul>
                                </li>
                                <li class="mb-2">
                                    <strong>Zugang und Kosten – Ist das Tool auch in der kostenlosen Version nützlich? Gibt es lizenzierte Alternativen über die Bibliothek?</strong>
                                </li>
                                <li>
                                    <strong>Datenschutz und Urheberrecht – Was passiert mit den eingegebenen Daten?</strong>
                                    <ul class="mt-1">
                                        <li>Wenn nicht ausgeschlossen werden kann, dass die eingegebenen Daten weiterverarbeitet werden (z. B. zu Trainingszwecken), gilt: Geben Sie keine sensiblen personenbezogenen Informationen über sich oder andere Personen ein.</li>
                                        <li>Laden Sie keine Inhalte hoch, an denen Sie keine Rechte besitzen.</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="craapModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="craapModalLabel" aria-describedby="craapModalDesc">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border border-warning shadow-lg">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title" id="craapModalLabel">
                    <i class="fas fa-clipboard-check text-warning me-2"></i>
                    CRAAP-Test
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="ki-callout" id="craapModalDesc">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-list-check text-warning"></i>
                        <span class="fw-semibold">Soll ich die Quelle zitieren oder nicht? – CRAAP-Test (Checkliste)</span>
                    </div>
                    <p class="mb-2 small text-muted">Bewerten Sie Quellen systematisch, bevor Sie sie übernehmen.</p>
                    <ul class="list-group ki-checklist">
                        <li class="list-group-item">
                            <div class="d-flex align-items-start gap-2">
                                <i class="fas fa-clock text-warning mt-1"></i>
                                <div><div class="fw-semibold">Currency</div><div class="text-muted small">Wie aktuell sind Daten und Publikation?</div></div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-start gap-2">
                                <i class="fas fa-bullseye text-warning mt-1"></i>
                                <div><div class="fw-semibold">Relevance</div><div class="text-muted small">Passt der Inhalt genau zu Ihrer Fragestellung?</div></div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-start gap-2">
                                <i class="fas fa-user-tie text-warning mt-1"></i>
                                <div><div class="fw-semibold">Authority</div><div class="text-muted small">Wer steht hinter der Quelle? Kommen die Autor/innen aus der Wissenschaft? Sind sie Expert/innen im Thema?</div></div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-start gap-2">
                                <i class="fas fa-check-double text-warning mt-1"></i>
                                <div><div class="fw-semibold">Accuracy</div><div class="text-muted small">Sind Aussagen belegt, konsistent und nachvollziehbar?</div></div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-start gap-2">
                                <i class="fas fa-bullhorn text-warning mt-1"></i>
                                <div><div class="fw-semibold">Purpose</div><div class="text-muted small">Warum existiert die Quelle? Information, Verkauf, Meinung?</div></div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="privacyModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="privacyModalLabel">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="privacyModalLabel">Datenschutzerklärung</h5>
                    <div class="text-muted small">Recherche-Cockpit | thinkik.github.io/recherche/</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-3">Stand: 09.01.2026</div>

                <p>Diese Datenschutzerklärung informiert darüber, welche Daten beim Besuch und bei der Nutzung des Recherche-Cockpits verarbeitet werden, wo diese Daten anfallen (Browser / Hosting / Drittanbieter) und wie Sie Daten wieder löschen können.</p>

                <h6 class="fw-bold mt-4">1) Verantwortliche Stelle</h6>
                <p class="mb-2">Zentral- und Hochschulbibliothek Luzern (ZHB Luzern)<br>
                    Sempacherstrasse 10, Postfach 4469, 6002 Luzern (CH)<br>
                    Kontakt (fachlich): <a href="mailto:wirtschaft@zhbluzern.ch">wirtschaft@zhbluzern.ch</a> (Team Wirtschaft; siehe Kontaktangabe im Cockpit).</p>
                <p class="mb-0"><strong>Hinweis zum Hosting:</strong> Diese Seite wird technisch über GitHub Pages bereitgestellt. GitHub verarbeitet dabei gewisse technische Zugriffsdaten (siehe Ziff. 3).</p>

                <h6 class="fw-bold mt-4">2) Grundprinzip: Keine serverseitige Speicherung Ihrer Cockpit-Inhalte</h6>
                <p>Das Recherche-Cockpit ist als client-seitiges Tool konzipiert:</p>
                <ul>
                    <li>Notizen, Board-Setup, gelöschte Elemente und selbst hinzugefügte Tools werden lokal in Ihrem Browser gespeichert (Local Storage) – nicht auf einem Server der ZHB.</li>
                    <li>Es gibt kein Login, keine Nutzerkonten und keine Eingabeformulare, die Inhalte an einen ZHB-Server senden.</li>
                </ul>

                <h6 class="fw-bold mt-4">3) Hosting &amp; Zugriffsdaten (GitHub Pages)</h6>
                <p>Beim Aufruf der Website werden durch den Hosting-Anbieter GitHub Pages aus Sicherheitsgründen Zugriffsdaten verarbeitet. Dazu können insbesondere gehören:</p>
                <ul>
                    <li>IP-Adresse, Datum/Uhrzeit, aufgerufene Seite, technische Informationen (z.&nbsp;B. Browser/OS), Referrer.</li>
                </ul>
                <p>GitHub dokumentiert, dass bei GitHub Pages die IP-Adresse protokolliert und zu Sicherheitszwecken gespeichert wird. Weitere Informationen: <a href="https://docs.github.com/en/site-policy/privacy-policies/github-privacy-statement" target="_blank" rel="noreferrer noopener">GitHub Privacy Statement</a>.</p>
                <p class="mb-0"><strong>Hinweis zum Drittlandbezug:</strong> GitHub, Inc. ist ein Anbieter mit Bezug zu den USA (Drittstaat aus CH/EU-Sicht). Eine Verarbeitung bzw. ein Zugriff aus Drittländern kann daher nicht ausgeschlossen werden. GitHub verweist für internationale Datentransfers auf Standardvertragsklauseln und ergänzende Schutzmaßnahmen; Details finden Sie im <a href="https://docs.github.com/en/site-policy/privacy-policies/github-general-privacy-statement#international-data-transfers" target="_blank" rel="noreferrer noopener">Abschnitt zu internationalen Datenübermittlungen</a> sowie im <a href="https://docs.github.com/en/site-policy/privacy-policies/github-subprocessors" target="_blank" rel="noreferrer noopener">Subprocessor-Verzeichnis</a>.</p>

                <h6 class="fw-bold mt-4">4) Lokale Bibliotheken (Self-Hosting im Repository)</h6>
                <p>Die Bibliotheken Bootstrap, Font Awesome und Intro.js werden direkt lokal aus diesem Repository geladen (Self-Hosting) und nicht über externe CDNs eingebunden.</p>
                <p>Aktuell werden lokal eingebunden:</p>
                <ul>
                    <li>Bootstrap über <code>css/bootstrap.min.css</code> und <code>js/bootstrap.bundle.min.js</code></li>
                    <li>Font Awesome über <code>css/all.min.css</code> (inkl. lokaler <code>webfonts/</code>)</li>
                    <li>Intro.js über <code>css/introjs.min.css</code> und <code>js/intro.min.js</code></li>
                </ul>
                <p class="mb-0">Dadurch entfallen beim Laden dieser Abhängigkeiten externe Requests an jsDelivr, cdnjs oder unpkg.</p>

                <h6 class="fw-bold mt-4">5) Lokale Speicherung im Browser (Local Storage) – transparent aufgeschlüsselt</h6>
                <p>Das Tool speichert Zustände ausschließlich in Ihrem Browser (Local Storage). Dabei werden insbesondere folgende Schlüssel genutzt:</p>
                <ul>
                    <li><strong>cockpitState_v3</strong>: Speichert das Cockpit-Board (welche Tools in welcher Phase liegen, Notizen, Tool-Metadaten wie Name/Beschreibung/URL/Kategorien, Badges wie „KI“/„Uni“/„VWL“, Status-Attribute wie „custom tool“ etc.).</li>
                    <li><strong>cockpitDeleted_v1</strong>: Speichert gelöschte Tools/Notizen, damit diese im Bereich „Gelöschte Tools &amp; Notizen“ wiederhergestellt werden können.</li>
                    <li><strong>customTools</strong>: Speichert von Ihnen selbst hinzugefügte Tools (Name, URL, Beschreibung, Kategorien, Badges).</li>
                    <li><strong>tourCompleted</strong>: Speichert, ob die Guided Tour bereits abgeschlossen/übersprungen wurde (damit sie nicht bei jedem Start automatisch läuft).</li>
                </ul>
                <p><strong>Wie löschen Sie diese Daten?</strong></p>
                <ul>
                    <li>In der Anwendung: „Reset“ setzt das Board zurück (je nach Implementierung inkl. lokaler Speicherstände).</li>
                    <li>Im Browser: Löschen Sie Website-Daten/Local-Storage für thinkik.github.io (Browser-Einstellungen → Datenschutz → Website-Daten löschen).</li>
                </ul>

                <h6 class="fw-bold mt-4">6) Export/Import &amp; PDF</h6>
                <ul>
                    <li><strong>Export (JSON):</strong> Beim Export wird eine Datei auf Ihrem Gerät erstellt. Es erfolgt keine automatische Übertragung an Dritte.</li>
                    <li><strong>Import (JSON):</strong> Beim Import wird eine von Ihnen gewählte Datei lokal eingelesen; anschließend wird der Zustand lokal gespeichert.</li>
                    <li><strong>Als PDF speichern:</strong> Nutzt die Druck-/PDF-Funktion Ihres Browsers (lokaler Prozess).</li>
                </ul>

                <h6 class="fw-bold mt-4">7) Externe Links &amp; verlinkte Tools (z.&nbsp;B. KI-Tools, Datenbanken)</h6>
                <p>Das Cockpit enthält Links zu externen Angeboten (Recherche-Tools, Datenbanken, KI-Dienste, Beratungsformulare). Wenn Sie diese öffnen, gilt:</p>
                <ul>
                    <li>Ihr Browser stellt eine direkte Verbindung zum jeweiligen Anbieter her; dabei werden technisch bedingt u.&nbsp;a. IP-Adresse und Browser-Informationen übertragen.</li>
                    <li>Welche Daten dort verarbeitet werden, regelt die Datenschutzerklärung des jeweiligen Anbieters.</li>
                </ul>
                <p class="mb-0"><strong>Wichtiger Hinweis bei KI-Tools:</strong> Geben Sie keine sensiblen personenbezogenen Daten oder urheberrechtlich geschützten Volltexte ein, wenn Sie nicht sicher sind, wie der Anbieter diese verarbeitet.</p>

                <h6 class="fw-bold mt-4" id="externalServicesNotice">8) Wichtiger Hinweis zu externen Diensten (beim Klick auf Tool-Links)</h6>
                <ul>
                    <li><strong>Datenübermittlung an Drittdienste beim Klick:</strong> Sobald Sie einen externen Tool-Link öffnen, gelten die Datenschutz- und Nutzungsbedingungen des jeweiligen Dienstes. Dabei können technische Nutzungsdaten und ggf. Inhalteingaben an Drittdienste übermittelt werden.</li>
                    <li><strong>Eigenverantwortung der Nutzenden:</strong> Die Nutzung externer Dienste erfolgt in eigener Verantwortung. Prüfen Sie vor der Nutzung die jeweils aktuellen Richtlinien, Speicherorte und Zugriffsrechte des Anbieters.</li>
                    <li><strong>Verbot kritischer Eingaben in KI-Diensten:</strong> Geben Sie keine sensiblen personenbezogenen Daten, vertraulichen Informationen oder urheberrechtlich problematischen Inhalte in KI-Dienste ein. Solche Eingaben sind zu unterlassen und können zu rechtlichen Konsequenzen (inkl. Abmahnungen) führen.</li>
                </ul>

                <h6 class="fw-bold mt-4">9) Cookies &amp; Tracking</h6>
                <p>Das Recherche-Cockpit selbst setzt keine Tracking-Cookies und nutzt keine Web-Analytics (z.&nbsp;B. Google Analytics/Matomo). Technisch notwendige Cookies können durch GitHub gesetzt werden (z.&nbsp;B. für Sicherheits-/Performance-Zwecke); Details dazu finden Sie in der GitHub-Datenschutzerklärung.</p>

                <h6 class="fw-bold mt-4">10) Rechtsgrundlagen</h6>
                <p>Für Datenbearbeitungen durch die ZHB im Rahmen dieses Angebots gelten die einschlägigen datenschutzrechtlichen Bestimmungen (insb. kantonales Datenschutzrecht; soweit anwendbar ergänzend DSG/DSGVO). Je nach Verarbeitungskontext stützen wir uns auf folgende Grundlagen:</p>
                <ul>
                    <li><strong>Hosting-Logs / technische Bereitstellung (Ziff. 3):</strong> Berechtigtes Interesse bzw. öffentliche Aufgabe an einem sicheren und stabilen Betrieb des Webangebots (IT-Sicherheit, Missbrauchsabwehr, Fehleranalyse).</li>
                    <li><strong>Lokaler Storage im Browser (Ziff. 5):</strong> Technische Erforderlichkeit zur Bereitstellung der von Ihnen aktiv genutzten Funktionen (Speichern Ihres Board-Status direkt auf Ihrem Endgerät); Rechtsgrundlage ist die Funktionserfüllung des Tools auf Ihre Veranlassung.</li>
                    <li><strong>Export/Import/PDF (Ziff. 6):</strong> Verarbeitung auf Ihre ausdrückliche Aktion hin (Nutzerinitiative; lokale Verarbeitung auf dem Endgerät).</li>
                    <li><strong>Externe Linkaufrufe (Ziff. 7):</strong> Datenübermittlung an den jeweiligen Drittanbieter erst durch Ihren aktiven Klick (Einwilligung/selbstbestimmte Nutzung des externen Dienstes).</li>
                    <li><strong>Kontaktaufnahme per E-Mail (Ziff. 11):</strong> Bearbeitung zur Beantwortung Ihres Anliegens und zur Erfüllung gesetzlicher Pflichten im Datenschutzkontext.</li>
                </ul>
                <p class="mb-0">Soweit Daten bei GitHub verarbeitet werden, erfolgt dies in deren Verantwortungsbereich nach den dort genannten Rechtsgrundlagen und Transfermechanismen.</p>

                <h6 class="fw-bold mt-4">11) Ihre Rechte / Kontakt</h6>
                <p>Sie haben – im Rahmen des anwendbaren Datenschutzrechts – insbesondere folgende Rechte: Auskunft, Berichtigung, Löschung, Einschränkung der Bearbeitung, Widerspruch sowie (soweit anwendbar) Datenherausgabe/-übertragbarkeit. Zusätzlich besteht ein Beschwerderecht bei der zuständigen Aufsichtsbehörde.</p>
                <p><strong>Operativer Kontaktweg für Datenschutzanfragen:</strong><br>
                    1) Bitte senden Sie Ihr Anliegen mit dem Betreff „Datenschutzanfrage Recherche-Cockpit“ an <a href="mailto:wirtschaft@zhbluzern.ch">wirtschaft@zhbluzern.ch</a>.<br>
                    2) Alternativ per Post an: Zentral- und Hochschulbibliothek Luzern (ZHB), Sempacherstrasse 10, Postfach 4469, 6002 Luzern.<br>
                    3) Die Anfrage wird intern an die zuständige Datenschutzstelle bzw. den/die Datenschutzbeauftragte:n der Institution weitergeleitet, sofern dies für die Bearbeitung erforderlich ist.</p>
                <p>Für rein lokale Daten (Notizen/Board-Setup) ist der effektivste Weg weiterhin die Löschung im Browser (Ziff. 5), da diese Daten grundsätzlich nicht auf ZHB-Servern vorliegen.</p>

                <h6 class="fw-bold mt-4">12) Änderungen</h6>
                <p class="mb-0">Diese Datenschutzerklärung kann angepasst werden, wenn sich Funktionen (z.&nbsp;B. zusätzliche Speichermechanismen, neue lokale oder externe Integrationen, Analytics) ändern. Die jeweils aktuelle Version sollte auf der Website abrufbar sein.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="legalNoticeModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="legalNoticeModalLabel">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="legalNoticeModalLabel">Impressum &amp; Quellenangaben</h5>
                    <div class="text-muted small">Recherche-Cockpit | thinkik.github.io/recherche/</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold">Impressum</h6>
                <p class="mb-1 fw-semibold">Herausgeberin:</p>
                <p class="mb-1">Zentral- und Hochschulbibliothek Luzern (ZHB)</p>
                <p class="mb-1">Standort Sempacherstrasse</p>
                <p class="mb-1">Sempacherstrasse 10</p>
                <p class="mb-1">6002 Luzern</p>
                <p class="mb-1">Tel: +41 (0)41 228 53 53</p>
                <p class="mb-1">E-Mail (Impressum): <a href="mailto:wirtschaft@zhbluzern.ch">wirtschaft@zhbluzern.ch</a></p>

                <p class="mb-1 mt-3 fw-semibold">Verantwortlich für den Inhalt:</p>
                <p class="mb-1">Team Fachreferat Wirtschaft (Stefan Eicher Engel, Sandra Müller)</p>
                <p class="mb-0">Vertretungsberechtigte Organisationseinheit: Zentral- und Hochschulbibliothek Luzern (ZHB), Team Fachreferat Wirtschaft</p>

                <p class="mb-0 mt-3 small text-muted">Primär-Zielland/Rechtsraum: Schweiz (CH). Das Angebot richtet sich vorrangig an Nutzer:innen der ZHB Luzern; zusätzliche Anforderungen anderer Rechtsräume (z.&nbsp;B. DE/EU) werden nur ergänzend berücksichtigt, soweit anwendbar.</p>

                <h6 class="fw-bold mt-4">Quellenangaben</h6>
                <ul class="mb-0">
                    <li><a href="https://ki-campus.org/lernangebote/kurse/prompt-labor-generative-ki-der-hochschullehre-anwendungen" target="_blank" rel="noreferrer noopener">KI-Campus, Prompt-Labor: Generative KI in der Hochschullehre – Anwendungen</a></li>
                    <li><a href="https://uni-tuebingen.de/securedl/sdl-eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3NzE1MDc5MzMsImV4cCI6MTc3MTU5NzkzMywidXNlciI6MCwiZ3JvdXBzIjpbMCwtMV0sImZpbGUiOiJmaWxlYWRtaW4vVW5pX1R1ZWJpbmdlbi9FaW5yaWNodHVuZ2VuL1VuaXZlcnNpdGFldHNiaWJsaW90aGVrL0Rva3VtZW50ZS9MZXJuZW5fQXJiZWl0ZW4vMjAyNV8wNl9BSV9SZXNlYXJjaF9Ub29sX092ZXJ2aWV3LnBkZiIsInBhZ2UiOjI2ODA5OH0.hUtW6zSr-6wjQ3o8LBh_6gPXpTgkXn7o7SAkb8jwyko/2025_06_AI_Research_Tool_Overview.pdf" target="_blank" rel="noreferrer noopener">Lelde Baumgarten, AI Research Tool Overview</a></li>
                    <li><a href="https://www.econbiz.de/eb/fileadmin/ik_broschuere/schreibe_deine_beste_hausarbeit_booklet.pdf" target="_blank" rel="noreferrer noopener">ZBW, Schreibe Deine beste Hausarbeit in Wirtschaftswissenschaften</a></li>
                    <li><a href="https://www.werkzeugkasten-ik.ch/" target="_blank" rel="noreferrer noopener">ZHB Luzern, Werkzeugkasten Informationskompetenz</a></li>
                    <li><a href="https://www.pearltrees.com/poloek_ik" target="_blank" rel="noreferrer noopener">ZHB Luzern, Linksammlung: Tools &amp; Tipps für die Literaturrecherche in VWL</a></li>
                    <li>Bootstrap (Dateien: <code>css/bootstrap.min.css</code>, <code>js/bootstrap.bundle.min.js</code>) – MIT License, Quelle: <a href="https://getbootstrap.com/" target="_blank" rel="noreferrer noopener">getbootstrap.com</a></li>
                    <li>Font Awesome Free (Dateien: <code>css/all.min.css</code>, <code>webfonts/*</code>) – Code: MIT, Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Quelle: <a href="https://fontawesome.com/" target="_blank" rel="noreferrer noopener">fontawesome.com</a></li>
                    <li>Intro.js (Dateien: <code>css/introjs.min.css</code>, <code>js/intro.min.js</code>) – MIT License, Quelle: <a href="https://introjs.com/" target="_blank" rel="noreferrer noopener">introjs.com</a></li>
                    <li>Vollständige Übersicht aller Drittanbieter-Lizenzen: <code>THIRD_PARTY_LICENSES.md</code> im Repository.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<script src="js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('[data-scroll-target]').forEach((trigger) => {
        trigger.addEventListener('click', () => {
            const modalSelector = trigger.getAttribute('data-bs-target');
            const targetId = trigger.getAttribute('data-scroll-target');
            if (!modalSelector || !targetId) return;
            const modal = document.querySelector(modalSelector);
            if (!modal) return;

            const scrollToTarget = () => {
                const target = modal.querySelector(`#${targetId}`);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                modal.removeEventListener('shown.bs.modal', scrollToTarget);
            };

            modal.addEventListener('shown.bs.modal', scrollToTarget);
        });
    });

    // === STATE & KONFIGURATION ===
    const EXPORT_SCHEMA_VERSION = '1.0';

    const categories = {
        'Assistants': { icon: 'fa-lightbulb', info: 'Allrounder-Chatbots für Brainstorming und Feedback.' },
        'Keywords': { icon: 'fa-key', info: 'Wortlisten und Thesauri zum Sammeln passender Suchbegriffe und Synonyme.' },
        'Finders': { icon: 'fa-search', info: 'Suchmaschinen, Datenbanken und Kataloge, mit denen Sie geeignete Quellen aufspüren und Trefferlisten filtern.' },
        'Connectors': { icon: 'fa-project-diagram', info: 'KI-Tools, die Publikationsnetzwerke als interaktive Karten zeigen, um Schlüsselarbeiten zu finden.' },
        'Evaluators': { icon: 'fa-check-double', info: 'Werkzeuge zur Bewertung von Qualität und Wirkung, z. B. Kontext zu Zitierungen oder Hinweise auf den wissenschaftlichen Konsens.' },
        'Analyzers': { icon: 'fa-microscope', info: 'KI-Tools zum Zusammenfassen, Erklären und Beantworten von Fragen zu Texten (mehrsprachig).' },
        'Writers': { icon: 'fa-pen-nib', info: 'Schreib- und Stilhilfen für saubere Formulierungen, Grammatikprüfungen und Feedback auf wissenschaftliche Texte.' },
        'Organizers': { icon: 'fa-folder-open', info: 'Literaturverwaltungsprogramme zum Sammeln, Ordnen und Zitieren Ihrer Quellen in verschiedenen Zitationsstilen.' },
        'Notizen': { icon: 'fa-note-sticky', info: 'Eigene Merkzettel, um Zwischenergebnisse, Recherchewege und To-dos festzuhalten.' }
    };

    const HIDDEN_CATEGORIES = ['Notizen'];

    const flightPhases = {
        'PRE-FLIGHT': { icon: 'fa-clipboard-list', categories: ['Assistants', 'Keywords'] },
        'TAKE-OFF': { icon: 'fa-plane-departure', categories: ['Finders'] },
        'IN-FLIGHT': { icon: 'fa-plane', categories: ['Evaluators', 'Analyzers', 'Connectors'] },
        'LANDING': { icon: 'fa-plane-arrival', categories: ['Writers', 'Organizers', 'Notizen'] }
    };

    const initialTools = [
        { id: 't1', name: 'ChatGPT', cats: ['Assistants'], url: 'https://chat.openai.com', isAi: true, info: 'Allrounder-Chatbot für Ideenfindung und Schreibunterstützung.' },
        { id: 't1b', name: 'Microsoft Copilot', cats: ['Assistants'], url: 'https://m365.cloud.microsoft/', isAi: true, isLib: true, info: 'Microsoft-Chatbot für Brainstorming und erste Rechercheschritte.' },
        { id: 't1c', name: 'Gemini', cats: ['Assistants'], url: 'https://deepmind.google/models/gemini/', isAi: true, info: 'Google-Chatbot für Ideenfindung und strukturierte Antworten.' },
        { id: 't1d', name: 'Claude', cats: ['Assistants'], url: 'https://claude.ai/', isAi: true, info: 'Chatbot mit Fokus auf präzise Antworten und Textarbeit.' },
        { id: 't2', name: 'SciSpace', cats: ['Finders', 'Analyzers', 'Writers'], url: 'https://scispace.com/', isAi: true, info: 'Plattform zum Finden, Verstehen und Zusammenfassen wissenschaftlicher Texte.' },
        { id: 't4', name: 'Swisscovery RZS Uni/PH', cats: ['Finders'], url: 'https://rzs.swisscovery.slsp.ch/discovery/search?vid=41SLSP_RZS:VU07', isAi: false, info: 'Rechercheportal der Unibibliothek Luzern, ideal für Bücher.', isLib: true },
        { id: 't5', name: 'Elicit', cats: ['Finders'], url: 'https://elicit.org', isAi: true, info: 'KI-Recherchetool zum Finden und Vergleichen relevanter Studien.' },
        { id: 't6', name: 'Google Scholar', cats: ['Finders'], url: 'https://scholar.google.com', isAi: false, info: 'Interdisziplinäre Suche nach wissenschaftlichen Texten.' },
        { id: 't7', name: 'EconLit', cats: ['Finders'], url: 'https://www.aeaweb.org/econlit', isAi: false, info: `EconLit ist eine Top-Datenbank für VWL.<ul><li>Aktuelle Journalartikel aus der VWL.</li><li>Suche in rund 750 Journals.</li><li>Qualitätsgeprüfte Forschung.</li></ul>`, isLib: true, isVwl: true },
        { id: 't7b', name: 'Swissdox', cats: ['Finders'], url: 'https://dbis.ur.de/ZHBLU/resources/103168', isAi: false, info: `Schweizer Presse.<ul><li>Schweizer Zeitungen & Magazine.</li><li>Zugriff auf NZZ, Luzerner Zeitung u. v. m.</li></ul>`, isLib: true },
        { id: 't7c', name: 'RePEc', cats: ['Finders'], url: 'https://dbis.ur.de/ZHBLU/resources/3286', isAi: false, info: `Research Papers in Economics.<ul><li>Working- und Discussion Papers gebündelt.</li><li>Qualität vor Nutzung prüfen, da oft ohne Peer-Review-Verfahren.</li></ul>`, isVwl: true },
        { id: 't7d', name: 'Web of Science Research Assistant', cats: ['Finders'], url: 'https://dbis.ur.de/ZHBLU/resources/360', isAi: true, isLib: true, info: 'KI-gestützter Rechercheassistent innerhalb von Web of Science.' },
        { id: 't7e', name: 'Business Source Premier', cats: ['Finders'], url: 'https://dbis.ur.de/ZHBLU/resources/1333', isAi: false, isLib: true, isBwl: true, info: 'Wirtschaftswissenschaftliche Datenbank mit Fachzeitschriften, Marktstudien und Firmenprofilen.' },
        { id: 't8', name: 'ResearchRabbit', cats: ['Connectors'], url: 'https://researchrabbit.ai', isAi: true, info: 'Zeigt Literaturbeziehungen und thematische Entwicklung als Netzwerk.' },
        { id: 't8b', name: 'Litmaps', cats: ['Connectors'], url: 'https://www.litmaps.com/', isAi: true, info: 'Erstellt interaktive Karten aus Zitier- und Themennetzwerken.' },
        { id: 't10', name: 'Explainpaper', cats: ['Analyzers'], url: 'https://www.explainpaper.com', isAi: true, info: 'Erklärt schwierige Passagen in wissenschaftlichen Artikeln.' },
        { id: 't16', name: 'ChatPDF', cats: ['Analyzers'], url: 'https://www.chatpdf.com/de', isAi: true, info: 'Beantwortet Fragen direkt zu hochgeladenen PDF-Dokumenten.' },
        { id: 't17', name: 'NotebookLM', cats: ['Analyzers'], url: 'https://notebooklm.google/', isAi: true, info: 'Arbeitsumgebung zum Strukturieren, Zusammenfassen und Verknüpfen von Quellen.' },
        { id: 't14', name: 'Paperpal', cats: ['Writers'], url: 'https://paperpal.com', isAi: true, info: 'Schreibassistenz für wissenschaftliche Texte mit Stil- und Sprachfeedback.' },
        { id: 't18', name: 'Zotero', cats: ['Organizers'], url: 'https://www.zotero.org', isAi: false, isLib: true, info: 'Open-Source-Literaturverwaltung zum Sammeln, Ordnen und Zitieren.' },
        { id: 't19', name: 'Citavi', cats: ['Organizers'], url: 'https://www.citavi.com', isAi: false, isLib: true, info: 'Literaturverwaltung mit Wissensorganisation und Aufgabenplanung.' },
        { id: 't20', name: 'Scite', cats: ['Evaluators', 'Finders'], url: 'https://scite.ai', isAi: true, info: 'Analysiert Zitierungen und zeigt, wie Studien eingeordnet werden.', isLib: true },
        { id: 't21', name: 'Consensus', cats: ['Evaluators', 'Finders'], url: 'https://consensus.app', isAi: true, info: 'Findet Studien und fasst den Forschungsstand zu Fragen zusammen.', isLib: true },
        { id: 't22', name: 'STW Thesaurus for Economics', cats: ['Keywords'], url: 'https://zbw.eu/stw/version/latest/about.de.html', isAi: false, info: 'Kontrolliertes Vokabular für wirtschaftswissenschaftliche Begriffe (ZBW).' },
        { id: 't23', name: 'Worttabelle', cats: ['Keywords'], url: 'https://www.pearltrees.com/poloek_ik/ankerpunkt-suchbegriffe-finden/id91277381/item759172325', isAi: false, info: 'Handout zur Sammlung von Keywords und Synonymen für die Recherche.' }
    ];

    const licensedDatabases = [
        { id: 'lic1', name: 'Academic Search Ultimate (EBSCOhost)', url: 'https://dbis.ur.de/ZHBLU/resources/101844', info: 'Multidisziplinäre Volltextdatenbank mit mehr als 9 200 Zeitschriften (über 8 400 peer-reviewed), zahlreichen Magazinen und rund 60 000 Videos seit 1930', cats: ['Finders'], isLib: true },
        { id: 'lic2', name: 'Blackwell Reference Online', url: 'https://dbis.ur.de/ZHBLU/resources/7081', info: 'Sammlung von Referenzwerken aus den Geistes- und Sozialwissenschaften (z. B. Classics, History, Language & Linguistics, Philosophy & Religion, Sociology & Anthropology)', cats: ['Finders'], isLib: true },
        { id: 'lic3', name: 'Business Source Premier', url: 'https://dbis.ur.de/ZHBLU/resources/1333', info: 'Wirtschaftswissenschaftliche Datenbank mit Volltexten aus mehr als 2 200 Zeitschriften und Magazinen, Firmenprofilen, Marktstudien und SWOT-Analysen.', cats: ['Finders'], isLib: true, isBwl: true },
        { id: 'lic4', name: 'CEPR Discussion Papers', url: 'https://dbis.ur.de/ZHBLU/resources/12587', info: 'Working-Paper-Reihe des Centre for Economic Policy Research, in der renommierte Ökonominnen und Ökonomen aktuelle Forschungsarbeiten publizieren.', cats: ['Finders'], isLib: true, isOA: true, isVwl: true },
        { id: 'lic6', name: 'EconLit', url: 'https://dbis.ur.de/ZHBLU/resources/36', info: `EconLit ist eine Top-Datenbank für VWL.<ul><li>Aktuelle Journalartikel aus der VWL.</li><li>Suche in rund 750 Journals.</li><li>Qualitätsgeprüfte Forschung.</li></ul>`, cats:['Finders'], isLib: true, isVwl: true },
        { id: 'lic7', name: 'Encyclopedia of Health Economics', url: 'https://dbis.ur.de/ZHBLU/resources/100301', info: 'Dreibändiges Nachschlagewerk über Gesundheitsökonomie, das ökonomische Analysen des Gesundheitssystems, der Gesundheitsversorgung und -politik bietet.', cats: ['Finders'], isLib: true },
        { id: 'lic8', name: 'Factiva', url: 'https://dbis.ur.de/ZHBLU/resources/4042', info: 'Dow-Jones-Datenbank für internationale Nachrichten und Wirtschaftsinformationen mit Presseartikeln, Nachrichtendiensten und Unternehmensmeldungen.', cats: ['Finders'], isLib:true },
        { id: 'lic9', name: 'International Bibliography of the Social Sciences (IBSS)', url: 'https://dbis.ur.de/ZHBLU/resources/1030', info: 'Bibliografische Datenbank von ProQuest, die internationale Literatur aus Soziologie, Politikwissenschaft, Wirtschaft und Anthropologie verzeichnet.', cats: ['Finders'], isLib: true },
        { id: 'lic10', name: 'International Encyclopedia of the Social & Behavioral Sciences (2. Ausgabe)', url: 'https://dbis.ur.de/ZHBLU/resources/100776', info: 'Umfassende Enzyklopädie der Sozial- und Verhaltenswissenschaften; Beiträge renommierter Forschender erklären Grundlagen, Theorien und Methoden.', cats: ['Finders'], isLib: true },
        { id: 'lic12', name: 'JSTOR Journals', url: 'https://dbis.ur.de/ZHBLU/resources/8957', info: 'Digitales Archiv, das Volltext-Backfiles wissenschaftlicher Zeitschriften aus den Geistes-, Sozial- und Naturwissenschaften bereitstellt.', cats: ['Finders'], isLib: true },
        { id: 'lic15', name: 'LinkedIn Learning', url: 'https://dbis.ur.de/ZHBLU/resources/103054', info: 'Lernplattform mit Videokursen zu Business-, Technologie- und Kreativthemen, moderiert von Branchenexpertinnen und -experten.', cats: ['Finders'], isLib: true },
        { id: 'lic16', name: 'Munzinger Online / Länder', url: 'https://dbis.ur.de/ZHBLU/resources/2165', info: 'Deutsches Nachschlagewerk mit Länderprofilen, aktuellen Daten und Hintergrundinformationen zu Staaten, Organisationen und Persönlichkeiten.', cats: ['Finders'], isLib: true },
        { id: 'lic17', name: 'NBER Papers', url: 'https://dbis.ur.de/ZHBLU/resources/9453', info: 'Veröffentlichungsreihe des National Bureau of Economic Research, die aktuelle ökonomische Forschungsergebnisse vorab zugänglich macht.', cats: ['Finders'], isLib: true, isVwl: true },
        { id: 'lic18', name: 'New Palgrave Dictionary of Economics', url: 'https://dbis.ur.de/ZHBLU/resources/8045', info: 'Enzyklopädisches Wörterbuch der Ökonomie mit Artikeln zu wirtschaftstheoretischen Konzepten, Methoden und ökonomischen Schulen.', cats: ['Finders'], isLib: true },
        { id: 'lic19', name: 'New York Times / ProQuest Historical Newspapers', url: 'https://dbis.ur.de/ZHBLU/resources/101464', info: 'Bietet digitalisierte Ausgaben der New York Times ab 1851 – nützlich für wirtschaftshistorische Recherchen.', cats: ['Finders'], isLib: true },
        { id: 'lic20', name: 'Nexis Uni', url: 'https://dbis.ur.de/ZHBLU/resources/1670', info: 'Rechercheplattform von LexisNexis mit Nachrichtenquellen, Rechtsfällen, Unternehmensdaten und juristischen Fachartikeln für die Hochschullehre.', cats: ['Finders'], isLib: true },
        { id: 'lic21', name: 'Orbis – weltweite Unternehmensdaten', url: 'https://dbis.ur.de/ZHBLU/resources/100120', info: 'Unternehmensdatenbank von Bureau van Dijk mit Finanzdaten, Beteiligungsstrukturen und Vergleichskennzahlen für Millionen Firmen weltweit.', cats: ['Finders'], isLib: true },
        { id: 'lic22', name: 'Oxford Reference', url: 'https://dbis.ur.de/ZHBLU/resources/3107', info: 'Sammlung von Wörterbüchern und Enzyklopädien der Oxford University Press zu verschiedenen Fachgebieten.', cats: ['Finders'], isLib: true },
        { id: 'lic23', name: 'Oxford Research Encyclopedia – Global Public Health', url: 'https://dbis.ur.de/ZHBLU/resources/105738', info: 'Begutachtete Forschungsenzyklopädie mit Artikeln über globale Gesundheitspolitik, Prävention, Epidemiologie und Gesundheitsversorgung.', cats: ['Finders'], isLib: true },
        { id: 'lic24', name: 'Oxford Research Encyclopedia – Climate Science', url: 'https://dbis.ur.de/ZHBLU/resources/103364', info: 'Online-Enzyklopädie mit wissenschaftlichen Übersichtsartikeln zu Klimaforschung, Klimawandel, Klimapolitik und Resilienz.', cats: ['Finders'], isLib: true },
        { id: 'lic25', name: 'Periodicals Archive Online', url: 'https://dbis.ur.de/ZHBLU/resources/7828', info: 'Archiv mit den Rückläufen von über 700 Zeitschriften der Geistes- und Sozialwissenschaften (mehr als 3 Mio. Artikel und 15 Mio. Seiten)', cats: ['Finders'], isLib: true },
        { id: 'lic26', name: 'Policy Commons', url: 'https://dbis.ur.de/ZHBLU/resources/105297', info: 'Plattform, die über 3 Mio. Publikationen von Politikexpertinnen, Think Tanks, IGOs und NGOs systematisch auffindbar macht', cats: ['Finders'], isLib: true },
        { id: 'lic27', name: 'ScienceDirect', url: 'https://dbis.ur.de/ZHBLU/resources/801', info: 'Elsevier-Plattform mit elektronischen Zeitschriften und eBooks; sie ermöglicht simultane oder getrennte Suche und Volltextzugriff je nach Lizenz', cats: ['Finders'], isLib: true },
        { id: 'lic28', name: 'Scite', url: 'https://dbis.ur.de/ZHBLU/resources/104874', info: 'KI-gestützte Zitationsdatenbank, die den Kontext von Zitierungen analysiert und Zitate als unterstützend, widersprechend oder erwähnend klassifiziert', cats: ['Evaluators', 'Finders'], isLib: true, isAi: true },
        { id: 'lic29', name: 'Statista', url: 'https://dbis.ur.de/ZHBLU/resources/9808', info: 'Statistikportal, das Daten aus zahlreichen Instituten und Quellen bündelt; der Volltextzugriff richtet sich nach dem Lizenzumfang der Einrichtung.', cats: ['Finders'], isLib: true },
        { id: 'lic31', name: 'UN iLibrary', url: 'https://dbis.ur.de/ZHBLU/resources/101214', info: 'Bibliothek der Vereinten Nationen mit Büchern, Zeitschriften, Arbeitspapieren und Statistiken zu UN-Themen in verschiedenen Sprachen.', cats: ['Finders'], isLib: true },
        { id: 'lic32', name: 'WEKA Business Portal', url: 'https://dbis.ur.de/ZHBLU/resources/8661', info: 'Praxisorientiertes Informationsportal der WEKA-Verlagsgruppe mit Fachinformationen, Vorlagen und eLearning-Materialien zu Recht, Steuern und Unternehmensführung.', cats: ['Finders'], isLib: true },
        { id: 'lic33', name: 'Web of Science / Social Sciences Citation Index', url: 'https://dbis.ur.de/ZHBLU/resources/360', info: 'Aufsatzdatenbank, die mehr als 3,45 Mio. Titel nachweist und Beiträge aus über 50 Sozial- und Nachbardisziplinen auswertet', cats: ['Finders'], isLib: true },
        { id: 'lic34', name: 'Web of Science Core Collection', url: 'https://dbis.ur.de/ZHBLU/resources/2142', info: 'Multidisziplinäre Zitationsdatenbank mit Informationen aus Tausenden wissenschaftlicher Zeitschriften, Büchern und Konferenzen', cats: ['Finders'], isLib: true },
        { id: 'lic35', name: 'Wiley Online Library', url: 'https://dbis.ur.de/ZHBLU/resources/838', info: 'Plattform des Wiley-Verlags mit über 1 500 Fachzeitschriften und mehr als 20 000 eBooks aus den Natur-, Gesundheits- und Sozialwissenschaften', cats: ['Finders'], isLib: true },
        { id: 'lic37', name: 'wiso', url: 'https://dbis.ur.de/ZHBLU/resources/1232', info: 'Deutschsprachige Plattform mit Literaturhinweisen, E-Books und Fachzeitschriften zu Wirtschaft und Sozialwissenschaften; ergänzt um Module zur Betriebswirtschaftspraxis, Lecturio-Erklärvideos und das Statistikportal Tilasto', cats: ['Finders'], isLib: true },
        { id: 'lic38', name: 'Statistical Portal OECD Data Explorer', url: 'https://dbis.ur.de/ZHBLU/resources/106121', info: 'Interaktive Plattform der OECD, mit der sich sozioökonomische Kennzahlen verschiedener Länder vergleichen und visualisieren lassen.', cats: ['Finders'], isLib: true, isOA: true },
        { id: 'lic39', name: 'RePEc', url: 'https://dbis.ur.de/ZHBLU/resources/3286', info: `Research Papers in Economics.<ul><li>Working- und Discussion Papers gebündelt.</li><li>Qualität vor Nutzung prüfen, da oft ohne Peer-Review-Verfahren.</li></ul>`, cats: ['Finders'], isLib: true, isOA: true, isVwl: true },
        { id: 'lic40', name: 'Swissdox', url: 'https://dbis.ur.de/ZHBLU/resources/103168', info: 'Presse- und Medienarchiv mit Schweizer Tages-, Wochen- und Sonntagszeitungen sowie Magazinen für aktuelle wirtschaftspolitische Analysen.', cats: ['Finders'], isLib: true },
        { id: 'lic41', name: 'The Economist', url: 'https://www.pressreader.com/de/magazines/m/the-economist-eu', info: 'Digitale Magazin-Ausgabe von The Economist über PressReader; nützlich für wirtschaftspolitische Kommentare und Hintergrundberichte.', cats: ['Finders'], isLib: true, isVwl: true },
        { id: 'lic42', name: 'Consensus', url: 'https://dbis.ur.de/ZHBLU/resources/104879', info: 'KI-gestütztes Tool zur Suche nach wissenschaftlichem Konsens in Studien.', cats: ['Evaluators', 'Finders'], isLib: true, isAi: true },
        { id: 'lic43', name: 'Eurostat', url: 'https://dbis.ur.de/ZHBLU/resources/3364', info: 'Statistikportal der EU mit amtlichen Daten zu Wirtschaft, Gesellschaft und Umwelt.', cats: ['Finders'] },
        { id: 'lic44', name: 'Finaneon', url: 'https://dbis.ur.de/ZHBLU/resources/12584', info: 'Datenbank und Lernplattform für Finanzwissen, Märkte und Unternehmensdaten.', cats: ['Finders'], isLib: true },
        { id: 'lic45', name: 'International Monetary Fund eLibrary', url: 'https://dbis.ur.de/ZHBLU/resources/11303', info: 'Publikationsplattform des IWF mit Reports, Working Papers und Datensammlungen.', cats: ['Finders'] },
        { id: 'lic46', name: 'OECD', url: 'https://dbis.ur.de/ZHBLU/resources/10320', info: 'Zugang zu OECD-Publikationen, Berichten und statistischen Ressourcen.', cats: ['Finders'] },
        { id: 'lic47', name: 'SSRN', url: 'https://www.ssrn.com/ssrn/', info: 'Repository für Working Papers und Preprints aus Wirtschafts- und Sozialwissenschaften.', cats: ['Finders'] },
        { id: 'lic48', name: 'World DataBank', url: 'https://dbis.ur.de/ZHBLU/resources/5685', info: 'Datenplattform der Weltbank mit internationalen Indikatoren und Ländervergleichen.', cats: ['Finders'] }
    ].map(db => ({ isOA: false, ...db })).sort((a, b) => a.name.localeCompare(b.name, "de"));

    const LEGACY_CATEGORY_MAP = { 'Verwaltung': 'Organizers' };
    const dropTargets = ['phase-1', 'phase-2', 'phase-3', 'phase-5', 'phase-6'];
    const CUSTOM_TOOLS_KEY = 'customTools';
    const MAX_IMPORT_FILE_SIZE_BYTES = 2 * 1024 * 1024;
    const ORIENTATION_HIGHLIGHT_CLASS = 'orientation-highlight';

    let textModal = null;
    let orientationModal = null;
    let orientationFocusTrapCleanup = null;
    let lastFocusedElement = null;
    let targetPhaseForNote = null;
    let currentEditingNoteId = null;
    let defaultNoteModalTitle = '';
    let deletedTools = [];
    let currentSearchTerm = '';
    let currentCategoryFilter = '';
    let currentEditingCustomToolId = null;
    let toastContainer = null;

    // === HELPERS ===
    function normalizeCategoriesList(cats) {
        const mapped = (Array.isArray(cats) ? cats : [])
            .map(cat => LEGACY_CATEGORY_MAP[cat] || cat)
            .filter(Boolean)
            .filter(cat => cat !== 'Lizenziert');
        return mapped.length ? mapped : ['Organizers'];
    }

    function deriveCategoriesForTool(toolData = {}) {
        const normalizedCats = normalizeCategoriesList(toolData.cats);
        return Array.from(new Set(normalizedCats));
    }

    function orderCategoriesForDisplay(categoriesList, preferredCategory) {
        const uniqueCategories = Array.from(new Set(categoriesList || []));
        if(preferredCategory && uniqueCategories.includes(preferredCategory)) {
            return [preferredCategory, ...uniqueCategories.filter(cat => cat !== preferredCategory)];
        }
        return uniqueCategories;
    }

    function getFilterableCategories() {
        return Object.keys(categories)
            .filter(catKey => !HIDDEN_CATEGORIES.includes(catKey));
    }

    function escapeHtml(str) {
        if(!str) return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function normalizeName(name) {
        return (name || '').toLowerCase().replace(/[_\s]+$/, '').trim();
    }

    function isCustomToolData(toolData) {
        return !!(toolData && (toolData.isCustom === true || toolData.isCustom === 'true' || toolData.isCustom === 1 || toolData.isCustom === '1'));
    }

    function sanitizeTooltipHtml(content) {
        if(!content) return '';
        const temp = document.createElement('div');
        temp.innerHTML = content;
        const allowedTags = ['B', 'STRONG', 'EM', 'I', 'BR', 'P', 'UL', 'OL', 'LI'];
        temp.querySelectorAll('*').forEach(el => {
            if(!allowedTags.includes(el.tagName)) {
                el.replaceWith(document.createTextNode(el.textContent));
            } else {
                Array.from(el.attributes).forEach(attr => el.removeAttribute(attr.name));
            }
        });
        return temp.innerHTML;
    }

    function stripHtml(content) {
        if(!content) return '';
        const temp = document.createElement('div');
        temp.innerHTML = content;
        return temp.textContent || temp.innerText || '';
    }

    function sanitizeToolData(toolData) {
        const normalizedCats = toolData.type === 'text'
            ? ((toolData.cats && toolData.cats.length) ? normalizeCategoriesList(toolData.cats) : ['Notizen'])
            : deriveCategoriesForTool(toolData);
        return {
            id: toolData.id || toolData.uniqueId || ('restored-' + Date.now()),
            name: toolData.name || 'Unbenanntes Tool',
            cats: normalizedCats,
            url: toolData.url || '#',
            info: toolData.info || 'Gelöscht',
            isAi: !!toolData.isAi,
            isLib: !!toolData.isLib,
            isOA: !!toolData.isOA,
            isVwl: !!toolData.isVwl,
            isBwl: !!toolData.isBwl,
            isCustom: !!toolData.isCustom,
            type: toolData.type || 'tool',
            text: toolData.text || ''
        };
    }

    function trapFocusWithin(modalEl) {
        if(!modalEl) return () => {};
        const selectors = ['a[href]', 'button:not([disabled])', 'textarea:not([disabled])', 'input:not([disabled])', 'select:not([disabled])', '[tabindex]:not([tabindex="-1"])'];
        const focusable = Array.from(modalEl.querySelectorAll(selectors.join(',')))
            .filter(el => el.offsetParent !== null && !el.hasAttribute('aria-hidden'));

        if(!focusable.length) return () => {};

        const first = focusable[0];
        const last = focusable[focusable.length - 1];

        const handleKeydown = (event) => {
            if(event.key === 'Tab') {
                if(event.shiftKey && document.activeElement === first) {
                    event.preventDefault();
                    last.focus();
                } else if(!event.shiftKey && document.activeElement === last) {
                    event.preventDefault();
                    first.focus();
                }
            }

            if(event.key === 'Escape') {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if(modalInstance) modalInstance.hide();
            }
        };

        modalEl.addEventListener('keydown', handleKeydown);
        requestAnimationFrame(() => first.focus());

        return () => modalEl.removeEventListener('keydown', handleKeydown);
    }

    const orientationOnboardingSteps = {
        drag: ['.hangar-area', '.phase-col'],
        export: ['#flightControlsButton', '#savePdfButton', '#exportJsonButton', '#importJsonButton']
    };

    function clearOrientationHighlights() {
        document.querySelectorAll('.' + ORIENTATION_HIGHLIGHT_CLASS).forEach(el => {
            el.classList.remove(ORIENTATION_HIGHLIGHT_CLASS);
            el.removeAttribute('data-onboarding-step');
        });
    }

    function applyOnboardingStep(stepKey) {
        clearOrientationHighlights();
        const targets = orientationOnboardingSteps[stepKey];
        if(!targets) return;
        let firstHighlighted = null;
        targets.forEach(selector => {
            document.querySelectorAll(selector).forEach(el => {
                if(!firstHighlighted) firstHighlighted = el;
                el.classList.add(ORIENTATION_HIGHLIGHT_CLASS);
                el.setAttribute('data-onboarding-step', stepKey);
            });
        });
        if(firstHighlighted && typeof firstHighlighted.scrollIntoView === 'function') {
            firstHighlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function buildToolDataFromCard(cardEl) {
        if(!cardEl) return null;
        const cats = cardEl.dataset.cats ? cardEl.dataset.cats.split('|').filter(Boolean) : [];
        return {
            id: cardEl.dataset.baseId || cardEl.id,
            name: cardEl.dataset.name || (cardEl.querySelector('.fw-bold') ? cardEl.querySelector('.fw-bold').innerText : 'Tool'),
            info: cardEl.dataset.info || '',
            url: cardEl.dataset.url || '#',
            cats: cats.length ? cats : ['Organizers'],
            isAi: cardEl.dataset.isAi === '1' || cardEl.dataset.isAi === 'true',
            isLib: cardEl.dataset.isLib === '1' || cardEl.dataset.isLib === 'true',
            isOA: cardEl.dataset.isOa === '1' || cardEl.dataset.isOa === 'true',
            isVwl: cardEl.dataset.isVwl === '1' || cardEl.dataset.isVwl === 'true',
            isBwl: cardEl.dataset.isBwl === '1' || cardEl.dataset.isBwl === 'true',
            isCustom: cardEl.dataset.isCustom === '1' || cardEl.dataset.isCustom === 'true',
            type: cardEl.dataset.type || 'tool',
            text: cardEl.dataset.text || '',
            uniqueId: cardEl.id
        };
    }

    function startNoteEditing(noteElement) {
        if(!noteElement) return;
        const parentId = noteElement.parentElement ? noteElement.parentElement.id : null;
        openTextModal(parentId, noteElement);
    }

    function handleCardRemoval(cardEl) {
        if(!cardEl) return;
        const parent = cardEl.parentElement;
        const origin = parent && dropTargets.includes(parent.id) ? 'cockpit' : 'hangar';
        const toolData = buildToolDataFromCard(cardEl);
        if(!toolData) return;

        cardEl.remove();


        if(origin === 'cockpit') {
            if(toolData.type === 'text') {
                addToDeleted(toolData);
                showToast("Notiz entfernt (in 'Gelöschte Tools & Notizen' wiederherstellbar).", 'info');
            } else {
                showToast('Tool entfernt.', 'info');
            }
            saveState();
            return;
        } else {
            if(toolData.isCustom) {
                const index = initialTools.findIndex(t => t.id === toolData.id);
                if(index >= 0) initialTools.splice(index, 1);
                document.querySelectorAll(`[data-base-id="${toolData.id}"]`).forEach(el => {
                    if(el !== cardEl) el.remove();
                });
                saveCustomTools();
            }
            addToDeleted(toolData);
        }

        showToast("Tool entfernt (in 'Gelöschte Tools & Notizen' wiederherstellbar).", 'info');
    }

    // === TOASTS ===
    function getToastContainer() {
        if(toastContainer && document.body.contains(toastContainer)) return toastContainer;

        let container = document.getElementById('toast-container');
        if(!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container no-print';
            container.setAttribute('aria-live', 'polite');
            container.setAttribute('aria-atomic', 'true');
            document.body.appendChild(container);
        }

        toastContainer = container;
        return container;
    }

    function removeToastElement(toastEl) {
        if(!toastEl) return;
        toastEl.classList.remove('show');
        setTimeout(() => {
            if(toastEl && toastEl.parentElement) {
                toastEl.parentElement.removeChild(toastEl);
            }
        }, 180);
    }

    function showToast(message, type = 'info', timeoutMs = 3000) {
        const container = getToastContainer();
        const normalizedType = ['success', 'info', 'error'].includes(type) ? type : 'info';
        const safeMessage = typeof message === 'string' ? message : String(message ?? '');

        const toastEl = document.createElement('div');
        toastEl.className = `toast-item toast-${normalizedType}`;
        toastEl.setAttribute('role', normalizedType === 'error' ? 'alert' : 'status');
        toastEl.setAttribute('aria-live', normalizedType === 'error' ? 'assertive' : 'polite');
        toastEl.setAttribute('aria-label', `${normalizedType === 'error' ? 'Fehler' : 'Hinweis'}: ${safeMessage}`);
        toastEl.tabIndex = 0;

        const iconMap = { success: 'fa-circle-check', info: 'fa-circle-info', error: 'fa-triangle-exclamation' };
        const titleMap = { success: 'Erfolg', info: 'Hinweis', error: 'Fehler' };

        const icon = document.createElement('div');
        icon.className = 'toast-icon';
        icon.innerHTML = `<i class="fas ${iconMap[normalizedType]}"></i>`;

        const contentWrap = document.createElement('div');
        contentWrap.className = 'toast-content';

        const titleEl = document.createElement('div');
        titleEl.className = 'toast-title';
        titleEl.textContent = titleMap[normalizedType];

        const messageEl = document.createElement('div');
        messageEl.className = 'toast-message';
        messageEl.textContent = safeMessage;

        contentWrap.appendChild(titleEl);
        contentWrap.appendChild(messageEl);

        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'toast-close';
        closeBtn.setAttribute('aria-label', 'Toast schließen');
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';

        let hideTimer = null;
        const safeTimeout = Number.isFinite(timeoutMs) && timeoutMs > 0 ? timeoutMs : 3000;
        hideTimer = setTimeout(() => removeToastElement(toastEl), safeTimeout);

        closeBtn.addEventListener('click', () => {
            if(hideTimer) clearTimeout(hideTimer);
            removeToastElement(toastEl);
        });

        toastEl.addEventListener('pointerenter', () => {
            if(hideTimer) {
                clearTimeout(hideTimer);
                hideTimer = null;
            }
        });

        toastEl.addEventListener('pointerleave', () => {
            if(!hideTimer && safeTimeout > 0) {
                hideTimer = setTimeout(() => removeToastElement(toastEl), safeTimeout);
            }
        });

        toastEl.addEventListener('keydown', (event) => {
            if(event.key === 'Escape') {
                removeToastElement(toastEl);
            }
        });

        toastEl.appendChild(icon);
        toastEl.appendChild(contentWrap);
        toastEl.appendChild(closeBtn);
        container.appendChild(toastEl);

        requestAnimationFrame(() => toastEl.classList.add('show'));
        return toastEl;
    }

    // === GELÖSCHTE ELEMENTE ===
    function renderDeletedList() {
        const container = document.getElementById('deleted-list');
        if(!container) return;

        if(!deletedTools.length) {
            container.className = 'deleted-empty';
            container.textContent = 'Noch nichts gelöscht';
            return;
        }

        container.className = '';
        container.innerHTML = '';

        deletedTools.forEach((tool, index) => {
            const item = document.createElement('div');
            item.className = 'deleted-item';

            const infoWrapper = document.createElement('div');
            const titleEl = document.createElement('div');
            titleEl.className = 'fw-bold';
            titleEl.textContent = tool.name;

            const metaEl = document.createElement('div');
            metaEl.className = 'meta';
            metaEl.textContent = tool.type === 'text'
                ? (tool.text ? tool.text.slice(0, 80) : 'Notiz')
                : (tool.cats || []).join(', ');

            infoWrapper.appendChild(titleEl);
            infoWrapper.appendChild(metaEl);
            item.appendChild(infoWrapper);

            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'btn btn-sm btn-outline-success';
            restoreBtn.innerHTML = '<i class="fas fa-undo"></i>';
            restoreBtn.setAttribute('data-bs-toggle', 'tooltip');
            restoreBtn.setAttribute('data-bs-title', 'Tool zurück in den Hangar');
            restoreBtn.setAttribute('aria-label', `Tool wiederherstellen: ${tool.name}`);
            restoreBtn.addEventListener('click', () => restoreDeletedTool(index));

            item.appendChild(restoreBtn);
            container.appendChild(item);
        });

        initTooltips(container);
    }

    function saveDeletedState() {
        localStorage.setItem('cockpitDeleted_v1', JSON.stringify(deletedTools));
    }

    function loadDeletedState() {
        const stored = localStorage.getItem('cockpitDeleted_v1');
        if(stored) {
            deletedTools = JSON.parse(stored);
        }
        renderDeletedList();
    }

    function addToDeleted(toolData) {
        const sanitized = sanitizeToolData(toolData);
        deletedTools = [sanitized, ...deletedTools.filter(t => !(t.id === sanitized.id && t.name === sanitized.name))].slice(0, 25);
        saveDeletedState();
        renderDeletedList();
    }

    function restoreDeletedTool(index) {
        const tool = deletedTools.splice(index, 1)[0];
        if(!tool) return;

        if(tool.type === 'text' && (!tool.cats || !tool.cats.length)) {
            tool.cats = ['Notizen'];
        }

        if(!initialTools.find(t => t.id === tool.id)) {
            initialTools.push(tool);
        }

        renderHangar();
        saveDeletedState();
        renderDeletedList();
    }

    function restoreAllDeleted() {
        if(!deletedTools.length) return;

        deletedTools.forEach(tool => {
            if(tool.type === 'text' && (!tool.cats || !tool.cats.length)) {
                tool.cats = ['Notizen'];
            }
            if(!initialTools.find(t => t.id === tool.id)) {
                initialTools.push(tool);
            }
        });

        deletedTools = [];
        renderHangar();
        saveDeletedState();
        renderDeletedList();
    }

    // === RENDERING ===
    function renderHangar() {
        const pool = document.getElementById('tool-pool');
        if(!pool) return;
        pool.innerHTML = '';

        const searchTerm = currentSearchTerm;
        const selectedCategory = currentCategoryFilter;

        Object.entries(flightPhases).forEach(([phaseName, meta]) => {
            const phaseCategories = meta.categories || [];
            const categoriesWithTools = [];

            phaseCategories.forEach(catKey => {
                const catTools = initialTools.filter(tool => {
                    const toolCategories = deriveCategoriesForTool(tool);
                    const hasCategory = toolCategories.includes(catKey);
                    if(!hasCategory) return false;

                    const matchesCategoryFilter = !selectedCategory
                        || toolCategories.includes(selectedCategory);
                    if(!matchesCategoryFilter) return false;

                    if(!searchTerm) return true;

                    const haystack = `${tool.name || ''} ${tool.info || ''} ${toolCategories.join(' ')}`.toLowerCase();
                    return haystack.includes(searchTerm);
                });

                if(catTools.length) {
                    catTools.sort((a, b) => (a.name || '').localeCompare((b.name || ''), 'de', { sensitivity: 'base' }));
                    categoriesWithTools.push({ catKey, catTools });
                }
            });

            if(!categoriesWithTools.length) return;

            const phaseHeader = document.createElement('h5');
            phaseHeader.className = 'mt-3 mb-2 d-flex align-items-center text-primary';
            const iconClass = (meta && meta.icon) ? meta.icon : 'fa-plane';
            phaseHeader.innerHTML = `<i class="fas ${iconClass} me-2"></i> ${phaseName}`;
            pool.appendChild(phaseHeader);

            categoriesWithTools.forEach(({ catKey, catTools }) => {
                const header = document.createElement('div');
                header.className = 'cat-header';
                const catIcon = (categories[catKey] && categories[catKey].icon) ? categories[catKey].icon : 'fa-tools';
                header.innerHTML = `<i class="fas ${catIcon} me-2"></i> ${catKey}`;
                pool.appendChild(header);

                catTools.forEach(tool => {
                    const instanceId = `${tool.id}-${catKey}`;
                    const toolCategories = deriveCategoriesForTool(tool);
                    const displayCategories = orderCategoriesForDisplay(toolCategories, catKey);
                    const enhancedTool = { ...tool, cats: displayCategories, uniqueId: instanceId };
                    pool.appendChild(createToolElement(enhancedTool, 'hangar'));
                });
            });
        });

        initTooltips(pool);
    }

    function populateCategoryOptions() {
        const select = document.getElementById('customToolCategory');
        if(!select) return;

        select.innerHTML = '';

        Object.keys(categories)
            .filter(catKey => !HIDDEN_CATEGORIES.includes(catKey))
            .forEach(catKey => {
            const option = document.createElement('option');
            option.value = catKey;
            option.textContent = catKey;
            select.appendChild(option);
        });
    }

    function populateFilterOptions() {
        const menu = document.getElementById('toolCategoryMenu');
        const trigger = document.getElementById('toolCategoryDropdownButton');
        const labelEl = trigger ? trigger.querySelector('.category-label') : null;
        if(!menu || !trigger || !labelEl) return;

        const filterableCategories = getFilterableCategories();

        const createMenuItem = (catKey, label, info, iconClass = 'fa-filter') => {
            const li = document.createElement('li');
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'dropdown-item d-flex align-items-start gap-2';
            button.dataset.categoryValue = catKey;
            button.dataset.bsToggle = 'tooltip';
            button.dataset.bsPlacement = 'right';
            const safeLabel = escapeHtml(label);
            const safeInfo = escapeHtml(info || '');
            button.dataset.bsTitle = safeInfo;
            button.setAttribute('data-tooltip-content', stripHtml(safeInfo));
            button.innerHTML = `
                <i class="fas ${iconClass} text-primary mt-1"></i>
                <span class="text-start">
                    <span class="d-block fw-semibold">${safeLabel}</span>
                </span>
            `;
            button.addEventListener('click', () => setCategoryFilter(catKey));

            li.appendChild(button);
            menu.appendChild(li);
        };

        menu.innerHTML = '';
        createMenuItem('', 'Alle Kategorien', 'Zeigt alle verfügbaren Tools');

        filterableCategories.forEach(catKey => {
            const meta = categories[catKey] || {};
            const icon = meta.icon || 'fa-tools';
            const info = meta.info || '';
            createMenuItem(catKey, catKey, info, icon);
        });

        setCategoryFilter(currentCategoryFilter, { render: false });
        initTooltips(menu);
    }

    function setCategoryFilter(catKey, { render = true } = {}) {
        const trigger = document.getElementById('toolCategoryDropdownButton');
        const labelEl = trigger ? trigger.querySelector('.category-label') : null;
        if(!labelEl) return;

        const validCategories = getFilterableCategories();
        const normalizedCategory = validCategories.includes(catKey) ? catKey : '';

        currentCategoryFilter = normalizedCategory;
        labelEl.textContent = normalizedCategory || 'Alle Kategorien';

        if(render) {
            renderHangar();
        }
    }

    function populateLicensedDbSelect() {
        const select = document.getElementById('licensedDbSelect');
        if(!select) return;

        select.innerHTML = '';
        licensedDatabases.forEach(db => {
            const opt = document.createElement('option');
            opt.value = db.id;
            opt.textContent = db.name;
            select.appendChild(opt);
        });

        select.addEventListener('change', (e) => updateLicensedDbDetails(e.target.value));
        if(licensedDatabases.length) {
            select.value = licensedDatabases[0].id;
            updateLicensedDbDetails(licensedDatabases[0].id);
        }
    }

    function updateLicensedDbDetails(dbId) {
        const db = licensedDatabases.find(item => item.id === dbId);
        const titleEl = document.getElementById('licensedDbTitle');
        const descEl = document.getElementById('licensedDbDescription');
        const badgeEl = document.getElementById('licensedDbBadges');

        if(!db || !titleEl || !descEl || !badgeEl) return;

        titleEl.textContent = db.name;
        descEl.textContent = db.info || '';

        const badges = [];
        if(db.isLib) badges.push('<span class="status-badge badge-lib">Uni</span>');
        if(db.isAi) badges.push('<span class="status-badge badge-ai">KI</span>');
        if(db.isVwl) badges.push('<span class="status-badge badge-vwl">VWL</span>');
        if(db.isBwl) badges.push('<span class="status-badge badge-bwl">BWL</span>');
        badgeEl.innerHTML = badges.join(' ');
    }

    function addLicensedDatabase() {
        const select = document.getElementById('licensedDbSelect');
        if(!select || !select.value) return;

        const db = licensedDatabases.find(item => item.id === select.value);
        if(!db) return;

        const alreadyExists = initialTools.some(tool => normalizeName(tool.name) === normalizeName(db.name));
        if(alreadyExists) {
            alert('Diese Datenbank befindet sich bereits im Hangar.');
            return;
        }

        const baseCats = db.cats && db.cats.length ? db.cats : ['Finders'];
        const normalizedDb = { ...db, isLib: true, cats: baseCats, isOA: !!db.isOA, isVwl: !!db.isVwl, isBwl: !!db.isBwl };
        const enhancedCats = deriveCategoriesForTool(normalizedDb);
        initialTools.push({ ...normalizedDb, cats: enhancedCats });
        renderHangar();

        const modalEl = document.getElementById('licensedDbModal');
        if(modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
        }
    }

    function createToolElement(toolData, origin) {
        const div = document.createElement('div');
        let classes = 'tool-card';
        if(toolData.isAi) classes += ' is-ai';
        if(toolData.isLib) classes += ' is-library';
        if(toolData.name === 'ChatGPT') classes += ' tool-card--chatgpt';

        div.className = classes;
        div.draggable = true;

        const isText = toolData.type === 'text';
        const categoriesForTool = isText
            ? ((toolData.cats && toolData.cats.length) ? normalizeCategoriesList(toolData.cats) : ['Notizen'])
            : deriveCategoriesForTool(toolData);

        const uniqueId = toolData.uniqueId
            || (origin === 'hangar'
                ? toolData.id
                : 'c-' + Date.now() + Math.random().toString(16).slice(2));
        div.id = uniqueId;
        div.dataset.baseId = toolData.id;
        div.dataset.type = toolData.type || 'tool';
        div.dataset.name = toolData.name || '';
        div.dataset.info = toolData.info || '';
        div.dataset.url = toolData.url || '';
        div.dataset.cats = Array.isArray(categoriesForTool) ? categoriesForTool.join('|') : '';
        div.dataset.isAi = toolData.isAi ? '1' : '0';
        div.dataset.isLib = toolData.isLib ? '1' : '0';
        div.dataset.isOa = toolData.isOA ? '1' : '0';
        div.dataset.isVwl = toolData.isVwl ? '1' : '0';
        div.dataset.isBwl = toolData.isBwl ? '1' : '0';
        div.dataset.isCustom = isCustomToolData(toolData) ? '1' : '0';
        if(toolData.text) {
            div.dataset.text = toolData.text;
        }

        div.tabIndex = 0;

        const primaryCat = Array.isArray(categoriesForTool) && categoriesForTool.length ? categoriesForTool[0] : null;
        const iconClass = (primaryCat && categories[primaryCat] && categories[primaryCat].icon) ? categories[primaryCat].icon : 'fa-tools';

            if(isText) {
                const displayText = escapeHtml(toolData.text || toolData.info || '').replace(/\n/g, '<br>');
                const displayTitle = escapeHtml(toolData.name || 'Notiz');
                div.innerHTML = `
                    <div class="tool-icon"><i class="fas fa-note-sticky"></i></div>
                <div class="flex-grow-1 tool-card-body">
                    <div class="d-flex tool-title-row">
                        <div class="fw-bold tool-title note-title">${displayTitle}</div>
                        <button type="button" class="edit-custom-btn edit-note-btn" data-bs-toggle="tooltip" data-bs-title="Notiz bearbeiten">
                            <i class="fas fa-pen"></i>
                        </button>
                    </div>
                    <div class="small text-muted text-wrap note-body-text">${displayText || 'Kein Text hinterlegt'}</div>
                </div>
                <span class="status-badge badge bg-light text-muted border">Notiz</span>
            `;

            const editNoteBtn = div.querySelector('.edit-note-btn');
            if(editNoteBtn) {
                editNoteBtn.setAttribute('aria-label', 'Notiz bearbeiten');
                editNoteBtn.setAttribute('draggable', 'false');
                editNoteBtn.addEventListener('mousedown', (event) => event.stopPropagation());
                editNoteBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    startNoteEditing(div);
                });
            }
        } else {
            const allowEdit = isCustomToolData(toolData) && origin === 'cockpit';
            const statusBadges = `
                ${toolData.isAi ? '<span class="status-badge badge-ai">KI</span>' : ''}
                ${toolData.isLib ? '<span class="status-badge badge-lib">Uni</span>' : ''}
                ${toolData.isVwl ? '<span class="status-badge badge-vwl">VWL</span>' : ''}
                ${toolData.isBwl ? '<span class="status-badge badge-bwl">BWL</span>' : ''}
            `;

            const categoryList = Array.isArray(categoriesForTool) && categoriesForTool.length
                ? escapeHtml(categoriesForTool.join(', '))
                : 'Allgemein';

            const safeName = escapeHtml(toolData.name || 'Unbenanntes Tool');
            const rawInfo = toolData.info || '';
            const tooltipHtml = sanitizeTooltipHtml(rawInfo);
            const safeUrl = escapeHtml(toolData.url || '#');
            const infoLabel = `Zusatzinformation zu ${safeName}`;

            div.innerHTML = `
                <div class="tool-icon"><i class="fas ${iconClass}"></i></div>
                <div class="flex-grow-1 tool-card-body">
                    <div class="d-flex tool-title-row">
                        <div class="fw-bold tool-title">${safeName}</div>
                        <div class="tool-badges">${statusBadges}</div>
                    </div>
                    <div class="small text-muted tool-category">${categoryList}</div>
                </div>
                <button type="button" class="tool-info-btn tool-info-icon" data-bs-toggle="tooltip" aria-label="${infoLabel}">
                    <i class="fas fa-info-circle"></i>
                </button>
                ${allowEdit ? '<button type="button" class="edit-custom-btn" data-bs-toggle="tooltip" data-bs-title="Bearbeiten"><i class="fas fa-pen"></i></button>' : ''}
                <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="tool-link" onclick="event.stopPropagation()" data-bs-toggle="tooltip" data-bs-title="Tool öffnen" aria-label="Tool öffnen: ${safeName}">
                    <i class="fas fa-external-link-alt"></i>
                </a>
            `;

            const infoIcon = div.querySelector('.tool-info-icon');
            if(infoIcon) {
                const tooltipText = stripHtml(tooltipHtml).trim();
                infoIcon.setAttribute('data-bs-title', tooltipHtml);
                infoIcon.setAttribute('data-tooltip-content', tooltipText);
                infoIcon.setAttribute('data-bs-html', 'true');
                infoIcon.setAttribute('data-bs-placement', 'top');
            }

            if(allowEdit) {
                const editBtn = div.querySelector('.edit-custom-btn');
                if(editBtn) {
                    editBtn.setAttribute('aria-label', 'Eigenes Tool bearbeiten');
                    editBtn.setAttribute('draggable', 'false');
                    editBtn.addEventListener('mousedown', (event) => event.stopPropagation());
                    editBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        openCustomToolEditor({ ...toolData, cats: categoriesForTool, uniqueId });
                    });
                }
            }
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'tool-remove-btn';
        removeBtn.setAttribute('data-bs-toggle', 'tooltip');
        removeBtn.setAttribute('data-bs-title', 'Tool entfernen');
        removeBtn.setAttribute('aria-label', 'Tool entfernen');
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.setAttribute('draggable', 'false');
        removeBtn.addEventListener('mousedown', (event) => event.stopPropagation());
        removeBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            handleCardRemoval(div);
        });
        div.appendChild(removeBtn);

        setTimeout(() => applyCollapsibleTitle(div), 0);

        div.addEventListener('dragstart', (e) => {
            const transferData = { ...toolData, uniqueId: uniqueId, origin: origin };
            e.dataTransfer.setData("text/plain", JSON.stringify(transferData));
            e.dataTransfer.effectAllowed = origin === 'hangar' ? 'copy' : 'move';
        });

        return div;
    }

    function applyCollapsibleTitle(card) {
        if(!card) return;

        const titleEl = card.querySelector('.tool-title');
        if(!titleEl) return;

        const row = card.querySelector('.tool-title-row') || titleEl.parentElement;
        const toggleBtn = card.querySelector('.tool-title-toggle');

        const adjustToggle = () => {
            const computedLineHeight = parseFloat(getComputedStyle(titleEl).lineHeight) || 16;
            const maxHeight = computedLineHeight * 3;
            const isOverflowing = titleEl.scrollHeight > maxHeight + 1;

            titleEl.style.maxHeight = titleEl.classList.contains('expanded') ? 'none' : `${maxHeight}px`;

            if(isOverflowing) {
                if(!toggleBtn) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'tool-title-toggle';
                    btn.textContent = 'Mehr';
                    btn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const expanded = titleEl.classList.toggle('expanded');
                        titleEl.style.maxHeight = expanded ? 'none' : `${maxHeight}px`;
                        btn.textContent = expanded ? 'Weniger' : 'Mehr';
                    });
                    if(row) {
                        row.appendChild(btn);
                    }
                }
            } else {
                titleEl.classList.remove('expanded');
                titleEl.style.maxHeight = `${maxHeight}px`;
                if(toggleBtn) {
                    toggleBtn.remove();
                }
            }
        };

        requestAnimationFrame(adjustToggle);
    }

    function createTooltipForElement(el) {
        if(!el) return null;

        const isToolInfoIcon = el.classList.contains('tool-info-icon');
        const bsTitle = el.getAttribute('data-bs-title') || '';
        const fallbackContent = el.getAttribute('data-tooltip-content') || '';
        const tooltipContent = fallbackContent || stripHtml(bsTitle).trim();
        const offsetAttr = el.getAttribute('data-bs-offset') || '';
        const parsedOffset = offsetAttr
            .split(',')
            .map((value) => Number(value.trim()))
            .filter((value) => !Number.isNaN(value));
        const offset = parsedOffset.length >= 2 ? [parsedOffset[0], parsedOffset[1]] : [0, 8];
        const containerOption = el.getAttribute('data-bs-container') || document.body;
        const boundaryOption = el.getAttribute('data-bs-boundary') || document.body;
        const strategyOption = el.getAttribute('data-bs-strategy') || 'absolute';

        if(isToolInfoIcon && !el.getAttribute('data-bs-placement')) {
            el.setAttribute('data-bs-placement', 'top');
        }

        if(tooltipContent) {
            el.setAttribute('data-tooltip-content', tooltipContent);
            if(!bsTitle) {
                el.setAttribute('data-bs-title', tooltipContent);
            }
        }

        el.removeAttribute('title');
        el.removeAttribute('data-bs-original-title');

        bootstrap.Tooltip.getInstance(el)?.dispose();

        return new bootstrap.Tooltip(el, {
            html: el.getAttribute('data-bs-html') === 'true',
            trigger: 'hover focus',
            placement: el.getAttribute('data-bs-placement') || 'top',
            container: containerOption,
            boundary: boundaryOption,
            offset,
            popperConfig(defaultCfg) {
                return {
                    ...defaultCfg,
                    strategy: strategyOption,
                    modifiers: [
                        ...(defaultCfg.modifiers || []),
                        {
                            name: 'computeStyles',
                            options: {
                                adaptive: false,
                                gpuAcceleration: false
                            }
                        },
                        {
                            name: 'preventOverflow',
                            options: {
                                boundary: boundaryOption,
                                altBoundary: true,
                                padding: 8
                            }
                        }
                    ]
                };
            }
        });
    }

    function initTooltips(root = document) {
        const tooltipTriggerList = root.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach((el) => createTooltipForElement(el));
    }

    function prepareTooltipForMove(el) {
        if(!el) return null;
        const instance = bootstrap.Tooltip.getInstance(el);
        if(!instance) return null;

        instance.hide();
        return instance;
    }

    function refreshMovedTooltip(el, previousInstance = null) {
        if(!el) return;

        if(previousInstance && typeof previousInstance.update === 'function') {
            previousInstance.update();
            return;
        }

        previousInstance?.dispose();
        createTooltipForElement(el);
    }

    function syncActiveTooltipsOnScroll() {
        document.querySelectorAll('.tool-info-icon[data-bs-toggle="tooltip"]').forEach((el) => {
            const instance = bootstrap.Tooltip.getInstance(el);
            if(!instance) return;

            if(typeof instance.update === 'function') {
                instance.update();
            } else {
                instance.hide();
            }
        });
    }

    // === DRAG & DROP ===
    function allowDrop(e) { e.preventDefault(); }

    function dragEnter(e) {
        const target = e.target.closest('.phase-col');
        if(target) target.classList.add('drag-over');
    }

    function dragLeave(e) {
        const target = e.target.closest('.phase-col');
        if(target) target.classList.remove('drag-over');
    }

    function getDropReference(container, clientY, excludeId) {
        const items = Array.from(container.querySelectorAll('.tool-card'))
            .filter(card => !excludeId || card.id !== excludeId);

        return items.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = clientY - (box.top + box.height / 2);

            if(offset < 0 && offset > closest.offset) {
                return { offset, element: child };
            }

            return closest;
        }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
    }

    function drop(e) {
        e.preventDefault();
        const target = e.target.closest('.phase-col');
        if(!target) return;

        target.classList.remove('drag-over');
        const rawData = e.dataTransfer.getData("text/plain");
        if(!rawData) return;

        const data = JSON.parse(rawData);
        const referenceEl = getDropReference(target, e.clientY, data.uniqueId);

        if (data.origin === 'hangar') {
            const newTool = createToolElement({
                ...data,
                uniqueId: 'c-' + Date.now() + Math.random().toString(16).slice(2)
            }, 'cockpit');
            target.insertBefore(newTool, referenceEl);
            initTooltips(target);

            saveState();
        } else {
            const existingEl = document.getElementById(data.uniqueId);
            if(existingEl) {
                const movedInfoIcon = existingEl.querySelector('.tool-info-icon[data-bs-toggle="tooltip"]');
                const previousTooltipInstance = prepareTooltipForMove(movedInfoIcon);

                target.insertBefore(existingEl, referenceEl);
                refreshMovedTooltip(movedInfoIcon, previousTooltipInstance);
                saveState();
            }
        }
    }

    // === NOTIZEN ===
    function openTextModal(targetId, noteElement = null) {
        targetPhaseForNote = targetId || (noteElement && noteElement.parentElement ? noteElement.parentElement.id : null);
        currentEditingNoteId = noteElement ? noteElement.id : null;

        const titleField = document.getElementById('noteTitle');
        const contentField = document.getElementById('noteContent');
        const modalTitleEl = document.getElementById('textNoteModalTitle');

        if(modalTitleEl && defaultNoteModalTitle === '') {
            defaultNoteModalTitle = modalTitleEl.innerHTML;
        }

        if(noteElement) {
            if(modalTitleEl) {
                modalTitleEl.innerHTML = '<i class="fas fa-note-sticky me-2"></i>Notiz bearbeiten';
            }
            if(titleField) titleField.value = noteElement.dataset.name || '';
            if(contentField) contentField.value = noteElement.dataset.text || noteElement.dataset.info || '';
        } else {
            if(modalTitleEl && defaultNoteModalTitle) {
                modalTitleEl.innerHTML = defaultNoteModalTitle;
            }
            if(titleField) titleField.value = '';
            if(contentField) contentField.value = '';
        }

        if(!textModal) {
            const modalEl = document.getElementById('textNoteModal');
            if(modalEl) {
                textModal = new bootstrap.Modal(modalEl);
            }
        }
        if(textModal) {
            textModal.show();
        }
    }

    function addTextBlock() {
        if(!targetPhaseForNote && !currentEditingNoteId) return;

        let target = null;
        if(currentEditingNoteId) {
            const existingNote = document.getElementById(currentEditingNoteId);
            target = existingNote ? existingNote.parentElement : null;
        } else {
            target = document.getElementById(targetPhaseForNote);
        }
        if(!target) return;

        const titleField = document.getElementById('noteTitle');
        const contentField = document.getElementById('noteContent');
        const title = titleField ? titleField.value.trim() : '';
        const content = contentField ? contentField.value.trim() : '';

        if(!content && !title) return;

        if(currentEditingNoteId) {
            const existing = document.getElementById(currentEditingNoteId);
            if(existing) {
                const finalTitle = title || 'Notiz';
                const finalContent = content || 'Notiz';
                existing.dataset.name = finalTitle;
                existing.dataset.info = finalContent;
                existing.dataset.text = content;

                const titleEl = existing.querySelector('.note-title');
                if(titleEl) titleEl.textContent = finalTitle;

                const bodyEl = existing.querySelector('.note-body-text');
                if(bodyEl) {
                    const displayText = escapeHtml(content || '').replace(/\n/g, '<br>');
                    bodyEl.innerHTML = displayText || 'Kein Text hinterlegt';
                }

                saveState();
            }

            if(textModal) {
                textModal.hide();
            }

            return;
        }

        const noteId = 'note-' + Date.now() + Math.random().toString(16).slice(2);
        const noteData = {
            id: noteId,
            name: title || 'Notiz',
            info: content || 'Notiz',
            url: '#',
            cats: ['Notizen'],
            isAi: false,
            isLib: false,
            type: 'text',
            text: content,
            uniqueId: noteId
        };

        const card = createToolElement(noteData, 'cockpit');
        target.appendChild(card);
        initTooltips(target);
        saveState();

        if(textModal) {
            textModal.hide();
        }
    }

    // === CUSTOM TOOLS ===
    function saveCustomTools() {
        const customTools = initialTools.filter(tool => tool.isCustom);
        localStorage.setItem(CUSTOM_TOOLS_KEY, JSON.stringify(customTools));
    }

    function loadCustomTools() {
        const stored = localStorage.getItem(CUSTOM_TOOLS_KEY);
        if(!stored) return;
        try {
            const customTools = JSON.parse(stored) || [];
            customTools.forEach(tool => {
                const toolId = tool.id || ('cust' + Date.now() + Math.random().toString(16).slice(2));
                const exists = initialTools.some(existing => existing.id === toolId);
                if(!exists) {
                    initialTools.push({ ...tool, id: toolId, isCustom: true, cats: deriveCategoriesForTool(tool) });
                }
            });
        } catch (error) {
            console.error('Fehler beim Laden der benutzerdefinierten Tools', error);
        }
    }

    function resetCustomToolForm() {
        currentEditingCustomToolId = null;

        const titleEl = document.getElementById('customToolModalTitle');
        if(titleEl) {
            titleEl.textContent = 'Eigenes Tool ergänzen';
        }

        const submitBtn = document.getElementById('customToolSubmitBtn');
        if(submitBtn) {
            submitBtn.textContent = 'Hinzufügen';
        }

        const nameField = document.getElementById('customToolName');
        const infoField = document.getElementById('customToolInfo');
        const urlField = document.getElementById('customToolUrl');
        const catSelect = document.getElementById('customToolCategory');

        if(nameField) nameField.value = '';
        if(infoField) infoField.value = '';
        if(urlField) urlField.value = '';

        if(catSelect) {
            Array.from(catSelect.options).forEach(opt => opt.selected = false);
        }

        const aiCheckbox = document.getElementById('customToolIsAi');
        const libCheckbox = document.getElementById('customToolIsLib');
        if(aiCheckbox) aiCheckbox.checked = false;
        if(libCheckbox) libCheckbox.checked = false;
    }

    function openCustomToolEditor(toolData) {
        if(!toolData) return;

        currentEditingCustomToolId = toolData.id;

        const titleEl = document.getElementById('customToolModalTitle');
        if(titleEl) {
            titleEl.textContent = 'Eigenes Tool bearbeiten';
        }

        const submitBtn = document.getElementById('customToolSubmitBtn');
        if(submitBtn) {
            submitBtn.textContent = 'Speichern';
        }

        const normalizedCats = deriveCategoriesForTool(toolData);
        const nameField = document.getElementById('customToolName');
        const infoField = document.getElementById('customToolInfo');
        const urlField = document.getElementById('customToolUrl');
        const catSelect = document.getElementById('customToolCategory');
        const aiCheckbox = document.getElementById('customToolIsAi');
        const libCheckbox = document.getElementById('customToolIsLib');

        if(nameField) nameField.value = toolData.name || '';
        if(infoField) infoField.value = toolData.info || '';
        if(urlField) urlField.value = toolData.url || '';

        if(catSelect) {
            const normalized = normalizeCategoriesList(normalizedCats);
            Array.from(catSelect.options).forEach(opt => {
                opt.selected = normalized.includes(opt.value);
            });
        }

        if(aiCheckbox) aiCheckbox.checked = !!toolData.isAi;
        if(libCheckbox) libCheckbox.checked = !!toolData.isLib;

        const modalEl = document.getElementById('customToolModal');
        if(modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.show();
        }
    }

    function rerenderCustomToolInstances(updatedTool) {
        document.querySelectorAll(`.tool-card[data-base-id="${updatedTool.id}"]`).forEach(card => {
            const parent = card.parentElement;
            if(!parent) return;

            const origin = dropTargets.includes(parent.id) ? 'cockpit' : 'hangar';
            const updatedData = {
                ...updatedTool,
                cats: deriveCategoriesForTool(updatedTool),
                uniqueId: card.id,
                type: card.dataset.type || 'tool',
                text: card.dataset.text || '',
                isCustom: isCustomToolData(updatedTool)
            };

            const refreshedCard = createToolElement(updatedData, origin);
            parent.replaceChild(refreshedCard, card);
            initTooltips(parent);
        });
    }

    function isAllowedCustomToolUrl(rawUrl) {
        if(!rawUrl) return true;
        if(rawUrl.trim() === '') return true;
        if(rawUrl === '#') return true;
        try {
            const parsedUrl = new URL(rawUrl);
            return ['http:', 'https:', 'mailto:'].includes(parsedUrl.protocol);
        } catch (error) {
            return false;
        }
    }

    function sanitizeCustomToolUrl(rawUrl) {
        if(isAllowedCustomToolUrl(rawUrl)) {
            return rawUrl || '#';
        }
        return '#';
    }

    function addCustomTool() {
        const name = document.getElementById('customToolName').value;
        const info = document.getElementById('customToolInfo').value;
        const url = document.getElementById('customToolUrl').value;
        const catSelect = document.getElementById('customToolCategory');
        const cat = Array.from(catSelect.selectedOptions).map(opt => opt.value);
        const isAi = document.getElementById('customToolIsAi').checked;
        const isLib = document.getElementById('customToolIsLib').checked;

        if(!name) return;
        if(url && !isAllowedCustomToolUrl(url)) {
            showToast('Nur http/https/mailto-URLs sind erlaubt.', 'error');
            return;
        }

        const baseCategories = cat && cat.length ? cat : ['Organizers'];
        const normalizedCats = deriveCategoriesForTool({ cats: baseCategories, isLib });
        const isEditing = !!currentEditingCustomToolId;
        const toolId = isEditing ? currentEditingCustomToolId : ('cust' + Date.now());

        const newTool = {
            id: toolId,
            name: name,
            cats: normalizedCats,
            url: sanitizeCustomToolUrl(url),
            info: info || 'Benutzerdefiniert',
            isAi: isAi,
            isLib: isLib,
            isCustom: true
        };

        if(isEditing) {
            const existingIndex = initialTools.findIndex(t => t.id === toolId);
            const mergedTool = existingIndex >= 0 ? { ...initialTools[existingIndex], ...newTool } : newTool;
            if(existingIndex >= 0) {
                initialTools[existingIndex] = mergedTool;
            } else {
                initialTools.push(mergedTool);
            }
            saveCustomTools();
            renderHangar();
            rerenderCustomToolInstances(mergedTool);
            saveState();
        } else {
            initialTools.push(newTool);
            saveCustomTools();
            renderHangar();
        }

        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('customToolModal'));
        if(modalInstance) {
            modalInstance.hide();
        }
        resetCustomToolForm();
    }

    // === STORAGE ===
    function saveState() {
        const state = {};
        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(!phase) return;
            const tools = [];
            phase.querySelectorAll('.tool-card').forEach(card => {
                const cats = card.dataset.cats ? card.dataset.cats.split('|').filter(Boolean) : [];
                tools.push({
                    id: card.dataset.baseId || card.id,
                    uniqueId: card.id,
                    name: card.dataset.name || (card.querySelector('.fw-bold') ? card.querySelector('.fw-bold').innerText : 'Tool'),
                    info: card.dataset.info || '',
                    url: card.dataset.url || '#',
                    cats: cats,
                    isAi: card.dataset.isAi === '1' || card.dataset.isAi === 'true',
                    isLib: card.dataset.isLib === '1' || card.dataset.isLib === 'true',
                    isOA: card.dataset.isOa === '1' || card.dataset.isOa === 'true',
                    isVwl: card.dataset.isVwl === '1' || card.dataset.isVwl === 'true',
                    isCustom: card.dataset.isCustom === '1' || card.dataset.isCustom === 'true',
                    type: card.dataset.type || 'tool',
                    text: card.dataset.text || ''
                });
            });
            state[targetId] = tools;
        });
        localStorage.setItem('cockpitState_v3', JSON.stringify(state));
    }

    function loadState() {
        const rawState = localStorage.getItem('cockpitState_v3') || localStorage.getItem('cockpitState_v2');
        if(!rawState) return;
        const state = JSON.parse(rawState);

        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(!phase) return;

            phase.innerHTML = '';
            const tools = state[targetId] || [];

            tools.forEach(savedItem => {
                const itemType = savedItem.type || 'tool';
                if(itemType === 'text') {
                    const restoredNote = {
                        id: savedItem.id || savedItem.uniqueId || 'restored-note',
                        name: savedItem.name || 'Notiz',
                        info: savedItem.info || savedItem.text || 'Notiz',
                        url: '#',
                        cats: normalizeCategoriesList((savedItem.cats && savedItem.cats.length) ? savedItem.cats : ['Notizen']),
                        type: 'text',
                        text: savedItem.text || '',
                        uniqueId: savedItem.uniqueId || ('note-' + Date.now() + Math.random().toString(16).slice(2))
                    };
                    phase.appendChild(createToolElement(restoredNote, 'cockpit'));
                    return;
                }

                let original = initialTools.find(it => it.id === savedItem.id) || initialTools.find(it => it.name === savedItem.name);

                if(!original) {
                    const fallbackCats = (savedItem.cats && savedItem.cats.length) ? savedItem.cats : ['Organizers'];
                    original = {
                        id: savedItem.id || 'restored',
                        name: savedItem.name || 'Unbenannt',
                        cats: fallbackCats,
                        url: savedItem.url || '#',
                        info: savedItem.info || 'Wiederhergestellt',
                        isAi: !!savedItem.isAi,
                        isLib: !!savedItem.isLib,
                        isOA: !!savedItem.isOA,
                        isVwl: !!savedItem.isVwl
                    };
                }

                const mergedTool = { ...original, ...savedItem };
                const restoredTool = {
                    ...mergedTool,
                    cats: deriveCategoriesForTool(mergedTool),
                    uniqueId: savedItem.uniqueId,
                    isCustom: mergedTool.isCustom,
                    isAi: mergedTool.isAi,
                    isLib: mergedTool.isLib,
                    isOA: mergedTool.isOA,
                    isVwl: mergedTool.isVwl
                };
                phase.appendChild(createToolElement(restoredTool, 'cockpit'));
            });

            initTooltips(phase);
        });
    }

    // === PRINT ===
    function handlePrintClick() {
        showToast('PDF wird erstellt…', 'info', 5000);
        showToast('Im Druckdialog als PDF speichern.', 'info', 5000);
        setTimeout(() => {
            window.print();
            showToast('PDF wurde erstellt.', 'success', 4000);
        }, 120);
    }

    // === IMPORT/EXPORT & RESET ===
    function exportConfiguration() {
        let cockpitState = {};
        let storedCustomTools = [];

        try {
            cockpitState = JSON.parse(localStorage.getItem('cockpitState_v3')) || {};
        } catch (error) {
            console.error('Fehler beim Lesen des Cockpit-Status', error);
        }

        try {
            storedCustomTools = JSON.parse(localStorage.getItem(CUSTOM_TOOLS_KEY)) || [];
        } catch (error) {
            console.error('Fehler beim Lesen der Custom Tools', error);
        }

        const payload = {
            schemaVersion: EXPORT_SCHEMA_VERSION,
            cockpitState_v3: cockpitState,
            customTools: storedCustomTools
        };

        const jsonString = JSON.stringify(payload, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'cockpit-konfiguration.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast('JSON wurde heruntergeladen.', 'success');
    }

    function triggerImport() {
        const input = document.getElementById('importJsonInput');
        if(input) {
            input.value = '';
            input.click();
        }
    }

    function validateImportPayload(payload) {
        if(!payload || typeof payload !== 'object') return false;
        if(typeof payload.schemaVersion !== 'string') return false;
        if(payload.schemaVersion !== EXPORT_SCHEMA_VERSION) return false;
        if(!payload.cockpitState_v3 || typeof payload.cockpitState_v3 !== 'object' || Array.isArray(payload.cockpitState_v3)) return false;
        if(!Array.isArray(payload.customTools)) return false;
        if(payload.customTools.some(tool => !tool || typeof tool !== 'object')) return false;
        return true;
    }

    function applyImportedConfiguration(payload) {
        const sanitizedState = (payload && payload.cockpitState_v3 && typeof payload.cockpitState_v3 === 'object') ? payload.cockpitState_v3 : {};
        const sanitizedCustomTools = Array.isArray(payload.customTools)
            ? payload.customTools.map(tool => ({ ...tool, url: sanitizeCustomToolUrl(tool.url) }))
            : [];

        Object.keys(sanitizedState).forEach(phaseId => {
            const phaseItems = Array.isArray(sanitizedState[phaseId]) ? sanitizedState[phaseId] : [];
            phaseItems.forEach(item => {
                if(item && item.isCustom) {
                    item.url = sanitizeCustomToolUrl(item.url);
                }
            });
        });

        localStorage.setItem('cockpitState_v3', JSON.stringify(sanitizedState));
        localStorage.setItem(CUSTOM_TOOLS_KEY, JSON.stringify(sanitizedCustomTools));
        localStorage.removeItem('cockpitState_v2');

        const baseTools = initialTools.filter(tool => !tool.isCustom);
        initialTools.splice(0, initialTools.length, ...baseTools);
        loadCustomTools();

        renderHangar();
        loadState();
    }

    function handleImportFile(event) {
        const input = event.target;
        if(!input || !input.files || !input.files.length) return;

        const file = input.files[0];
        if(!file || file.size === 0) {
            showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
            return;
        }

        if(file.size > MAX_IMPORT_FILE_SIZE_BYTES) {
            showToast('Import fehlgeschlagen: Die Datei ist zu groß (maximal 2 MB).', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = (loadEvent) => {
            const rawContent = (loadEvent && loadEvent.target && typeof loadEvent.target.result === 'string')
                ? loadEvent.target.result
                : '';

            if(!rawContent || !rawContent.trim()) {
                showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(rawContent);
                const isValid = validateImportPayload(parsed);

                if(!isValid) {
                    showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
                    return;
                }

                applyImportedConfiguration(parsed);
                showToast('Import erfolgreich.', 'success');
            } catch (error) {
                console.error('Import fehlgeschlagen', error);
                showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
            }
        };
        reader.onerror = () => {
            showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
        };
        reader.readAsText(file);
    }

    function resetCockpit() {
        if(confirm('Wirklich alles löschen?')) {
            localStorage.removeItem('cockpitState_v2');
            localStorage.removeItem('cockpitState_v3');
            localStorage.removeItem('cockpitDeleted_v1');
            localStorage.removeItem(CUSTOM_TOOLS_KEY);
            location.reload();
        }
    }

    function loadExampleCockpit() {
        const confirmed = confirm('Das aktuelle Cockpit wird zurückgesetzt und ein Beispiel geladen. Fortfahren?');
        if(!confirmed) return;

        const exampleState = {
            'phase-1': [
                { id: 't1', uniqueId: 'ex-phase1-tool', name: 'ChatGPT', info: 'Ideen für den thematischen Fokus sammeln', url: 'https://chat.openai.com', cats: ['Assistants'], isAi: true, isLib: false, isOA: false, isCustom: false, type: 'tool' },
                { id: 'ex-note-phase1', uniqueId: 'ex-note-phase1', name: 'Forschungsfrage', info: 'Erste Leitfrage: Welche Folgen hat KI-gestützte Literaturrecherche auf die Ergebnisqualität?', url: '#', cats: ['Notizen'], isAi: false, isLib: false, isOA: false, isCustom: false, type: 'text', text: 'Welche Auswirkungen hat KI-gestützte Recherche auf die Qualität von Studien in der Informationswissenschaft?' }
            ],
            'phase-2': [
                { id: 't5', uniqueId: 'ex-phase2-tool', name: 'Elicit', info: 'Schlüsselbegriffe und Synonyme sammeln', url: 'https://elicit.org', cats: ['Finders'], isAi: true, isLib: false, isOA: false, isCustom: false, type: 'tool' },
                { id: 'ex-note-phase2', uniqueId: 'ex-note-phase2', name: 'Suchbegriffe', info: 'KI-assisted search, evaluator metrics, scholarly quality, bias mitigation', url: '#', cats: ['Notizen'], isAi: false, isLib: false, isOA: false, isCustom: false, type: 'text', text: 'Suchstrings: "AI-assisted literature search", "scholarly quality", "systematic review tools", "bias mitigation".' }
            ],
            'phase-3': [
                { id: 't6', uniqueId: 'ex-phase3-tool', name: 'Google Scholar', info: 'Breite Suche nach relevanten Studien', url: 'https://scholar.google.com', cats: ['Finders'], isAi: false, isLib: false, isOA: false, isCustom: false, type: 'tool' },
                { id: 'ex-note-phase3', uniqueId: 'ex-note-phase3', name: 'Datenbanken', info: 'Start mit Scholar, ergänzend Swisscovery und wiso für deutschsprachige Quellen nutzen.', url: '#', cats: ['Notizen'], isAi: false, isLib: false, isOA: false, isCustom: false, type: 'text', text: 'Reihenfolge: Scholar → Swisscovery → wiso. Filter: 2018+, peer-reviewed, Bibliometrie.' }
            ],
            'phase-5': [
                { id: 'ex-note-phase5', uniqueId: 'ex-note-phase5', name: 'Lesestrategie', info: 'Schlüsselabschnitte markieren, methodische Details extrahieren.', url: '#', cats: ['Notizen'], isAi: false, isLib: false, isOA: false, isCustom: false, type: 'text', text: 'Leseliste priorisieren: 3 systematische Reviews, 2 Vergleichsstudien. Fokus auf Methodik-Abschnitte.' }
            ],
            'phase-6': [
                { id: 'ex-note-phase6', uniqueId: 'ex-note-phase6', name: 'Schreibplan', info: 'Einleitung mit Problemaufriss, dann Methodik der Vergleichsstudien, Ergebnisse, Grenzen, Ausblick.', url: '#', cats: ['Notizen'], isAi: false, isLib: false, isOA: false, isCustom: false, type: 'text', text: 'Gliederung: 1) Ausgangslage, 2) Methoden der KI-gestützten Suche, 3) Bewertungsergebnisse, 4) Bias & Grenzen, 5) Fazit.' }
            ],
        };

        localStorage.removeItem('cockpitState_v2');
        localStorage.removeItem('cockpitDeleted_v1');
        localStorage.removeItem(CUSTOM_TOOLS_KEY);

        const baseTools = initialTools.filter(tool => !tool.isCustom);
        initialTools.splice(0, initialTools.length, ...baseTools);

        localStorage.setItem('cockpitState_v3', JSON.stringify(exampleState));

        renderHangar();
        loadState();
        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(phase) initTooltips(phase);
        });

        const titleInput = document.getElementById('cockpitTitleInput');
        if(titleInput) {
            titleInput.value = 'Beispiel-Cockpit: KI-gestützte Literaturrecherche';
        }

        showToast('Beispiel-Cockpit geladen.', 'success');
    }

    // === INITIALISIERUNG ===
    document.addEventListener('DOMContentLoaded', () => {
        toastContainer = document.getElementById('toast-container');
        loadCustomTools();
        renderHangar();
        populateCategoryOptions();
        populateFilterOptions();
        populateLicensedDbSelect();
        loadState();
        loadDeletedState();
        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(phase) initTooltips(phase);
        });

        const savePdfButton = document.getElementById('savePdfButton');
        if(savePdfButton) {
            savePdfButton.addEventListener('click', handlePrintClick);
        }

        const searchInput = document.getElementById('toolSearchInput');
        if(searchInput) {
            searchInput.addEventListener('input', (e) => {
                currentSearchTerm = (e.target.value || '').trim().toLowerCase();
                if(!currentSearchTerm) {
                    setCategoryFilter('', { render: false });
                }
                renderHangar();
            });
        }


        const textModalEl = document.getElementById('textNoteModal');
        if(textModalEl) {
            const modalTitleEl = document.getElementById('textNoteModalTitle');
            if(modalTitleEl) {
                defaultNoteModalTitle = modalTitleEl.innerHTML;
            }
            textModal = new bootstrap.Modal(textModalEl);
            textModalEl.addEventListener('hidden.bs.modal', () => {
                targetPhaseForNote = null;
                currentEditingNoteId = null;
                const titleField = document.getElementById('noteTitle');
                const contentField = document.getElementById('noteContent');
                if(titleField) titleField.value = '';
                if(contentField) contentField.value = '';
                const modalTitleEl = document.getElementById('textNoteModalTitle');
                if(modalTitleEl && defaultNoteModalTitle) {
                    modalTitleEl.innerHTML = defaultNoteModalTitle;
                }
            });
        }

        const customModalEl = document.getElementById('customToolModal');
        if(customModalEl) {
            customModalEl.addEventListener('hidden.bs.modal', () => resetCustomToolForm());
        }

        const orientationModalEl = document.getElementById('orientationModal');
        if(orientationModalEl) {
            orientationModal = new bootstrap.Modal(orientationModalEl, { backdrop: true, keyboard: true });

            orientationModalEl.addEventListener('show.bs.modal', () => {
                lastFocusedElement = document.activeElement;
            });

            orientationModalEl.addEventListener('shown.bs.modal', () => {
                if(orientationFocusTrapCleanup) orientationFocusTrapCleanup();
                orientationFocusTrapCleanup = trapFocusWithin(orientationModalEl);
            });

            orientationModalEl.addEventListener('hidden.bs.modal', () => {
                if(orientationFocusTrapCleanup) {
                    orientationFocusTrapCleanup();
                    orientationFocusTrapCleanup = null;
                }
                clearOrientationHighlights();
                if(lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                    lastFocusedElement.focus();
                }
            });

            orientationModalEl.querySelectorAll('[data-onboarding-step]').forEach(btn => {
                btn.addEventListener('click', () => applyOnboardingStep(btn.dataset.onboardingStep));
            });

        }

        const scrollContainers = document.querySelectorAll('.cockpit-area, .board-wrapper');
        scrollContainers.forEach((container) => {
            container.addEventListener('scroll', syncActiveTooltipsOnScroll, { passive: true });
        });

        const importInput = document.getElementById('importJsonInput');
        if(importInput) {
            importInput.addEventListener('change', handleImportFile);
        }

        window.addEventListener('resize', () => {
            document.querySelectorAll('.tool-card').forEach(card => applyCollapsibleTitle(card));
        });
});
</script>
<script>
    function startGuidedTour() {
        const steps = [
            {
                element: document.querySelector('.hangar-area'),
                title: 'Hangar',
                intro: 'Hier finden Sie alle Tools. Ziehen Sie sie per Drag & Drop in die fünf Phasen des Recherche-Boards.',
                position: 'right'
            },
            {
                element: document.querySelector('#noteDropdown'),
                title: 'Notizen hinzufügen',
                intro: 'Erstellen Sie Notizen und Fragen direkt pro Phase.',
                position: 'bottom'
            },
            {
                element: document.querySelector('#orientationButton'),
                title: 'Compass',
                intro: 'Der Compass öffnet die Onboarding-Infos mit Tipps zum Aufbau Ihres Cockpits.',
                position: 'bottom'
            },
            {
                element: document.querySelector('#ai-source-check-btn'),
                title: 'Reflektierter Umgang mit KI',
                intro: 'Nutzen Sie diese Inhalte, um Ihren KI-Einsatz zu reflektieren und Leitlinien zu beachten.',
                position: 'bottom'
            },
            {
                element: document.querySelector('#flightControlsButton'),
                title: 'Flight Controls',
                intro: 'Exportieren, importieren oder laden Sie ein Beispiel-Board.',
                position: 'bottom'
            },
            {
                element: document.querySelector('#phase-1'),
                title: 'Phase auswählen',
                intro: 'Ziehen Sie ein Tool aus dem Hangar in eine Phase, um Ihren Workflow zu starten.',
                position: 'right'
            }
        ].filter(step => step.element);

        const introInstance = introJs();
        introInstance.setOptions({
            steps,
            showProgress: true,
            showBullets: true,
            showStepNumbers: false,
            showSkipButton: false,
            exitOnOverlayClick: true,
            exitOnEsc: true,
            scrollToElement: true,
            scrollPadding: 80,
            nextLabel: 'Weiter',
            prevLabel: 'Zurück',
            doneLabel: 'Fertig'
        });

        introInstance.onstart(() => {
            showToast('Tipp: Mit Esc oder Klick auf den Hintergrund beenden Sie die Tour jederzeit.', 'info', 4500);
        });

        introInstance.oncomplete(() => {
            localStorage.setItem('tourCompleted', 'true');
        });

        introInstance.onexit(() => {
            localStorage.setItem('tourCompleted', 'true');
        });

        introInstance.start();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const guidedTourButton = document.getElementById('guided-tour-btn');
        if(guidedTourButton) {
            guidedTourButton.addEventListener('click', startGuidedTour);
        }

        if(localStorage.getItem('tourCompleted') !== 'true') {
            startGuidedTour();
        }
    });
</script>

</body>
</html>
