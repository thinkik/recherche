<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche-Cockpit | Version 2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* === Layout === */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }
        .hangar-area { background: #ffffff; height: 100vh; overflow-y: auto; border-right: 1px solid #dee2e6; padding: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1020; }
        .cockpit-area { padding: 20px; height: 100vh; overflow-y: auto; }
        .cat-header { font-size: 0.75rem; font-weight: 800; color: #5c6770; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px; margin-bottom: 8px; border-bottom: 1px solid #e2e6ea; padding-bottom: 4px; }
        .phase-col { background: #eef2f7; border-radius: 12px; min-height: 65vh; padding: 10px; border: 2px dashed #cbd5e0; transition: background 0.3s; }
        .phase-col.drag-over { background: #dbeafe; border-color: #3b82f6; }
        .global-header { font-weight: 700; text-align: center; margin: 20px 0 10px; color: #0d6efd; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; }
        .global-drop { min-height: 160px; background: #e8f4ff; border-color: #0d6efd99; box-shadow: inset 0 0 0 1px #0d6efd33; }
        .global-drop.drag-over { background: #d0e7ff; border-color: #0d6efd; }
        .phase-header { font-weight: 700; text-align: center; margin-bottom: 15px; color: #495057; font-size: 0.85rem; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .step-number { background: #6c757d; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; margin-right: 6px; font-size: 0.75rem; }
        .deleted-wrapper { border: 1px dashed #ced4da; border-radius: 8px; padding: 10px; background: #f8f9fa; }
        .deleted-item { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 6px 8px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 0.9rem; }
        .deleted-item:last-child { margin-bottom: 0; }
        .deleted-item .meta { color: #6c757d; font-size: 0.8rem; }
        .deleted-empty { color: #adb5bd; font-style: italic; font-size: 0.9rem; }
        .ki-callout { border: 1px solid #ffeeba; background: #fff8e1; border-radius: 8px; padding: 12px; }
        .ki-callout .icon-wrap { width: 38px; height: 38px; border-radius: 8px; background: #fff3cd; display: inline-flex; align-items: center; justify-content: center; color: #e67e22; box-shadow: inset 0 0 0 1px #ffe8a1; }
        .ki-checklist .list-group-item { border: none; border-bottom: 1px dashed #f1c40f; background: transparent; padding-left: 0; padding-right: 0; }
        .ki-checklist .list-group-item:last-child { border-bottom: none; }

        /* === Cards === */
        .tool-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px; margin-bottom: 8px; cursor: grab; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 0.9rem; position: relative; }
        .tool-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-color: #0d6efd; z-index: 10; }
        .tool-card:active { cursor: grabbing; }
        .tool-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px; color: #555; font-size: 0.8rem; }
        .tool-card-body { min-width: 0; }
        .tool-title-row { align-items: flex-start; gap: 8px; flex-wrap: wrap; }
        .tool-title { flex: 1 1 auto; min-width: 0; white-space: normal; line-height: 1.25; max-height: 3.75em; overflow: hidden; transition: max-height 0.2s ease; }
        .tool-title.expanded { max-height: none; }
        .tool-title-toggle { border: none; background: transparent; color: #0d6efd; font-size: 0.75rem; padding: 0 4px; line-height: 1.25; }
        .tool-title-toggle:hover { text-decoration: underline; }
        .tool-title-toggle:focus-visible { outline: 2px solid #0d6efd; outline-offset: 2px; }
        .tool-badges { display: flex; gap: 4px; flex-shrink: 0; margin-left: auto; }
        .tool-category { white-space: normal; line-height: 1.2; }
        .is-ai { box-shadow: inset 3px 0 0 #8e44ad; }
        .is-library { box-shadow: inset 3px 0 0 #198754; }
        .is-ai.is-library { box-shadow: inset 3px 0 0 #8e44ad, inset 6px 0 0 #198754; }
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; }
        .badge-ai { background: #f3e8ff; color: #6f42c1; border: 1px solid #e0c3ff; }
        .badge-lib { background: #e8fff3; color: #0f5132; border: 1px solid #b6e2c8; }
        .badge-oa { background: #fff4e5; color: #d35400; border: 1px solid #f6d7b0; }
        .tool-link { color: #495057; margin-left: auto; padding: 2px 6px; border-radius: 4px; transition: 0.2s; }
        .tool-link:hover { background-color: #e9ecef; color: #0d6efd; }
        .tool-remove-btn { position: absolute; top: 6px; right: 6px; border: none; background: transparent; color: #6c757d; padding: 4px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
        .tool-remove-btn:hover, .tool-remove-btn:focus-visible { color: #dc3545; background: #f8d7da; }

        /* === Buttons === */
        .edit-custom-btn { border: none; background: transparent; color: #6c757d; padding: 2px 6px; }
        .edit-custom-btn:hover { color: #0d6efd; }
        .ki-check-btn { background: linear-gradient(135deg, #f39c12, #e67e22); color: #fff; font-weight: 700; letter-spacing: 0.3px; box-shadow: 0 6px 14px rgba(243, 156, 18, 0.3); border: none; }
        .ki-check-btn:hover { color: #fff; background: linear-gradient(135deg, #ffa726, #e67e22); box-shadow: 0 8px 18px rgba(243, 156, 18, 0.45); transform: translateY(-1px); }

        /* === Modal === */
        .tool-link .d-print-inline { color: #0d6efd !important; }
        .orientation-highlight {
            outline: 3px solid #0d6efd;
            outline-offset: 3px;
            box-shadow: 0 0 0 6px rgba(13, 110, 253, 0.2);
            transition: outline-offset 0.2s ease, box-shadow 0.2s ease;
        }
        .orientation-onboarding-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #e7f1ff;
            color: #0d6efd;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .orientation-tip-list li + li { margin-top: 6px; }
        .orientation-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .orientation-modal-footer .btn-group { flex-wrap: wrap; }

        /* === Toasts === */
        .toast-container { position: fixed; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 1080; pointer-events: none; }
        .toast-container.bottom { top: auto; bottom: 1rem; }
        .toast-item { background: #ffffff; color: #111827; border-radius: 10px; border: 1px solid #e5e7eb; border-left: 4px solid #0d6efd; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12); padding: 10px 12px; min-width: 260px; max-width: min(360px, calc(100vw - 2rem)); display: flex; align-items: flex-start; gap: 10px; pointer-events: auto; opacity: 0; transform: translateY(6px); transition: opacity 0.2s ease, transform 0.2s ease; }
        .toast-item.show { opacity: 1; transform: translateY(0); }
        .toast-item .toast-icon { font-size: 1rem; margin-top: 2px; }
        .toast-item .toast-content { flex: 1; }
        .toast-item .toast-title { font-weight: 700; font-size: 0.95rem; line-height: 1.2; }
        .toast-item .toast-message { font-size: 0.9rem; color: #374151; line-height: 1.35; word-break: break-word; }
        .toast-item .toast-close { border: none; background: transparent; color: #6b7280; cursor: pointer; padding: 4px; border-radius: 6px; flex-shrink: 0; }
        .toast-item .toast-close:focus-visible { outline: 2px solid #0d6efd; outline-offset: 2px; }
        .toast-success { border-left-color: #16a34a; }
        .toast-success .toast-icon { color: #16a34a; }
        .toast-info { border-left-color: #0d6efd; }
        .toast-info .toast-icon { color: #0d6efd; }
        .toast-error { border-left-color: #dc2626; }
        .toast-error .toast-icon { color: #dc2626; }

        @media (max-width: 576px) {
            .toast-container { left: 0.75rem; right: 0.75rem; top: auto; bottom: 1rem; align-items: flex-end; }
            .toast-item { width: 100%; max-width: none; }
        }

        /* === A11y === */
        .tool-card:focus-visible, .btn:focus-visible, .form-control:focus-visible, .form-select:focus-visible, .tool-link:focus-visible, .tool-info-btn:focus-visible, .edit-custom-btn:focus-visible, .tool-title-toggle:focus-visible {
            outline: 3px solid #0a58ca;
            outline-offset: 3px;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
        }

        .tool-info-btn {
            border: none;
            background: transparent;
            color: #6c757d;
            padding: 4px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            min-height: 32px;
        }

        .tool-info-btn:hover { background: #e9ecef; color: #0d6efd; }

        .phase-col:focus-within { box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.35); border-color: #0d6efd; }

        /* === Responsive Board & Layout === */
        .cockpit-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }
        .board-wrapper { overflow-x: auto; padding-bottom: 6px; }
        .board-grid { flex-wrap: nowrap; min-height: 70vh; }
        .board-grid > .col { min-width: 280px; flex: 0 0 auto; }

        @media (max-width: 1199.98px) {
            .hangar-area { height: auto; max-height: 70vh; }
            .cockpit-area { height: auto; }
            .board-wrapper { margin-top: 10px; }
        }

        @media (min-width: 1400px) {
            .board-grid { flex-wrap: wrap; }
            .board-grid > .col { min-width: 0; flex: 1 0 0; }
        }

        /* === Responsive === */
        @media print {
            .hangar-area, .no-print, .modal { display: none !important; }
            .cockpit-area { width: 100% !important; height: auto !important; overflow: visible; padding: 0; }
            .phase-col { border: 1px solid #ccc; min-height: 150px; page-break-inside: avoid; break-inside: avoid; padding: 10px; }
            .phase-header { background: #f1f3f5; padding: 8px; border-bottom: 1px solid #dee2e6; border-radius: 6px 6px 0 0; }
            .row { display: flex !important; flex-wrap: wrap !important; gap: 12px !important; }
            .cockpit-area .row.row-cols-1.row-cols-md-6.g-2 > .col { flex: 1 1 45% !important; max-width: 50% !important; min-width: 240px; }
            .cockpit-area .row.g-2 > .col-12 { flex: 1 1 100% !important; max-width: 100% !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .tool-link { display: inline-flex !important; align-items: center; gap: 4px; color: #0d6efd !important; text-decoration: underline !important; visibility: visible !important; opacity: 1 !important; }
        }
    </style>
</head>
<body>

<div id="toast-container" class="toast-container no-print" aria-live="polite" aria-atomic="true" role="region" aria-label="Systembenachrichtigungen"></div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 hangar-area d-flex flex-column">
            <h5 class="mb-3"><i class="fas fa-warehouse"></i> Hangar</h5>
            <p class="text-muted small" style="line-height: 1.2;">Ziehen Sie die Instrumente in die 6 Phasen. <br>
            <span class="text-success fw-bold">▐</span> = Uni-Lizenz | <span style="color:#8e44ad; font-weight:bold;">▐</span> = KI-Tool<br>
            Beide Marker erscheinen, falls ein Tool beides ist.</p>

            <div class="no-print mb-3">
                <label class="form-label visually-hidden" for="toolSearchInput">Tools durchsuchen</label>
                <input type="text" id="toolSearchInput" class="form-control form-control-sm mb-2" placeholder="Tools durchsuchen..." aria-label="Tools durchsuchen">
                <label class="form-label visually-hidden" for="toolCategoryDropdownButton">Kategorie filtern</label>
                <div class="dropdown w-100">
                    <button id="toolCategoryDropdownButton" class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Tools nach Kategorie filtern">
                        <span class="d-flex align-items-center gap-2">
                            <i class="fas fa-filter text-secondary"></i>
                            <span class="category-label">Alle Kategorien</span>
                        </span>
                        <i class="fas fa-chevron-down small text-muted"></i>
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="toolCategoryDropdownButton" id="toolCategoryMenu"></ul>
                </div>
                <div class="form-text small text-muted mt-1">
                    Fahren Sie in der Liste über eine Kategorie, um deren Beschreibung zu sehen.
                </div>
            </div>

            <div id="tool-pool">
                </div>

            <button class="btn btn-sm btn-outline-primary w-100 mt-3 no-print" data-bs-toggle="modal" data-bs-target="#customToolModal">
                <i class="fas fa-plus"></i> Eigenes Tool ergänzen
            </button>

            <button class="btn btn-sm btn-outline-success w-100 mt-2 no-print" data-bs-toggle="modal" data-bs-target="#licensedDbModal">
                <i class="fas fa-database"></i> + Lizenzierte Datenbank ergänzen
            </button>

            <div class="mt-auto no-print">
                <div class="mt-3 deleted-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-bold"><i class="fas fa-trash-undo me-2"></i>Gelöschte Tools &amp; Notizen</div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="restoreAllDeleted()" title="Alle zurückholen" aria-label="Alle gelöschten Tools wiederherstellen">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                    <div id="deleted-list" class="deleted-empty">Noch nichts gelöscht</div>
                </div>
            </div>
        </div>

        <div class="col-md-9 cockpit-area">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                <h3><i class="fas fa-plane-departure"></i> Mein Recherche-Cockpit</h3>
                <div class="no-print cockpit-actions">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-note-sticky"></i>
                            <span>Notiz hinzufügen</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header">Ziel auswählen</li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-1')">Phase 1: Thema eingrenzen</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-2')">Phase 2: Suchbegriffe</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-3')">Phase 3: Datenbank-Suche</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-4')">Phase 4: Literatur bewerten</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-5')">Phase 5: Literatur lesen</button></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-6')">Phase 6: Text schreiben</button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item" type="button" onclick="openTextModal('phase-global')">Gesamter Rechercheprozess</button></li>
                        </ul>
                    </div>
                    <button id="orientationButton" type="button" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#orientationModal">
                        <i class="fas fa-compass"></i>
                        <span>Compass</span>
                    </button>
                    <button class="btn ki-check-btn btn-sm d-inline-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#kiSourcesModal">
                        <i class="fas fa-shield-alt"></i>
                        <span>AI & Source Check</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-primary dropdown-toggle" id="flightControlsButton" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plane"></i> Flight Controls
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="flightControlsButton">
                            <li><button class="dropdown-item" id="savePdfButton" type="button"><i class="fas fa-file-pdf me-2"></i>Als PDF speichern</button></li>
                            <li><button class="dropdown-item" id="exportJsonButton" type="button" onclick="exportConfiguration()"><i class="fas fa-download me-2"></i>Export JSON</button></li>
                            <li><button class="dropdown-item" id="importJsonButton" type="button" onclick="triggerImport()"><i class="fas fa-upload me-2"></i>Import JSON</button></li>
                            <li><button class="dropdown-item" type="button" onclick="resetCockpit()"><i class="fas fa-undo me-2"></i>Reset</button></li>
                        </ul>
                    </div>
                    <input type="file" id="importJsonInput" class="d-none" accept="application/json" />
                </div>
            </div>

            <div class="board-wrapper">
            <div class="row row-cols-1 row-cols-md-6 g-2 board-grid flex-nowrap">
                
                <div class="col">
                    <div class="phase-header"><span class="step-number">1</span> Thema eingrenzen</div>
                    <div class="no-print mb-2">
                        <button class="btn btn-link p-0 text-decoration-none small d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#phase1Help" aria-expanded="false" aria-controls="phase1Help">
                            <i class="fas fa-circle-question text-primary"></i>
                            <span class="fw-semibold text-secondary">Hilfe</span>
                        </button>
                        <div class="collapse" id="phase1Help">
                            <div class="small text-muted ps-4 pt-1">Nutze KI-Tools für Brainstorming, aber suche dann nach einem Seed Paper / Literaturperle für die Vertiefung</div>
                        </div>
                    </div>
                    <div class="phase-col" id="phase-1" role="region" aria-label="Phase 1: Thema eingrenzen" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">2</span> Suchbegriffe</div>
                    <div class="phase-col" id="phase-2" role="region" aria-label="Phase 2: Suchbegriffe" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">3</span> Datenbank-Suche</div>
                    <div class="phase-col" id="phase-3" role="region" aria-label="Phase 3: Datenbank-Suche" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">4</span> Literatur bewerten</div>
                    <div class="phase-col" id="phase-4" role="region" aria-label="Phase 4: Literatur bewerten" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">5</span> Literatur lesen</div>
                    <div class="phase-col" id="phase-5" role="region" aria-label="Phase 5: Literatur lesen" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

                <div class="col">
                    <div class="phase-header"><span class="step-number">6</span> Text schreiben</div>
                    <div class="phase-col" id="phase-6" role="region" aria-label="Phase 6: Text schreiben" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>

            </div>
            </div>

            <div class="row g-2">
                <div class="col-12">
                    <div class="global-header"><i class="fas fa-layer-group me-2 text-primary"></i>Gesamter Rechercheprozess</div>
                    <div class="phase-col global-drop" id="phase-global" role="region" aria-label="Gesamter Rechercheprozess" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orientationModal" role="dialog" tabindex="-1" aria-labelledby="orientationModalLabel" aria-modal="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <p class="orientation-onboarding-tag mb-1"><i class="fas fa-compass"></i> Compass</p>
                    <h5 class="modal-title" id="orientationModalLabel">Schnelle Hilfe & Onboarding</h5>
                </div>
                <button type="button" class="btn-close" aria-label="Schließen" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-7">
                        <h6 class="fw-bold">Was kann ich hier tun?</h6>
                        <ul class="orientation-tip-list ps-3">
                            <li><strong>Bausteine platzieren:</strong> Ziehen Sie Tools am Griff <i class="fas fa-grip-lines-vertical text-muted"></i> vom Hangar in die sechs Phasen oder zurück in den Hangar.</li>
                            <li><strong>Aufräumen & rückgängig:</strong> Entfernen Sie Tools über den roten Papierkorb-Button, per Drag & Drop in die Lösch-Zone oder holen Sie sie aus „Gelöscht“ zurück.</li>
                            <li><strong>Filtern & finden:</strong> Nutzen Sie Suche und Kategorien, um spezielle Tools schneller aufzuspüren. Tool-Badges zeigen KI- oder Uni-Lizenz an.</li>
                            <li><strong>Setups sichern:</strong> Öffnen Sie das Flight-Controls-Menü oben rechts, um Cockpit-Setups als JSON zu exportieren oder zu importieren.</li>
                            <li><strong>Teilen & PDF:</strong> Im Flight-Controls-Menü finden Sie die Druck-/PDF-Funktion, um ein Snapshot Ihres Boards zu speichern oder zu verschicken.</li>
                        </ul>
                    </div>
                    <div class="col-md-5">
                        <div class="border rounded p-3 h-100">
                            <h6 class="fw-bold mb-2">Mini-Onboarding</h6>
                            <p class="small text-muted mb-3">Markieren Sie nacheinander die wichtigsten Bereiche. Die Hervorhebung lässt sich jederzeit wechseln – ideal für Live-Demos.</p>
                            <div class="btn-group w-100" role="group" aria-label="Onboarding-Schritte">
                                <button type="button" class="btn btn-outline-primary" data-onboarding-step="drag">
                                    1. Ziehen
                                    <div class="small text-muted">Hangar → Phase</div>
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-onboarding-step="delete">
                                    2. Löschen
                                    <div class="small text-muted">Papierkorb & Rückholung</div>
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-onboarding-step="export">
                                    3. Export/PDF
                                    <div class="small text-muted">Flight Controls nutzen</div>
                                </button>
                            </div>
                            <div class="mt-3 small text-muted">
                                Tipp: Probieren Sie jede Stufe in der Reihenfolge aus – die markierten Bereiche zeigen Ihnen genau, wo Sie klicken oder ziehen können.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer orientation-modal-footer">
                <span class="small text-muted">ESC schließt das Fenster. Fokus bleibt im Modal.</span>
                <div class="btn-group" role="group" aria-label="Modalaktionen">
                    <button type="button" class="btn btn-outline-secondary" id="resetOnboardingHighlights">Hervorhebungen zurücksetzen</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Schließen</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="aiWarningModal" tabindex="-1" data-bs-backdrop="static" role="alertdialog" aria-modal="true" aria-labelledby="aiWarningModalTitle" aria-describedby="aiWarningModalDesc">
    <div class="modal-dialog border-danger">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="aiWarningModalTitle"><i class="fas fa-robot"></i> Co-Pilot Warnung (KI)</h5>
            </div>
            <div class="modal-body">
                <div id="aiWarningModalDesc">
                    <p class="fw-bold">Sie setzen Künstliche Intelligenz ein.</p>
                    <div class="alert alert-light border">
                    <i class="fas fa-exclamation-triangle text-warning"></i> 
                    KI-Modelle können Fakten halluzinieren und Quellen erfinden.
                    </div>
                    <p>Verpflichten Sie sich, alle KI-Ergebnisse mit Primärquellen zu verifizieren?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="cancelAiUse">Abbrechen</button>
                <button type="button" class="btn btn-warning" id="confirmAiUse">Ja, ich verifiziere.</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="textNoteModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="textNoteModalTitle">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textNoteModalTitle"><i class="fas fa-note-sticky me-2"></i>Notiz hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="noteTitle" class="form-control mb-2" placeholder="Titel (optional)" aria-label="Titel der Notiz">
                <textarea id="noteContent" class="form-control" rows="4" placeholder="Ihre Notiz" aria-label="Inhalt der Notiz"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addTextBlock()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customToolModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="customToolModalTitle">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customToolModalTitle">Eigenes Tool ergänzen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="customToolName" class="form-control mb-2" placeholder="Name (z.B. Experten-Interview)" aria-label="Name des Tools">
                <input type="text" id="customToolInfo" class="form-control mb-2" placeholder="Beschreibung für Mouseover" aria-label="Beschreibung des Tools">
                <input type="text" id="customToolUrl" class="form-control mb-2" placeholder="URL (optional)" aria-label="URL des Tools">
                <div class="mb-2">
                    <label for="customToolCategory" class="form-label">Bereich (Mehrfachauswahl möglich)</label>
                    <select id="customToolCategory" class="form-select" multiple size="6"></select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="customToolIsAi">
                    <label class="form-check-label" for="customToolIsAi">
                        KI-Tool
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="customToolIsLib">
                    <label class="form-check-label" for="customToolIsLib">
                        Uni-Lizenz
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="customToolSubmitBtn" onclick="addCustomTool()">Hinzufügen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="licensedDbModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="licensedDbModalLabel" aria-describedby="licensedDbDescription">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="licensedDbModalLabel"><i class="fas fa-database me-2"></i>Lizenzierte Datenbank ergänzen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label for="licensedDbSelect" class="form-label">Datenbank auswählen</label>
                        <select id="licensedDbSelect" class="form-select" size="10"></select>
                    </div>
                    <div class="col-md-7">
                        <div class="border rounded p-3 h-100 bg-light" id="licensedDbDetails">
                            <h6 class="fw-bold mb-2" id="licensedDbTitle">Datenbank wählen</h6>
                            <p class="mb-2 small text-muted" id="licensedDbDescription">Wählen Sie links eine Datenbank aus, um Details zu sehen.</p>
                            <div class="small" id="licensedDbBadges"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addLicensedDatabase()">Zum Hangar hinzufügen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="kiSourcesModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="kiSourcesModalLabel" aria-describedby="kiSourcesModalDesc">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border border-warning shadow-lg">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title" id="kiSourcesModalLabel">
                    <i class="fas fa-shield-alt text-warning me-2"></i>
                    Reflektierter Umgang mit KI & Quellen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="ki-callout d-flex align-items-start gap-3 mb-3" id="kiSourcesModalDesc">
                    <div class="icon-wrap"><i class="fas fa-triangle-exclamation"></i></div>
                    <div>
                        <div class="fw-bold text-warning mb-1">Verantwortungsvoll entscheiden</div>
                        <div class="text-muted small">Nutzen Sie KI nur, wenn Sie Quellen prüfen, Rechte klären und transparent kennzeichnen. Dieser Check hilft, Risiken früh zu erkennen.</div>
                    </div>
                </div>

                <ul class="nav nav-pills" id="kiSourcesTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="ki-reflexion-tab" data-bs-toggle="pill" data-bs-target="#ki-reflexion" type="button" role="tab" aria-controls="ki-reflexion" aria-selected="true">
                            <i class="fas fa-brain me-1"></i> KI-Reflexion
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="craap-tab" data-bs-toggle="pill" data-bs-target="#craap" type="button" role="tab" aria-controls="craap" aria-selected="false">
                            <i class="fas fa-clipboard-check me-1"></i> CRAAP-Test
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="ki-reflexion" role="tabpanel" aria-labelledby="ki-reflexion-tab">
                        <div class="ki-callout mb-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fas fa-lightbulb text-warning"></i>
                                <span class="fw-semibold">KI-Reflexion</span>
                            </div>
                            <p class="mb-2 small text-muted">Gehen Sie diese Fragen vor Nutzung von KI-basierten Ergebnissen durch.</p>
                            <ul class="list-group ki-checklist">
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-circle-check text-warning mt-1"></i>
                                        <div>
                                            <div class="fw-semibold">Habe ich die Fakten verifiziert?</div>
                                            <div class="text-muted small">Prüfen Sie jede Aussage mit Primärquellen oder offiziellen Daten.</div>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-scale-balanced text-warning mt-1"></i>
                                        <div>
                                            <div class="fw-semibold">Darf ich die Ergebnisse verwenden?</div>
                                            <div class="text-muted small">Klären Sie Urheberrecht, Lizenzbedingungen und Datenschutz.</div>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-highlighter text-warning mt-1"></i>
                                        <div>
                                            <div class="fw-semibold">Wie muss ich das kennzeichnen?</div>
                                            <div class="text-muted small">Dokumentieren Sie Prompts, Tools und Versionen transparent.</div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="craap" role="tabpanel" aria-labelledby="craap-tab">
                        <div class="ki-callout">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fas fa-list-check text-warning"></i>
                                <span class="fw-semibold">CRAAP-Test (Checkliste)</span>
                            </div>
                            <p class="mb-2 small text-muted">Bewerten Sie Quellen systematisch, bevor Sie sie übernehmen.</p>
                            <ul class="list-group ki-checklist">
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-clock text-warning mt-1"></i>
                                        <div><div class="fw-semibold">Currency</div><div class="text-muted small">Wie aktuell sind Daten und Publikation?</div></div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-bullseye text-warning mt-1"></i>
                                        <div><div class="fw-semibold">Relevance</div><div class="text-muted small">Passt der Inhalt genau zu Ihrer Fragestellung?</div></div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-user-tie text-warning mt-1"></i>
                                        <div><div class="fw-semibold">Authority</div><div class="text-muted small">Wer steht hinter der Quelle und ist sie qualifiziert?</div></div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-check-double text-warning mt-1"></i>
                                        <div><div class="fw-semibold">Accuracy</div><div class="text-muted small">Sind Aussagen belegt, konsistent und nachvollziehbar?</div></div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="fas fa-bullhorn text-warning mt-1"></i>
                                        <div><div class="fw-semibold">Purpose</div><div class="text-muted small">Warum existiert die Quelle? Information, Verkauf, Meinung?</div></div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="text-muted small me-auto d-flex align-items-center gap-2">
                    <i class="fas fa-circle-exclamation text-warning"></i>
                    Dokumentieren Sie Entscheidungen in Ihren Notizen.
                </div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === STATE & KONFIGURATION ===
    const EXPORT_SCHEMA_VERSION = '1.0';

    const categories = {
        'Assistants': { icon: 'fa-lightbulb', info: 'KI-Co-Piloten, die beim Brainstorming, Strukturieren und beim ersten Aufschlag von Textbausteinen unterstützen.' },
        'Finders': { icon: 'fa-search', info: 'Suchmaschinen, Datenbanken und Kataloge, mit denen Sie geeignete Quellen aufspüren und Trefferlisten filtern.' },
        'Connectors': { icon: 'fa-project-diagram', info: 'Tools zur Visualisierung und Vernetzung von Literatur, um Forschungsstränge und Schlüsselpublikationen sichtbar zu machen.' },
        'Analyzers': { icon: 'fa-microscope', info: 'Analysetools, die Texte zusammenfassen, erklären oder Inhalte aus PDFs und Artikeln herausarbeiten.' },
        'Evaluation': { icon: 'fa-check-double', info: 'Werkzeuge zur Bewertung von Qualität und Wirkung, z. B. Kontext zu Zitierungen oder Hinweise auf den wissenschaftlichen Konsens.' },
        'Writers': { icon: 'fa-pen-nib', info: 'Schreib- und Stilhilfen für saubere Formulierungen, Grammatikprüfungen und Feedback auf wissenschaftliche Texte.' },
        'Organize & Cite': { icon: 'fa-folder-open', info: 'Literaturverwaltungsprogramme zum Sammeln, Ordnen und Zitieren Ihrer Quellen in verschiedenen Zitationsstilen.' },
        'Notizen': { icon: 'fa-note-sticky', info: 'Eigene Merkzettel, um Zwischenergebnisse, Recherchewege und To-dos festzuhalten.' }
    };

    const HIDDEN_CATEGORIES = ['Notizen'];

    const flightPhases = {
        'PRE-FLIGHT': { icon: 'fa-clipboard-list', categories: ['Assistants', 'Notizen'] },
        'TAKE-OFF': { icon: 'fa-plane-departure', categories: ['Finders'] },
        'IN-FLIGHT': { icon: 'fa-plane', categories: ['Analyzers', 'Connectors', 'Evaluation'] },
        'LANDING': { icon: 'fa-plane-arrival', categories: ['Writers', 'Organize & Cite'] }
    };

    const initialTools = [
        { id: 't1', name: 'ChatGPT', cats: ['Assistants'], url: 'https://chat.openai.com', isAi: true, info: 'Brainstorming & Gliederung' },
        { id: 't2', name: 'Scispace', cats: ['Assistants'], url: 'https://www.scispace.com', isAi: true, info: 'KI-Schreibassistent' },
        { id: 't4', name: 'Swisscover RZS UNI/PH', cats: ['Finders'], url: 'https://rzs.swisscovery.slsp.ch/discovery/search?vid=41SLSP_RZS:VU07', isAi: false, info: 'Bibliothekskatalog Schweiz', isLib: true },
        { id: 't5', name: 'Elicit', cats: ['Finders'], url: 'https://elicit.org', isAi: true, info: 'Findet Paper und extrahiert Kernaussagen' },
        { id: 't6', name: 'Google Scholar', cats: ['Finders'], url: 'https://scholar.google.com', isAi: false, info: 'Breite Suche nach wissenschaftlichen Texten' },
        { id: 't7', name: 'EconLit', cats: ['Finders'], url: 'https://www.aeaweb.org/econlit', isAi: false, info: 'Fachportal Wirtschaft', isLib: true },
        { id: 't8', name: 'ResearchRabbit', cats: ['Connectors'], url: 'https://researchrabbit.ai', isAi: true, info: 'Visualisiert Literatur-Netzwerke' },
        { id: 't9', name: 'Connected Papers', cats: ['Connectors'], url: 'https://www.connectedpapers.com', isAi: false, info: 'Zeigt verwandte Arbeiten grafisch an' },
        { id: 't10', name: 'Explainpaper', cats: ['Analyzers'], url: 'https://www.explainpaper.com', isAi: true, info: 'Erklärt komplexe Textstellen' },
        { id: 't11', name: 'Humata', cats: ['Analyzers'], url: 'https://humata.ai', isAi: true, info: 'Chatte mit deinen PDFs' },
        { id: 't12', name: 'PDF.ai', cats: ['Analyzers'], url: 'https://pdf.ai', isAi: true, info: 'PDF Analyse Tool' },
        { id: 't13', name: 'Writefull', cats: ['Writers'], url: 'https://writefull.com', isAi: true, info: 'Akademische Sprachprüfung' },
        { id: 't14', name: 'Paperpal', cats: ['Writers'], url: 'https://paperpal.com', isAi: true, info: 'Echtzeit-Schreibfeedback' },
        { id: 't15', name: 'DeepL Write', cats: ['Writers'], url: 'https://www.deepl.com/write', isAi: true, info: 'Sprachoptimierung' },
        { id: 't18', name: 'Zotero', cats: ['Organize & Cite'], url: 'https://www.zotero.org', isAi: false, info: 'Literaturverwaltung (Open Source)' },
        { id: 't19', name: 'Citavi', cats: ['Organize & Cite'], url: 'https://www.citavi.com', isAi: false, info: 'Literaturverwaltung' },
        { id: 't20', name: 'Scite_', cats: ['Evaluation', 'Finders'], url: 'https://scite.ai', isAi: true, info: 'Smart Citations - wie wurde zitiert?', isLib: true },
        { id: 't21', name: 'Consensus', cats: ['Evaluation', 'Finders'], url: 'https://consensus.app', isAi: true, info: 'Wissenschaftlicher Konsens finden', isLib: true }
    ];

    const licensedDatabases = [
        { id: 'lic1', name: 'Academic Search Ultimate (EBSCOhost)', url: 'https://dbis.ur.de/ZHBLU/resources/101844', info: 'Multidisziplinäre Volltextdatenbank mit mehr als 9 200 Zeitschriften (über 8 400 peer-reviewed), zahlreichen Magazinen und rund 60 000 Videos seit 1930', cats: ['Finders'], isLib: true },
        { id: 'lic2', name: 'Blackwell Reference Online', url: 'https://dbis.ur.de/ZHBLU/resources/7081', info: 'Sammlung von Referenzwerken aus den Geistes- und Sozialwissenschaften (z. B. Classics, History, Language & Linguistics, Philosophy & Religion, Sociology & Anthropology)', cats: ['Finders'], isLib: true },
        { id: 'lic3', name: 'Business Source Premier', url: 'https://dbis.ur.de/ZHBLU/resources/1333', info: 'Wirtschaftswissenschaftliche Datenbank mit Volltexten aus mehr als 2 200 Zeitschriften und Magazinen, Firmenprofilen, Marktstudien und SWOT-Analysen.', cats: ['Finders'], isLib: true },
        { id: 'lic4', name: 'CEPR Discussion Papers', url: 'https://dbis.ur.de/ZHBLU/resources/12587', info: 'Working-Paper-Reihe des Centre for Economic Policy Research, in der renommierte Ökonominnen und Ökonomen aktuelle Forschungsarbeiten publizieren.', cats: ['Finders'], isLib: true, isOA: true },
        { id: 'lic5', name: 'Duden Sprachwissen (Munzinger-Portal)', url: 'https://dbis.ur.de/ZHBLU/resources/11752', info: 'Enthält die Standardwerke der Duden-Reihe (u. a. Rechtschreibung, Fremdwörterbuch, Stilwörterbuch), die prägnant sprachliche Fragen beantworten.', cats: ['Finders'], isLib: true },
        { id: 'lic6', name: 'EconLit', url: 'https://dbis.ur.de/ZHBLU/resources/36', info: 'Datenbank der American Economic Association, die seit 1969 wirtschaftswissenschaftliche Veröffentlichungen verzeichnet und rund 750 Zeitschriften, Bücher, Sammelwerke und Dissertationen auswertet', cats:['Finders'], isLib: true },
        { id: 'lic7', name: 'Encyclopedia of Health Economics', url: 'https://dbis.ur.de/ZHBLU/resources/100301', info: 'Dreibändiges Nachschlagewerk über Gesundheitsökonomie, das ökonomische Analysen des Gesundheitssystems, der Gesundheitsversorgung und -politik bietet.', cats: ['Finders'], isLib: true },
        { id: 'lic8', name: 'Factiva', url: 'https://dbis.ur.de/ZHBLU/resources/4042', info: 'Dow-Jones-Datenbank für internationale Nachrichten und Wirtschaftsinformationen mit Presseartikeln, Nachrichtendiensten und Unternehmensmeldungen.', cats: ['Finders'], isLib:true },
        { id: 'lic9', name: 'International Bibliography of the Social Sciences (IBSS)', url: 'https://dbis.ur.de/ZHBLU/resources/1030', info: 'Bibliografische Datenbank von ProQuest, die internationale Literatur aus Soziologie, Politikwissenschaft, Wirtschaft und Anthropologie verzeichnet.', cats: ['Finders'], isLib: true },
        { id: 'lic10', name: 'International Encyclopedia of the Social & Behavioral Sciences (2. Ausgabe)', url: 'https://dbis.ur.de/ZHBLU/resources/100776', info: 'Umfassende Enzyklopädie der Sozial- und Verhaltenswissenschaften; Beiträge renommierter Forschender erklären Grundlagen, Theorien und Methoden.', cats: ['Finders'], isLib: true },
        { id: 'lic11', name: 'International Encyclopedia of the Social & Behavioral Sciences (1. Ausgabe)', url: 'https://dbis.ur.de/ZHBLU/resources/1313', info: 'Erste Ausgabe der groß angelegten Elsevier-Enzyklopädie, die die Sozial- und Verhaltenswissenschaften in zahlreichen Artikeln zusammenfasst.', cats: ['Finders'], isLib: true },
        { id: 'lic12', name: 'JSTOR Journals', url: 'https://dbis.ur.de/ZHBLU/resources/8957', info: 'Digitales Archiv, das Volltext-Backfiles wissenschaftlicher Zeitschriften aus den Geistes-, Sozial- und Naturwissenschaften bereitstellt.', cats: ['Finders'], isLib: true },
        { id: 'lic13', name: 'Kluwer Law Online', url: 'https://dbis.ur.de/ZHBLU/resources/100367', info: 'Plattform von Wolters Kluwer mit Zeitschriften und Handbüchern zu internationalem Recht sowie Kommentaren und Fallanalysen.', cats: ['Finders'], isLib: true },
        { id: 'lic14', name: 'Lexology Pro', url: 'https://dbis.ur.de/ZHBLU/resources/103456', info: 'Informationsdienst mit Fachartikeln von Anwaltskanzleien über Gesetzesänderungen und juristische Entwicklungen weltweit.', cats: ['Finders'], isLib: true },
        { id: 'lic15', name: 'LinkedIn Learning', url: 'https://dbis.ur.de/ZHBLU/resources/103054', info: 'Lernplattform mit Videokursen zu Business-, Technologie- und Kreativthemen, moderiert von Branchenexpertinnen und -experten.', cats: ['Finders'], isLib: true },
        { id: 'lic16', name: 'Munzinger Online / Länder', url: 'https://dbis.ur.de/ZHBLU/resources/2165', info: 'Deutsches Nachschlagewerk mit Länderprofilen, aktuellen Daten und Hintergrundinformationen zu Staaten, Organisationen und Persönlichkeiten.', cats: ['Finders'], isLib: true },
        { id: 'lic17', name: 'NBER Working Papers', url: 'https://dbis.ur.de/ZHBLU/resources/9453', info: 'Veröffentlichungsreihe des National Bureau of Economic Research, die aktuelle ökonomische Forschungsergebnisse vorab zugänglich macht.', cats: ['Finders'], isLib: true },
        { id: 'lic18', name: 'New Palgrave Dictionary of Economics', url: 'https://dbis.ur.de/ZHBLU/resources/8045', info: 'Enzyklopädisches Wörterbuch der Ökonomie mit Artikeln zu wirtschaftstheoretischen Konzepten, Methoden und ökonomischen Schulen.', cats: ['Finders'], isLib: true },
        { id: 'lic19', name: 'New York Times / ProQuest Historical Newspapers', url: 'https://dbis.ur.de/ZHBLU/resources/101464', info: 'Bietet digitalisierte Ausgaben der New York Times ab 1851 – nützlich für wirtschaftshistorische Recherchen.', cats: ['Finders'], isLib: true },
        { id: 'lic20', name: 'Nexis Uni', url: 'https://dbis.ur.de/ZHBLU/resources/1670', info: 'Rechercheplattform von LexisNexis mit Nachrichtenquellen, Rechtsfällen, Unternehmensdaten und juristischen Fachartikeln für die Hochschullehre.', cats: ['Finders'], isLib: true },
        { id: 'lic21', name: 'Orbis – weltweite Unternehmensdaten', url: 'https://dbis.ur.de/ZHBLU/resources/100120', info: 'Unternehmensdatenbank von Bureau van Dijk mit Finanzdaten, Beteiligungsstrukturen und Vergleichskennzahlen für Millionen Firmen weltweit.', cats: ['Finders'], isLib: true },
        { id: 'lic22', name: 'Oxford Reference', url: 'https://dbis.ur.de/ZHBLU/resources/3107', info: 'Sammlung von Wörterbüchern und Enzyklopädien der Oxford University Press zu verschiedenen Fachgebieten.', cats: ['Finders'], isLib: true },
        { id: 'lic23', name: 'Oxford Research Encyclopedia – Global Public Health', url: 'https://dbis.ur.de/ZHBLU/resources/105738', info: 'Begutachtete Forschungsenzyklopädie mit Artikeln über globale Gesundheitspolitik, Prävention, Epidemiologie und Gesundheitsversorgung.', cats: ['Finders'], isLib: true },
        { id: 'lic24', name: 'Oxford Research Encyclopedia – Climate Science', url: 'https://dbis.ur.de/ZHBLU/resources/103364', info: 'Online-Enzyklopädie mit wissenschaftlichen Übersichtsartikeln zu Klimaforschung, Klimawandel, Klimapolitik und Resilienz.', cats: ['Finders'], isLib: true },
        { id: 'lic25', name: 'Periodicals Archive Online', url: 'https://dbis.ur.de/ZHBLU/resources/7828', info: 'Archiv mit den Rückläufen von über 700 Zeitschriften der Geistes- und Sozialwissenschaften (mehr als 3 Mio. Artikel und 15 Mio. Seiten)', cats: ['Finders'], isLib: true },
        { id: 'lic26', name: 'Policy Commons', url: 'https://dbis.ur.de/ZHBLU/resources/105297', info: 'Plattform, die über 3 Mio. Publikationen von Politikexpertinnen, Think Tanks, IGOs und NGOs systematisch auffindbar macht', cats: ['Finders'], isLib: true },
        { id: 'lic27', name: 'ScienceDirect', url: 'https://dbis.ur.de/ZHBLU/resources/801', info: 'Elsevier-Plattform mit elektronischen Zeitschriften und eBooks; sie ermöglicht simultane oder getrennte Suche und Volltextzugriff je nach Lizenz', cats: ['Finders'], isLib: true },
        { id: 'lic28', name: 'Scite', url: 'https://dbis.ur.de/ZHBLU/resources/104874', info: 'KI-gestützte Zitationsdatenbank, die den Kontext von Zitierungen analysiert und Zitate als unterstützend, widersprechend oder erwähnend klassifiziert', cats: ['Evaluation', 'Finders'], isLib: true, isAi: true },
        { id: 'lic29', name: 'Statista', url: 'https://dbis.ur.de/ZHBLU/resources/9808', info: 'Statistikportal, das Daten aus zahlreichen Instituten und Quellen bündelt; der Volltextzugriff richtet sich nach dem Lizenzumfang der Einrichtung.', cats: ['Finders'], isLib: true },
        { id: 'lic30', name: 'Tax Treaties Database (IBFD)', url: 'https://dbis.ur.de/ZHBLU/resources/8580', info: 'Datenbank des International Bureau of Fiscal Documentation (IBFD) mit über 5 000 geltenden Steuerabkommen, Protokollen und Verhandlungsdokumenten sowie Vergleichstabellen.', cats: ['Finders'], isLib: true, isOA: false },
        { id: 'lic31', name: 'UN iLibrary', url: 'https://dbis.ur.de/ZHBLU/resources/101214', info: 'Bibliothek der Vereinten Nationen mit Büchern, Zeitschriften, Arbeitspapieren und Statistiken zu UN-Themen in verschiedenen Sprachen.', cats: ['Finders'], isLib: true },
        { id: 'lic32', name: 'WEKA Business Portal', url: 'https://dbis.ur.de/ZHBLU/resources/8661', info: 'Praxisorientiertes Informationsportal der WEKA-Verlagsgruppe mit Fachinformationen, Vorlagen und eLearning-Materialien zu Recht, Steuern und Unternehmensführung.', cats: ['Finders'], isLib: true },
        { id: 'lic33', name: 'Web of Science / Social Sciences Citation Index', url: 'https://dbis.ur.de/ZHBLU/resources/360', info: 'Aufsatzdatenbank, die mehr als 3,45 Mio. Titel nachweist und Beiträge aus über 50 Sozial- und Nachbardisziplinen auswertet', cats: ['Finders'], isLib: true },
        { id: 'lic34', name: 'Web of Science Core Collection', url: 'https://dbis.ur.de/ZHBLU/resources/2142', info: 'Multidisziplinäre Zitationsdatenbank mit Informationen aus Tausenden wissenschaftlicher Zeitschriften, Büchern und Konferenzen', cats: ['Finders'], isLib: true },
        { id: 'lic35', name: 'Wiley Online Library', url: 'https://dbis.ur.de/ZHBLU/resources/838', info: 'Plattform des Wiley-Verlags mit über 1 500 Fachzeitschriften und mehr als 20 000 eBooks aus den Natur-, Gesundheits- und Sozialwissenschaften', cats: ['Finders'], isLib: true },
        { id: 'lic36', name: 'WorldTradeLaw.net', url: 'https://dbis.ur.de/ZHBLU/resources/4825', info: 'Datenbank mit WTO- und GATT-Schiedsspruchtexten, Analysen und Kommentarmaterialien zur internationalen Handelspolitik', cats: ['Finders'], isLib: true },
        { id: 'lic37', name: 'wiso', url: 'https://dbis.ur.de/ZHBLU/resources/1232', info: 'Deutschsprachige Plattform mit Literaturhinweisen, E-Books und Fachzeitschriften zu Wirtschaft und Sozialwissenschaften; ergänzt um Module zur Betriebswirtschaftspraxis, Lecturio-Erklärvideos und das Statistikportal Tilasto', cats: ['Finders'], isLib: true },
        { id: 'lic38', name: 'Statistical Portal OECD Data Explorer', url: 'https://dbis.ur.de/ZHBLU/resources/106121', info: 'Interaktive Plattform der OECD, mit der sich sozioökonomische Kennzahlen verschiedener Länder vergleichen und visualisieren lassen.', cats: ['Finders'], isLib: true, isOA: true }
    ].map(db => ({ isOA: false, ...db }));

    const LEGACY_CATEGORY_MAP = { 'Verwaltung': 'Organize & Cite' };
    const dropTargets = ['phase-1', 'phase-2', 'phase-3', 'phase-4', 'phase-5', 'phase-6', 'phase-global'];
    const CUSTOM_TOOLS_KEY = 'customTools';
    const MAX_IMPORT_FILE_SIZE_BYTES = 2 * 1024 * 1024;
    const ORIENTATION_HIGHLIGHT_CLASS = 'orientation-highlight';

    let pendingAiElement = null;
    let aiModal = null;
    let textModal = null;
    let orientationModal = null;
    let orientationFocusTrapCleanup = null;
    let lastFocusedElement = null;
    let targetPhaseForNote = null;
    let deletedTools = [];
    let currentSearchTerm = '';
    let currentCategoryFilter = '';
    let currentEditingCustomToolId = null;
    let toastContainer = null;

    // === HELPERS ===
    function normalizeCategoriesList(cats) {
        const mapped = (Array.isArray(cats) ? cats : [])
            .map(cat => LEGACY_CATEGORY_MAP[cat] || cat)
            .filter(Boolean)
            .filter(cat => cat !== 'Lizenziert');
        return mapped.length ? mapped : ['Organize & Cite'];
    }

    function deriveCategoriesForTool(toolData = {}) {
        const normalizedCats = normalizeCategoriesList(toolData.cats);
        return Array.from(new Set(normalizedCats));
    }

    function getFilterableCategories() {
        return Object.keys(categories)
            .filter(catKey => !HIDDEN_CATEGORIES.includes(catKey));
    }

    function escapeHtml(str) {
        if(!str) return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function normalizeName(name) {
        return (name || '').toLowerCase().replace(/[_\s]+$/, '').trim();
    }

    function isCustomToolData(toolData) {
        return !!(toolData && (toolData.isCustom === true || toolData.isCustom === 'true' || toolData.isCustom === 1 || toolData.isCustom === '1'));
    }

    function sanitizeTooltipHtml(content) {
        if(!content) return '';
        const temp = document.createElement('div');
        temp.innerHTML = content;
        const allowedTags = ['B', 'STRONG', 'EM', 'I', 'BR', 'P', 'UL', 'OL', 'LI'];
        temp.querySelectorAll('*').forEach(el => {
            if(!allowedTags.includes(el.tagName)) {
                el.replaceWith(document.createTextNode(el.textContent));
            } else {
                Array.from(el.attributes).forEach(attr => el.removeAttribute(attr.name));
            }
        });
        return temp.innerHTML;
    }

    function stripHtml(content) {
        if(!content) return '';
        const temp = document.createElement('div');
        temp.innerHTML = content;
        return temp.textContent || temp.innerText || '';
    }

    function sanitizeToolData(toolData) {
        const normalizedCats = toolData.type === 'text'
            ? ((toolData.cats && toolData.cats.length) ? normalizeCategoriesList(toolData.cats) : ['Notizen'])
            : deriveCategoriesForTool(toolData);
        return {
            id: toolData.id || toolData.uniqueId || ('restored-' + Date.now()),
            name: toolData.name || 'Unbenanntes Tool',
            cats: normalizedCats,
            url: toolData.url || '#',
            info: toolData.info || 'Gelöscht',
            isAi: !!toolData.isAi,
            isLib: !!toolData.isLib,
            isOA: !!toolData.isOA,
            isCustom: !!toolData.isCustom,
            type: toolData.type || 'tool',
            text: toolData.text || ''
        };
    }

    function trapFocusWithin(modalEl) {
        if(!modalEl) return () => {};
        const selectors = ['a[href]', 'button:not([disabled])', 'textarea:not([disabled])', 'input:not([disabled])', 'select:not([disabled])', '[tabindex]:not([tabindex="-1"])'];
        const focusable = Array.from(modalEl.querySelectorAll(selectors.join(',')))
            .filter(el => el.offsetParent !== null && !el.hasAttribute('aria-hidden'));

        if(!focusable.length) return () => {};

        const first = focusable[0];
        const last = focusable[focusable.length - 1];

        const handleKeydown = (event) => {
            if(event.key === 'Tab') {
                if(event.shiftKey && document.activeElement === first) {
                    event.preventDefault();
                    last.focus();
                } else if(!event.shiftKey && document.activeElement === last) {
                    event.preventDefault();
                    first.focus();
                }
            }

            if(event.key === 'Escape') {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if(modalInstance) modalInstance.hide();
            }
        };

        modalEl.addEventListener('keydown', handleKeydown);
        requestAnimationFrame(() => first.focus());

        return () => modalEl.removeEventListener('keydown', handleKeydown);
    }

    const orientationOnboardingSteps = {
        drag: ['.hangar-area', '.phase-col'],
        export: ['#flightControlsButton', '#savePdfButton', '#exportJsonButton', '#importJsonButton']
    };

    function clearOrientationHighlights() {
        document.querySelectorAll('.' + ORIENTATION_HIGHLIGHT_CLASS).forEach(el => {
            el.classList.remove(ORIENTATION_HIGHLIGHT_CLASS);
            el.removeAttribute('data-onboarding-step');
        });
    }

    function applyOnboardingStep(stepKey) {
        clearOrientationHighlights();
        const targets = orientationOnboardingSteps[stepKey];
        if(!targets) return;
        let firstHighlighted = null;
        targets.forEach(selector => {
            document.querySelectorAll(selector).forEach(el => {
                if(!firstHighlighted) firstHighlighted = el;
                el.classList.add(ORIENTATION_HIGHLIGHT_CLASS);
                el.setAttribute('data-onboarding-step', stepKey);
            });
        });
        if(firstHighlighted && typeof firstHighlighted.scrollIntoView === 'function') {
            firstHighlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function buildToolDataFromCard(cardEl) {
        if(!cardEl) return null;
        const cats = cardEl.dataset.cats ? cardEl.dataset.cats.split('|').filter(Boolean) : [];
        return {
            id: cardEl.dataset.baseId || cardEl.id,
            name: cardEl.dataset.name || (cardEl.querySelector('.fw-bold') ? cardEl.querySelector('.fw-bold').innerText : 'Tool'),
            info: cardEl.dataset.info || '',
            url: cardEl.dataset.url || '#',
            cats: cats.length ? cats : ['Organize & Cite'],
            isAi: cardEl.dataset.isAi === '1' || cardEl.dataset.isAi === 'true',
            isLib: cardEl.dataset.isLib === '1' || cardEl.dataset.isLib === 'true',
            isOA: cardEl.dataset.isOa === '1' || cardEl.dataset.isOa === 'true',
            isCustom: cardEl.dataset.isCustom === '1' || cardEl.dataset.isCustom === 'true',
            type: cardEl.dataset.type || 'tool',
            text: cardEl.dataset.text || '',
            uniqueId: cardEl.id
        };
    }

    function handleCardRemoval(cardEl) {
        if(!cardEl) return;
        const parent = cardEl.parentElement;
        const origin = parent && dropTargets.includes(parent.id) ? 'cockpit' : 'hangar';
        const toolData = buildToolDataFromCard(cardEl);
        if(!toolData) return;

        cardEl.remove();

        if(pendingAiElement === cardEl) {
            pendingAiElement = null;
        }

        if(origin === 'cockpit') {
            addToDeleted(toolData);
            saveState();
        } else {
            if(toolData.isCustom) {
                const index = initialTools.findIndex(t => t.id === toolData.id);
                if(index >= 0) initialTools.splice(index, 1);
                document.querySelectorAll(`[data-base-id="${toolData.id}"]`).forEach(el => {
                    if(el !== cardEl) el.remove();
                });
                saveCustomTools();
            }
            addToDeleted(toolData);
        }

        showToast("Tool entfernt (in 'Gelöschte Tools & Notizen' wiederherstellbar).", 'info');
    }

    // === TOASTS ===
    function getToastContainer() {
        if(toastContainer && document.body.contains(toastContainer)) return toastContainer;

        let container = document.getElementById('toast-container');
        if(!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container no-print';
            container.setAttribute('aria-live', 'polite');
            container.setAttribute('aria-atomic', 'true');
            document.body.appendChild(container);
        }

        toastContainer = container;
        return container;
    }

    function removeToastElement(toastEl) {
        if(!toastEl) return;
        toastEl.classList.remove('show');
        setTimeout(() => {
            if(toastEl && toastEl.parentElement) {
                toastEl.parentElement.removeChild(toastEl);
            }
        }, 180);
    }

    function showToast(message, type = 'info', timeoutMs = 3000) {
        const container = getToastContainer();
        const normalizedType = ['success', 'info', 'error'].includes(type) ? type : 'info';
        const safeMessage = typeof message === 'string' ? message : String(message ?? '');

        const toastEl = document.createElement('div');
        toastEl.className = `toast-item toast-${normalizedType}`;
        toastEl.setAttribute('role', normalizedType === 'error' ? 'alert' : 'status');
        toastEl.setAttribute('aria-live', normalizedType === 'error' ? 'assertive' : 'polite');
        toastEl.setAttribute('aria-label', `${normalizedType === 'error' ? 'Fehler' : 'Hinweis'}: ${safeMessage}`);
        toastEl.tabIndex = 0;

        const iconMap = { success: 'fa-circle-check', info: 'fa-circle-info', error: 'fa-triangle-exclamation' };
        const titleMap = { success: 'Erfolg', info: 'Hinweis', error: 'Fehler' };

        const icon = document.createElement('div');
        icon.className = 'toast-icon';
        icon.innerHTML = `<i class="fas ${iconMap[normalizedType]}"></i>`;

        const contentWrap = document.createElement('div');
        contentWrap.className = 'toast-content';

        const titleEl = document.createElement('div');
        titleEl.className = 'toast-title';
        titleEl.textContent = titleMap[normalizedType];

        const messageEl = document.createElement('div');
        messageEl.className = 'toast-message';
        messageEl.textContent = safeMessage;

        contentWrap.appendChild(titleEl);
        contentWrap.appendChild(messageEl);

        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'toast-close';
        closeBtn.setAttribute('aria-label', 'Toast schließen');
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';

        let hideTimer = null;
        const safeTimeout = Number.isFinite(timeoutMs) && timeoutMs > 0 ? timeoutMs : 3000;
        hideTimer = setTimeout(() => removeToastElement(toastEl), safeTimeout);

        closeBtn.addEventListener('click', () => {
            if(hideTimer) clearTimeout(hideTimer);
            removeToastElement(toastEl);
        });

        toastEl.addEventListener('pointerenter', () => {
            if(hideTimer) {
                clearTimeout(hideTimer);
                hideTimer = null;
            }
        });

        toastEl.addEventListener('pointerleave', () => {
            if(!hideTimer && safeTimeout > 0) {
                hideTimer = setTimeout(() => removeToastElement(toastEl), safeTimeout);
            }
        });

        toastEl.addEventListener('keydown', (event) => {
            if(event.key === 'Escape') {
                removeToastElement(toastEl);
            }
        });

        toastEl.appendChild(icon);
        toastEl.appendChild(contentWrap);
        toastEl.appendChild(closeBtn);
        container.appendChild(toastEl);

        requestAnimationFrame(() => toastEl.classList.add('show'));
        return toastEl;
    }

    // === GELÖSCHTE ELEMENTE ===
    function renderDeletedList() {
        const container = document.getElementById('deleted-list');
        if(!container) return;

        if(!deletedTools.length) {
            container.className = 'deleted-empty';
            container.textContent = 'Noch nichts gelöscht';
            return;
        }

        container.className = '';
        container.innerHTML = '';

        deletedTools.forEach((tool, index) => {
            const item = document.createElement('div');
            item.className = 'deleted-item';

            const infoWrapper = document.createElement('div');
            const titleEl = document.createElement('div');
            titleEl.className = 'fw-bold';
            titleEl.textContent = tool.name;

            const metaEl = document.createElement('div');
            metaEl.className = 'meta';
            metaEl.textContent = tool.type === 'text'
                ? (tool.text ? tool.text.slice(0, 80) : 'Notiz')
                : (tool.cats || []).join(', ');

            infoWrapper.appendChild(titleEl);
            infoWrapper.appendChild(metaEl);
            item.appendChild(infoWrapper);

            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'btn btn-sm btn-outline-success';
            restoreBtn.innerHTML = '<i class="fas fa-undo"></i>';
            restoreBtn.title = 'Tool zurück in den Hangar';
            restoreBtn.setAttribute('aria-label', `Tool wiederherstellen: ${tool.name}`);
            restoreBtn.addEventListener('click', () => restoreDeletedTool(index));

            item.appendChild(restoreBtn);
            container.appendChild(item);
        });
    }

    function saveDeletedState() {
        localStorage.setItem('cockpitDeleted_v1', JSON.stringify(deletedTools));
    }

    function loadDeletedState() {
        const stored = localStorage.getItem('cockpitDeleted_v1');
        if(stored) {
            deletedTools = JSON.parse(stored);
        }
        renderDeletedList();
    }

    function addToDeleted(toolData) {
        const sanitized = sanitizeToolData(toolData);
        deletedTools = [sanitized, ...deletedTools.filter(t => !(t.id === sanitized.id && t.name === sanitized.name))].slice(0, 25);
        saveDeletedState();
        renderDeletedList();
    }

    function restoreDeletedTool(index) {
        const tool = deletedTools.splice(index, 1)[0];
        if(!tool) return;

        if(tool.type === 'text' && (!tool.cats || !tool.cats.length)) {
            tool.cats = ['Notizen'];
        }

        if(!initialTools.find(t => t.id === tool.id)) {
            initialTools.push(tool);
        }

        renderHangar();
        saveDeletedState();
        renderDeletedList();
    }

    function restoreAllDeleted() {
        if(!deletedTools.length) return;

        deletedTools.forEach(tool => {
            if(tool.type === 'text' && (!tool.cats || !tool.cats.length)) {
                tool.cats = ['Notizen'];
            }
            if(!initialTools.find(t => t.id === tool.id)) {
                initialTools.push(tool);
            }
        });

        deletedTools = [];
        renderHangar();
        saveDeletedState();
        renderDeletedList();
    }

    // === RENDERING ===
    function renderHangar() {
        const pool = document.getElementById('tool-pool');
        if(!pool) return;
        pool.innerHTML = '';

        const searchTerm = currentSearchTerm;
        const selectedCategory = currentCategoryFilter;

        Object.entries(flightPhases).forEach(([phaseName, meta]) => {
            const phaseCategories = meta.categories || [];
            const categoriesWithTools = [];

            phaseCategories.forEach(catKey => {
                const catTools = initialTools.filter(tool => {
                    const toolCategories = deriveCategoriesForTool(tool);
                    const hasCategory = toolCategories.includes(catKey);
                    if(!hasCategory) return false;

                    const matchesCategoryFilter = !selectedCategory
                        || toolCategories.includes(selectedCategory);
                    if(!matchesCategoryFilter) return false;

                    if(!searchTerm) return true;

                    const haystack = `${tool.name || ''} ${tool.info || ''} ${toolCategories.join(' ')}`.toLowerCase();
                    return haystack.includes(searchTerm);
                });

                if(catTools.length) {
                    categoriesWithTools.push({ catKey, catTools });
                }
            });

            if(!categoriesWithTools.length) return;

            const phaseHeader = document.createElement('h5');
            phaseHeader.className = 'mt-3 mb-2 d-flex align-items-center text-primary';
            const iconClass = (meta && meta.icon) ? meta.icon : 'fa-plane';
            phaseHeader.innerHTML = `<i class="fas ${iconClass} me-2"></i> ${phaseName}`;
            pool.appendChild(phaseHeader);

            categoriesWithTools.forEach(({ catKey, catTools }) => {
                const header = document.createElement('div');
                header.className = 'cat-header';
                const catIcon = (categories[catKey] && categories[catKey].icon) ? categories[catKey].icon : 'fa-tools';
                header.innerHTML = `<i class="fas ${catIcon} me-2"></i> ${catKey}`;
                pool.appendChild(header);

                catTools.forEach(tool => {
                    const instanceId = `${tool.id}-${catKey}`;
                    const enhancedTool = { ...tool, cats: deriveCategoriesForTool(tool), uniqueId: instanceId };
                    pool.appendChild(createToolElement(enhancedTool, 'hangar'));
                });
            });
        });
    }

    function populateCategoryOptions() {
        const select = document.getElementById('customToolCategory');
        if(!select) return;

        select.innerHTML = '';

        Object.keys(categories)
            .filter(catKey => !HIDDEN_CATEGORIES.includes(catKey))
            .forEach(catKey => {
            const option = document.createElement('option');
            option.value = catKey;
            option.textContent = catKey;
            select.appendChild(option);
        });
    }

    function populateFilterOptions() {
        const menu = document.getElementById('toolCategoryMenu');
        const trigger = document.getElementById('toolCategoryDropdownButton');
        const labelEl = trigger ? trigger.querySelector('.category-label') : null;
        if(!menu || !trigger || !labelEl) return;

        const filterableCategories = getFilterableCategories();

        const createMenuItem = (catKey, label, info, iconClass = 'fa-filter') => {
            const li = document.createElement('li');
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'dropdown-item d-flex align-items-start gap-2';
            button.dataset.categoryValue = catKey;
            button.dataset.bsToggle = 'tooltip';
            button.dataset.bsPlacement = 'right';
            const safeLabel = escapeHtml(label);
            const safeInfo = escapeHtml(info || '');
            button.dataset.bsTitle = safeInfo;
            button.innerHTML = `
                <i class="fas ${iconClass} text-primary mt-1"></i>
                <span class="text-start">
                    <span class="d-block fw-semibold">${safeLabel}</span>
                    <small class="text-muted lh-sm">${safeInfo}</small>
                </span>
            `;
            button.addEventListener('click', () => setCategoryFilter(catKey));

            li.appendChild(button);
            menu.appendChild(li);
        };

        menu.innerHTML = '';
        createMenuItem('', 'Alle Kategorien', 'Zeigt alle verfügbaren Tools');

        filterableCategories.forEach(catKey => {
            const meta = categories[catKey] || {};
            const icon = meta.icon || 'fa-tools';
            const info = meta.info || '';
            createMenuItem(catKey, catKey, info, icon);
        });

        setCategoryFilter(currentCategoryFilter, { render: false });
        initTooltips();
    }

    function setCategoryFilter(catKey, { render = true } = {}) {
        const trigger = document.getElementById('toolCategoryDropdownButton');
        const labelEl = trigger ? trigger.querySelector('.category-label') : null;
        if(!labelEl) return;

        const validCategories = getFilterableCategories();
        const normalizedCategory = validCategories.includes(catKey) ? catKey : '';

        currentCategoryFilter = normalizedCategory;
        labelEl.textContent = normalizedCategory || 'Alle Kategorien';

        if(render) {
            renderHangar();
        }
    }

    function populateLicensedDbSelect() {
        const select = document.getElementById('licensedDbSelect');
        if(!select) return;

        select.innerHTML = '';
        licensedDatabases.forEach(db => {
            const opt = document.createElement('option');
            opt.value = db.id;
            opt.textContent = db.name;
            select.appendChild(opt);
        });

        select.addEventListener('change', (e) => updateLicensedDbDetails(e.target.value));
        if(licensedDatabases.length) {
            select.value = licensedDatabases[0].id;
            updateLicensedDbDetails(licensedDatabases[0].id);
        }
    }

    function updateLicensedDbDetails(dbId) {
        const db = licensedDatabases.find(item => item.id === dbId);
        const titleEl = document.getElementById('licensedDbTitle');
        const descEl = document.getElementById('licensedDbDescription');
        const badgeEl = document.getElementById('licensedDbBadges');

        if(!db || !titleEl || !descEl || !badgeEl) return;

        titleEl.textContent = db.name;
        descEl.textContent = db.info || '';

        const badges = [];
        if(db.isLib) badges.push('<span class="status-badge badge-lib">Uni</span>');
        if(db.isAi) badges.push('<span class="status-badge badge-ai">KI</span>');
        if(db.isOA) badges.push('<span class="status-badge badge-oa">Open Access</span>');
        badgeEl.innerHTML = badges.join(' ');
    }

    function addLicensedDatabase() {
        const select = document.getElementById('licensedDbSelect');
        if(!select || !select.value) return;

        const db = licensedDatabases.find(item => item.id === select.value);
        if(!db) return;

        const alreadyExists = initialTools.some(tool => normalizeName(tool.name) === normalizeName(db.name));
        if(alreadyExists) {
            alert('Diese Datenbank befindet sich bereits im Hangar.');
            return;
        }

        const baseCats = db.cats && db.cats.length ? db.cats : ['Finders'];
        const normalizedDb = { ...db, isLib: true, cats: baseCats, isOA: !!db.isOA };
        const enhancedCats = deriveCategoriesForTool(normalizedDb);
        initialTools.push({ ...normalizedDb, cats: enhancedCats });
        renderHangar();

        const modalEl = document.getElementById('licensedDbModal');
        if(modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
        }
    }

    function createToolElement(toolData, origin) {
        const div = document.createElement('div');
        let classes = 'tool-card';
        if(toolData.isAi) classes += ' is-ai';
        if(toolData.isLib) classes += ' is-library';

        div.className = classes;
        div.draggable = true;

        const isText = toolData.type === 'text';
        const categoriesForTool = isText
            ? ((toolData.cats && toolData.cats.length) ? normalizeCategoriesList(toolData.cats) : ['Notizen'])
            : deriveCategoriesForTool(toolData);

        const uniqueId = toolData.uniqueId
            || (origin === 'hangar'
                ? toolData.id
                : 'c-' + Date.now() + Math.random().toString(16).slice(2));
        div.id = uniqueId;
        div.dataset.baseId = toolData.id;
        div.dataset.type = toolData.type || 'tool';
        div.dataset.name = toolData.name || '';
        div.dataset.info = toolData.info || '';
        div.dataset.url = toolData.url || '';
        div.dataset.cats = Array.isArray(categoriesForTool) ? categoriesForTool.join('|') : '';
        div.dataset.isAi = toolData.isAi ? '1' : '0';
        div.dataset.isLib = toolData.isLib ? '1' : '0';
        div.dataset.isOa = toolData.isOA ? '1' : '0';
        div.dataset.isCustom = isCustomToolData(toolData) ? '1' : '0';
        if(toolData.text) {
            div.dataset.text = toolData.text;
        }

        div.tabIndex = 0;

        const primaryCat = Array.isArray(categoriesForTool) && categoriesForTool.length ? categoriesForTool[0] : null;
        const iconClass = (primaryCat && categories[primaryCat] && categories[primaryCat].icon) ? categories[primaryCat].icon : 'fa-tools';

        if(isText) {
            const displayText = escapeHtml(toolData.text || toolData.info || '').replace(/\n/g, '<br>');
            const displayTitle = escapeHtml(toolData.name || 'Notiz');
            div.innerHTML = `
                <div class="tool-icon"><i class="fas fa-note-sticky"></i></div>
                <div class="flex-grow-1 tool-card-body">
                    <div class="d-flex tool-title-row">
                        <div class="fw-bold tool-title">${displayTitle}</div>
                    </div>
                    <div class="small text-muted text-wrap">${displayText || 'Kein Text hinterlegt'}</div>
                </div>
                <span class="status-badge badge bg-light text-muted border">Notiz</span>
            `;
        } else {
            const allowEdit = toolData.isCustom && origin === 'cockpit';
            const statusBadges = `
                ${toolData.isAi ? '<span class="status-badge badge-ai">KI</span>' : ''}
                ${toolData.isLib ? '<span class="status-badge badge-lib">Uni</span>' : ''}
                ${toolData.isOA ? '<span class="status-badge badge-oa">Open Access</span>' : ''}
            `;

            const categoryList = Array.isArray(categoriesForTool) && categoriesForTool.length
                ? escapeHtml(categoriesForTool.join(', '))
                : 'Allgemein';

            const safeName = escapeHtml(toolData.name || 'Unbenanntes Tool');
            const rawInfo = toolData.info || '';
            const tooltipHtml = sanitizeTooltipHtml(rawInfo);
            const plainInfo = stripHtml(rawInfo);
            const safeInfo = escapeHtml(rawInfo || '');
            const safeUrl = escapeHtml(toolData.url || '#');
            const infoLabel = `Zusatzinformation zu ${safeName}`;

            div.innerHTML = `
                <div class="tool-icon"><i class="fas ${iconClass}"></i></div>
                <div class="flex-grow-1 tool-card-body">
                    <div class="d-flex tool-title-row">
                        <div class="fw-bold tool-title">${safeName}</div>
                        <div class="tool-badges">${statusBadges}</div>
                    </div>
                    <div class="small text-muted tool-category">${categoryList}</div>
                </div>
                <button type="button" class="tool-info-btn tool-info-icon" data-bs-toggle="tooltip" title="${safeInfo}" aria-label="${infoLabel}">
                    <i class="fas fa-info-circle"></i>
                </button>
                ${allowEdit ? '<button type="button" class="edit-custom-btn" title="Bearbeiten"><i class="fas fa-pen"></i></button>' : ''}
                <a href="${safeUrl}" target="_blank" class="tool-link" onclick="event.stopPropagation()" title="Tool öffnen" aria-label="Tool öffnen: ${safeName}">
                    <i class="fas fa-external-link-alt"></i>
                    <span class="d-none d-print-inline small text-decoration-underline text-primary">${safeUrl}</span>
                </a>
            `;

            const infoIcon = div.querySelector('.tool-info-icon');
            if(infoIcon) {
                infoIcon.setAttribute('data-bs-title', tooltipHtml);
                infoIcon.setAttribute('data-bs-html', 'true');
                infoIcon.setAttribute('title', plainInfo);
            }

            if(allowEdit) {
                const editBtn = div.querySelector('.edit-custom-btn');
                if(editBtn) {
                    editBtn.setAttribute('aria-label', 'Eigenes Tool bearbeiten');
                    editBtn.setAttribute('draggable', 'false');
                    editBtn.addEventListener('mousedown', (event) => event.stopPropagation());
                    editBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        openCustomToolEditor({ ...toolData, cats: categoriesForTool, uniqueId });
                    });
                }
            }
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'tool-remove-btn';
        removeBtn.setAttribute('aria-label', 'Tool entfernen');
        removeBtn.title = 'Tool entfernen';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.setAttribute('draggable', 'false');
        removeBtn.addEventListener('mousedown', (event) => event.stopPropagation());
        removeBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            handleCardRemoval(div);
        });
        div.appendChild(removeBtn);

        setTimeout(() => applyCollapsibleTitle(div), 0);

        setTimeout(() => initTooltips(), 100);

        div.addEventListener('dragstart', (e) => {
            const transferData = { ...toolData, uniqueId: uniqueId, origin: origin };
            e.dataTransfer.setData("text/plain", JSON.stringify(transferData));
            e.dataTransfer.effectAllowed = origin === 'hangar' ? 'copy' : 'move';
        });

        return div;
    }

    function applyCollapsibleTitle(card) {
        if(!card) return;

        const titleEl = card.querySelector('.tool-title');
        if(!titleEl) return;

        const row = card.querySelector('.tool-title-row') || titleEl.parentElement;
        const toggleBtn = card.querySelector('.tool-title-toggle');

        const adjustToggle = () => {
            const computedLineHeight = parseFloat(getComputedStyle(titleEl).lineHeight) || 16;
            const maxHeight = computedLineHeight * 3;
            const isOverflowing = titleEl.scrollHeight > maxHeight + 1;

            titleEl.style.maxHeight = titleEl.classList.contains('expanded') ? 'none' : `${maxHeight}px`;

            if(isOverflowing) {
                if(!toggleBtn) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'tool-title-toggle';
                    btn.textContent = 'Mehr';
                    btn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const expanded = titleEl.classList.toggle('expanded');
                        titleEl.style.maxHeight = expanded ? 'none' : `${maxHeight}px`;
                        btn.textContent = expanded ? 'Weniger' : 'Mehr';
                    });
                    if(row) {
                        row.appendChild(btn);
                    }
                }
            } else {
                titleEl.classList.remove('expanded');
                titleEl.style.maxHeight = `${maxHeight}px`;
                if(toggleBtn) {
                    toggleBtn.remove();
                }
            }
        };

        requestAnimationFrame(adjustToggle);
    }

    function initTooltips() {
        document.querySelectorAll('.tooltip').forEach(t => t.remove());
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach((tooltipTriggerEl) => {
            let tooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);

            if(tooltip) {
                const tooltipContent = tooltipTriggerEl.getAttribute('data-bs-title')
                    || tooltipTriggerEl.getAttribute('title')
                    || '';
                tooltip.setContent({ '.tooltip-inner': tooltipContent });
            } else {
                tooltip = new bootstrap.Tooltip(tooltipTriggerEl, {
                    html: tooltipTriggerEl.getAttribute('data-bs-html') === 'true',
                    trigger: 'manual',
                    container: 'body'
                });
            }

            if(tooltipTriggerEl.dataset.tooltipBound === 'true') return;

            const showTooltip = () => {
                const instance = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                if(instance) instance.show();
            };
            const hideTooltip = () => {
                const instance = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                if(instance) instance.hide();
            };

            tooltipTriggerEl.addEventListener('focus', showTooltip);
            tooltipTriggerEl.addEventListener('blur', hideTooltip);
            tooltipTriggerEl.addEventListener('mouseenter', showTooltip);
            tooltipTriggerEl.addEventListener('mouseleave', hideTooltip);
            tooltipTriggerEl.addEventListener('keydown', (event) => {
                if(event.key === 'Escape') hideTooltip();
            });

            tooltipTriggerEl.dataset.tooltipBound = 'true';
        });
    }

    // === DRAG & DROP ===
    function allowDrop(e) { e.preventDefault(); }

    function dragEnter(e) {
        const target = e.target.closest('.phase-col');
        if(target) target.classList.add('drag-over');
    }

    function dragLeave(e) {
        const target = e.target.closest('.phase-col');
        if(target) target.classList.remove('drag-over');
    }

    function drop(e) {
        e.preventDefault();
        const target = e.target.closest('.phase-col');
        if(!target) return;

        target.classList.remove('drag-over');
        const rawData = e.dataTransfer.getData("text/plain");
        if(!rawData) return;

        const data = JSON.parse(rawData);

        if (data.origin === 'hangar') {
            const newTool = createToolElement({
                ...data,
                uniqueId: 'c-' + Date.now() + Math.random().toString(16).slice(2)
            }, 'cockpit');
            target.appendChild(newTool);

            if(data.isAi) {
                pendingAiElement = newTool;
                aiModal.show();
            } else {
                saveState();
            }
        } else {
            const existingEl = document.getElementById(data.uniqueId);
            if(existingEl) {
                target.appendChild(existingEl);
                saveState();
            }
        }
    }

    // === NOTIZEN ===
    function openTextModal(targetId) {
        targetPhaseForNote = targetId;
        if(!textModal) {
            const modalEl = document.getElementById('textNoteModal');
            if(modalEl) {
                textModal = new bootstrap.Modal(modalEl);
            }
        }
        if(textModal) {
            textModal.show();
        }
    }

    function addTextBlock() {
        if(!targetPhaseForNote) return;

        const target = document.getElementById(targetPhaseForNote);
        if(!target) return;

        const titleField = document.getElementById('noteTitle');
        const contentField = document.getElementById('noteContent');
        const title = titleField ? titleField.value.trim() : '';
        const content = contentField ? contentField.value.trim() : '';

        if(!content && !title) return;

        const noteId = 'note-' + Date.now() + Math.random().toString(16).slice(2);
        const noteData = {
            id: noteId,
            name: title || 'Notiz',
            info: content || 'Notiz',
            url: '#',
            cats: ['Notizen'],
            isAi: false,
            isLib: false,
            type: 'text',
            text: content,
            uniqueId: noteId
        };

        const card = createToolElement(noteData, 'cockpit');
        target.appendChild(card);
        saveState();

        if(textModal) {
            textModal.hide();
        }
    }

    // === CUSTOM TOOLS ===
    function saveCustomTools() {
        const customTools = initialTools.filter(tool => tool.isCustom);
        localStorage.setItem(CUSTOM_TOOLS_KEY, JSON.stringify(customTools));
    }

    function loadCustomTools() {
        const stored = localStorage.getItem(CUSTOM_TOOLS_KEY);
        if(!stored) return;
        try {
            const customTools = JSON.parse(stored) || [];
            customTools.forEach(tool => {
                const toolId = tool.id || ('cust' + Date.now() + Math.random().toString(16).slice(2));
                const exists = initialTools.some(existing => existing.id === toolId);
                if(!exists) {
                    initialTools.push({ ...tool, id: toolId, isCustom: true, cats: deriveCategoriesForTool(tool) });
                }
            });
        } catch (error) {
            console.error('Fehler beim Laden der benutzerdefinierten Tools', error);
        }
    }

    function resetCustomToolForm() {
        currentEditingCustomToolId = null;

        const titleEl = document.getElementById('customToolModalTitle');
        if(titleEl) {
            titleEl.textContent = 'Eigenes Tool ergänzen';
        }

        const submitBtn = document.getElementById('customToolSubmitBtn');
        if(submitBtn) {
            submitBtn.textContent = 'Hinzufügen';
        }

        const nameField = document.getElementById('customToolName');
        const infoField = document.getElementById('customToolInfo');
        const urlField = document.getElementById('customToolUrl');
        const catSelect = document.getElementById('customToolCategory');

        if(nameField) nameField.value = '';
        if(infoField) infoField.value = '';
        if(urlField) urlField.value = '';

        if(catSelect) {
            Array.from(catSelect.options).forEach(opt => opt.selected = false);
        }

        const aiCheckbox = document.getElementById('customToolIsAi');
        const libCheckbox = document.getElementById('customToolIsLib');
        if(aiCheckbox) aiCheckbox.checked = false;
        if(libCheckbox) libCheckbox.checked = false;
    }

    function openCustomToolEditor(toolData) {
        if(!toolData) return;

        currentEditingCustomToolId = toolData.id;

        const titleEl = document.getElementById('customToolModalTitle');
        if(titleEl) {
            titleEl.textContent = 'Eigenes Tool bearbeiten';
        }

        const submitBtn = document.getElementById('customToolSubmitBtn');
        if(submitBtn) {
            submitBtn.textContent = 'Speichern';
        }

        const normalizedCats = deriveCategoriesForTool(toolData);
        const nameField = document.getElementById('customToolName');
        const infoField = document.getElementById('customToolInfo');
        const urlField = document.getElementById('customToolUrl');
        const catSelect = document.getElementById('customToolCategory');
        const aiCheckbox = document.getElementById('customToolIsAi');
        const libCheckbox = document.getElementById('customToolIsLib');

        if(nameField) nameField.value = toolData.name || '';
        if(infoField) infoField.value = toolData.info || '';
        if(urlField) urlField.value = toolData.url || '';

        if(catSelect) {
            const normalized = normalizeCategoriesList(normalizedCats);
            Array.from(catSelect.options).forEach(opt => {
                opt.selected = normalized.includes(opt.value);
            });
        }

        if(aiCheckbox) aiCheckbox.checked = !!toolData.isAi;
        if(libCheckbox) libCheckbox.checked = !!toolData.isLib;

        const modalEl = document.getElementById('customToolModal');
        if(modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.show();
        }
    }

    function rerenderCustomToolInstances(updatedTool) {
        document.querySelectorAll(`.tool-card[data-base-id="${updatedTool.id}"]`).forEach(card => {
            const parent = card.parentElement;
            if(!parent) return;

            const origin = dropTargets.includes(parent.id) ? 'cockpit' : 'hangar';
            const updatedData = {
                ...updatedTool,
                cats: deriveCategoriesForTool(updatedTool),
                uniqueId: card.id,
                type: card.dataset.type || 'tool',
                text: card.dataset.text || ''
            };

            const refreshedCard = createToolElement(updatedData, origin);
            parent.replaceChild(refreshedCard, card);
        });
    }

    function addCustomTool() {
        const name = document.getElementById('customToolName').value;
        const info = document.getElementById('customToolInfo').value;
        const url = document.getElementById('customToolUrl').value;
        const catSelect = document.getElementById('customToolCategory');
        const cat = Array.from(catSelect.selectedOptions).map(opt => opt.value);
        const isAi = document.getElementById('customToolIsAi').checked;
        const isLib = document.getElementById('customToolIsLib').checked;

        if(!name) return;

        const baseCategories = cat && cat.length ? cat : ['Organize & Cite'];
        const normalizedCats = deriveCategoriesForTool({ cats: baseCategories, isLib });
        const isEditing = !!currentEditingCustomToolId;
        const toolId = isEditing ? currentEditingCustomToolId : ('cust' + Date.now());

        const newTool = {
            id: toolId,
            name: name,
            cats: normalizedCats,
            url: url || '#',
            info: info || 'Benutzerdefiniert',
            isAi: isAi,
            isLib: isLib,
            isCustom: true
        };

        if(isEditing) {
            const existingIndex = initialTools.findIndex(t => t.id === toolId);
            const mergedTool = existingIndex >= 0 ? { ...initialTools[existingIndex], ...newTool } : newTool;
            if(existingIndex >= 0) {
                initialTools[existingIndex] = mergedTool;
            } else {
                initialTools.push(mergedTool);
            }
            saveCustomTools();
            renderHangar();
            rerenderCustomToolInstances(mergedTool);
            saveState();
        } else {
            initialTools.push(newTool);
            saveCustomTools();
            renderHangar();
        }

        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('customToolModal'));
        if(modalInstance) {
            modalInstance.hide();
        }
        resetCustomToolForm();
    }

    // === STORAGE ===
    function saveState() {
        const state = {};
        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(!phase) return;
            const tools = [];
            phase.querySelectorAll('.tool-card').forEach(card => {
                const cats = card.dataset.cats ? card.dataset.cats.split('|').filter(Boolean) : [];
                tools.push({
                    id: card.dataset.baseId || card.id,
                    uniqueId: card.id,
                    name: card.dataset.name || (card.querySelector('.fw-bold') ? card.querySelector('.fw-bold').innerText : 'Tool'),
                    info: card.dataset.info || '',
                    url: card.dataset.url || '#',
                    cats: cats,
                    isAi: card.dataset.isAi === '1' || card.dataset.isAi === 'true',
                    isLib: card.dataset.isLib === '1' || card.dataset.isLib === 'true',
                    isOA: card.dataset.isOa === '1' || card.dataset.isOa === 'true',
                    isCustom: card.dataset.isCustom === '1' || card.dataset.isCustom === 'true',
                    type: card.dataset.type || 'tool',
                    text: card.dataset.text || ''
                });
            });
            state[targetId] = tools;
        });
        localStorage.setItem('cockpitState_v3', JSON.stringify(state));
    }

    function loadState() {
        const rawState = localStorage.getItem('cockpitState_v3') || localStorage.getItem('cockpitState_v2');
        if(!rawState) return;
        const state = JSON.parse(rawState);

        dropTargets.forEach(targetId => {
            const phase = document.getElementById(targetId);
            if(!phase) return;

            phase.innerHTML = '';
            const tools = state[targetId] || [];

            tools.forEach(savedItem => {
                const itemType = savedItem.type || 'tool';
                if(itemType === 'text') {
                    const restoredNote = {
                        id: savedItem.id || savedItem.uniqueId || 'restored-note',
                        name: savedItem.name || 'Notiz',
                        info: savedItem.info || savedItem.text || 'Notiz',
                        url: '#',
                        cats: normalizeCategoriesList((savedItem.cats && savedItem.cats.length) ? savedItem.cats : ['Notizen']),
                        type: 'text',
                        text: savedItem.text || '',
                        uniqueId: savedItem.uniqueId || ('note-' + Date.now() + Math.random().toString(16).slice(2))
                    };
                    phase.appendChild(createToolElement(restoredNote, 'cockpit'));
                    return;
                }

                let original = initialTools.find(it => it.id === savedItem.id) || initialTools.find(it => it.name === savedItem.name);

                if(!original) {
                    const fallbackCats = (savedItem.cats && savedItem.cats.length) ? savedItem.cats : ['Organize & Cite'];
                    original = {
                        id: savedItem.id || 'restored',
                        name: savedItem.name || 'Unbenannt',
                        cats: fallbackCats,
                        url: savedItem.url || '#',
                        info: savedItem.info || 'Wiederhergestellt',
                        isAi: !!savedItem.isAi,
                        isLib: !!savedItem.isLib,
                        isOA: !!savedItem.isOA
                    };
                }

                const mergedTool = { ...original, ...savedItem };
                const restoredTool = {
                    ...mergedTool,
                    cats: deriveCategoriesForTool(mergedTool),
                    uniqueId: savedItem.uniqueId,
                    isCustom: mergedTool.isCustom,
                    isAi: mergedTool.isAi,
                    isLib: mergedTool.isLib,
                    isOA: mergedTool.isOA
                };
                phase.appendChild(createToolElement(restoredTool, 'cockpit'));
            });
        });
    }

    // === PRINT ===
    function handlePrintClick() {
        showToast('PDF wird erstellt…', 'info', 5000);
        showToast('Im Druckdialog als PDF speichern.', 'info', 5000);
        setTimeout(() => {
            window.print();
            showToast('PDF wurde erstellt.', 'success', 4000);
        }, 120);
    }

    // === IMPORT/EXPORT & RESET ===
    function exportConfiguration() {
        let cockpitState = {};
        let storedCustomTools = [];

        try {
            cockpitState = JSON.parse(localStorage.getItem('cockpitState_v3')) || {};
        } catch (error) {
            console.error('Fehler beim Lesen des Cockpit-Status', error);
        }

        try {
            storedCustomTools = JSON.parse(localStorage.getItem(CUSTOM_TOOLS_KEY)) || [];
        } catch (error) {
            console.error('Fehler beim Lesen der Custom Tools', error);
        }

        const payload = {
            schemaVersion: EXPORT_SCHEMA_VERSION,
            cockpitState_v3: cockpitState,
            customTools: storedCustomTools
        };

        const jsonString = JSON.stringify(payload, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'cockpit-konfiguration.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast('JSON wurde heruntergeladen.', 'success');
    }

    function triggerImport() {
        const input = document.getElementById('importJsonInput');
        if(input) {
            input.value = '';
            input.click();
        }
    }

    function validateImportPayload(payload) {
        if(!payload || typeof payload !== 'object') return false;
        if(typeof payload.schemaVersion !== 'string') return false;
        if(payload.schemaVersion !== EXPORT_SCHEMA_VERSION) return false;
        if(!payload.cockpitState_v3 || typeof payload.cockpitState_v3 !== 'object' || Array.isArray(payload.cockpitState_v3)) return false;
        if(!Array.isArray(payload.customTools)) return false;
        if(payload.customTools.some(tool => !tool || typeof tool !== 'object')) return false;
        return true;
    }

    function applyImportedConfiguration(payload) {
        const sanitizedState = (payload && payload.cockpitState_v3 && typeof payload.cockpitState_v3 === 'object') ? payload.cockpitState_v3 : {};
        const sanitizedCustomTools = Array.isArray(payload.customTools) ? payload.customTools : [];

        localStorage.setItem('cockpitState_v3', JSON.stringify(sanitizedState));
        localStorage.setItem(CUSTOM_TOOLS_KEY, JSON.stringify(sanitizedCustomTools));
        localStorage.removeItem('cockpitState_v2');

        const baseTools = initialTools.filter(tool => !tool.isCustom);
        initialTools.splice(0, initialTools.length, ...baseTools);
        loadCustomTools();

        renderHangar();
        loadState();
    }

    function handleImportFile(event) {
        const input = event.target;
        if(!input || !input.files || !input.files.length) return;

        const file = input.files[0];
        if(!file || file.size === 0) {
            showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
            return;
        }

        if(file.size > MAX_IMPORT_FILE_SIZE_BYTES) {
            showToast('Import fehlgeschlagen: Die Datei ist zu groß (maximal 2 MB).', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = (loadEvent) => {
            const rawContent = (loadEvent && loadEvent.target && typeof loadEvent.target.result === 'string')
                ? loadEvent.target.result
                : '';

            if(!rawContent || !rawContent.trim()) {
                showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(rawContent);
                const isValid = validateImportPayload(parsed);

                if(!isValid) {
                    showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
                    return;
                }

                applyImportedConfiguration(parsed);
                showToast('Import erfolgreich.', 'success');
            } catch (error) {
                console.error('Import fehlgeschlagen', error);
                showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
            }
        };
        reader.onerror = () => {
            showToast('Import fehlgeschlagen: Datei hat nicht das erwartete Format.', 'error');
        };
        reader.readAsText(file);
    }

    function resetCockpit() {
        if(confirm('Wirklich alles löschen?')) {
            localStorage.removeItem('cockpitState_v2');
            localStorage.removeItem('cockpitState_v3');
            localStorage.removeItem('cockpitDeleted_v1');
            localStorage.removeItem(CUSTOM_TOOLS_KEY);
            location.reload();
        }
    }

    // === INITIALISIERUNG ===
    document.addEventListener('DOMContentLoaded', () => {
        toastContainer = document.getElementById('toast-container');
        loadCustomTools();
        renderHangar();
        populateCategoryOptions();
        populateFilterOptions();
        populateLicensedDbSelect();
        loadState();
        loadDeletedState();
        initTooltips();

        const savePdfButton = document.getElementById('savePdfButton');
        if(savePdfButton) {
            savePdfButton.addEventListener('click', handlePrintClick);
        }

        const searchInput = document.getElementById('toolSearchInput');
        if(searchInput) {
            searchInput.addEventListener('input', (e) => {
                currentSearchTerm = (e.target.value || '').trim().toLowerCase();
                if(!currentSearchTerm) {
                    setCategoryFilter('', { render: false });
                }
                renderHangar();
            });
        }

        const aiModalEl = document.getElementById('aiWarningModal');
        aiModal = new bootstrap.Modal(aiModalEl);

        const textModalEl = document.getElementById('textNoteModal');
        if(textModalEl) {
            textModal = new bootstrap.Modal(textModalEl);
            textModalEl.addEventListener('hidden.bs.modal', () => {
                targetPhaseForNote = null;
                const titleField = document.getElementById('noteTitle');
                const contentField = document.getElementById('noteContent');
                if(titleField) titleField.value = '';
                if(contentField) contentField.value = '';
            });
        }

        const customModalEl = document.getElementById('customToolModal');
        if(customModalEl) {
            customModalEl.addEventListener('hidden.bs.modal', () => resetCustomToolForm());
        }

        const orientationModalEl = document.getElementById('orientationModal');
        if(orientationModalEl) {
            orientationModal = new bootstrap.Modal(orientationModalEl, { backdrop: true, keyboard: true });

            orientationModalEl.addEventListener('show.bs.modal', () => {
                lastFocusedElement = document.activeElement;
            });

            orientationModalEl.addEventListener('shown.bs.modal', () => {
                if(orientationFocusTrapCleanup) orientationFocusTrapCleanup();
                orientationFocusTrapCleanup = trapFocusWithin(orientationModalEl);
            });

            orientationModalEl.addEventListener('hidden.bs.modal', () => {
                if(orientationFocusTrapCleanup) {
                    orientationFocusTrapCleanup();
                    orientationFocusTrapCleanup = null;
                }
                clearOrientationHighlights();
                if(lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                    lastFocusedElement.focus();
                }
            });

            orientationModalEl.querySelectorAll('[data-onboarding-step]').forEach(btn => {
                btn.addEventListener('click', () => applyOnboardingStep(btn.dataset.onboardingStep));
            });

            const resetHighlightsBtn = document.getElementById('resetOnboardingHighlights');
            if(resetHighlightsBtn) {
                resetHighlightsBtn.addEventListener('click', clearOrientationHighlights);
            }
        }

        document.getElementById('confirmAiUse').addEventListener('click', () => {
            if(pendingAiElement) {
                aiModal.hide();
                pendingAiElement = null;
                saveState();
            }
        });

        document.getElementById('cancelAiUse').addEventListener('click', () => {
            aiModal.hide();
        });

        aiModalEl.addEventListener('hidden.bs.modal', () => {
            if(pendingAiElement) {
                pendingAiElement.remove();
                pendingAiElement = null;
            }
        });

        const importInput = document.getElementById('importJsonInput');
        if(importInput) {
            importInput.addEventListener('change', handleImportFile);
        }

        window.addEventListener('resize', () => {
            document.querySelectorAll('.tool-card').forEach(card => applyCollapsibleTitle(card));
        });
    });
</script>

</body>
</html>
